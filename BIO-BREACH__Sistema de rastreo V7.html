<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-BREACH: THE LAST TRACE</title>
    <style>
        :root {
            --gold: #ffd700;
            --dark-red: #8b0000;
            --bg-dark: #07070a;
            --terminal-green: #00ff41;
            --victory: #00ff88;
            --hazard: #ff4400;
            --ribbon-male: #0088ff;
            --ribbon-female: #ff0077;
            --disabled: #444;
        }

        body {
            background-color: var(--bg-dark);
            margin: 0; padding: 10px;
            font-family: 'Consolas', monospace;
            color: #eee;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: contain;
        }

        /* --- PANTALLA DE CARGA --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader-bar-container {
            width: 80%; max-width: 400px; height: 4px;
            background: #222; margin-top: 20px;
            border: 1px solid var(--gold);
        }
        .loader-bar {
            height: 100%; width: 0%;
            background: var(--gold);
            transition: width 0.1s linear;
        }
        .loading-text {
            color: var(--gold); font-size: 1.2rem; letter-spacing: 3px;
            animation: blink 0.8s infinite;
        }

        #wallet-display {
            position: absolute; top: 20px; right: 20px;
            border-left: 3px solid var(--gold); padding: 5px 15px;
            background: rgba(255, 215, 0, 0.05);
            text-align: right;
        }
        .currency { color: var(--gold); font-size: 1.2rem; font-weight: bold; }

        #main-menu {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
            transition: opacity 0.5s ease;
        }

        .menu-title {
            font-size: 3.5rem; color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            margin-bottom: 50px; text-align: center; letter-spacing: 5px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .btn-play {
            background: var(--dark-red); color: white; border: 2px solid #ff4400;
            padding: 20px 60px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            transition: all 0.2s;
        }

        .btn-exit {
            background: #222; color: #888; border: 2px solid #444;
            padding: 10px 40px; font-size: 1rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.2s;
        }
        .btn-exit:hover { background: #333; color: white; border-color: #666; }

        /* --- CONFIGURACIÓN --- */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3500;
        }
        .mosaic-options { display: flex; gap: 15px; margin: 20px 0; }
        .mosaic-btn {
            background: #111; border: 1px solid #444; color: #888;
            padding: 15px 25px; cursor: pointer; font-family: 'Consolas', monospace;
        }
        .mosaic-btn.active { border-color: var(--gold); color: var(--gold); background: #221a00; }

        #tutorial-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 4000; padding: 20px;
        }

        .tutorial-box {
            max-width: 500px; border: 1px solid var(--gold);
            padding: 30px; background: #0a0a0a; text-align: center;
        }

        .step { margin-bottom: 20px; text-align: left; border-left: 2px solid var(--dark-red); padding-left: 15px; }
        .step b { color: var(--gold); display: block; margin-bottom: 5px; }

        #overlay, #abort-confirm {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000; text-align: center;
        }
        #overlay.active, #abort-confirm.active { display: flex; opacity: 1; }

        .machine-body {
            background: linear-gradient(145deg, #1a1a1a, #000);
            width: 100%; max-width: 900px; padding: 20px;
            border: 2px solid #333; border-radius: 12px; display: none;
            margin-bottom: 20px;
        }

        .blur-effect { filter: blur(15px) grayscale(1); transition: filter 0.4s; }

        /* --- BOARD GRID SYSTEM --- */
        .board-grid {
            display: grid; 
            gap: 8px; margin-bottom: 20px; 
            transition: all 0.3s;
        }

        /* CONFIGURACIÓN 5x5 (ESTÁNDAR - INTOCABLE) */
        .board-grid.mode-5 {
            grid-template-columns: repeat(5, 1fr);
            min-height: 500px;
            overflow: visible; 
        }
        .board-grid.mode-5 .suspect-card {
            height: 135px;
        }
        .board-grid.mode-5 .card-body {
            font-size: 0.4rem; 
            line-height: 1.3;
        }
        .board-grid.mode-5 .suspect-card.discarded {
            transform: scale(0.8); opacity: 0.1; 
            pointer-events: none; filter: grayscale(1);
        }

        /* CONFIGURACIÓN 3x3 (ZOOM MEDIO - RELLENO) */
        .board-grid.mode-3 {
            grid-template-columns: repeat(3, 1fr);
            height: 600px; 
            overflow-y: auto; 
            gap: 15px;
            padding-right: 5px;
        }
        .board-grid.mode-3::-webkit-scrollbar { width: 8px; background: #111; }
        .board-grid.mode-3::-webkit-scrollbar-thumb { background: var(--dark-red); border-radius: 4px; }
        
        .board-grid.mode-3 .suspect-card {
            height: 220px;
            font-size: 1.2em;
        }
        .board-grid.mode-3 .card-header { font-size: 1rem; margin-bottom: 8px; padding-top: 5px; }
        .board-grid.mode-3 .card-body { font-size: 0.7rem; line-height: 1.6; }
        .board-grid.mode-3 .suspect-card.discarded { display: none; }

        /* CONFIGURACIÓN 2x2 (ZOOM MÁXIMO - RELLENO) */
        .board-grid.mode-2 {
            grid-template-columns: repeat(2, 1fr);
            height: 600px; 
            overflow-y: auto; 
            gap: 20px;
            padding-right: 5px;
        }
        .board-grid.mode-2::-webkit-scrollbar { width: 10px; background: #111; }
        .board-grid.mode-2::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 4px; }

        .board-grid.mode-2 .suspect-card {
            height: 280px;
        }
        .board-grid.mode-2 .card-header { font-size: 1.4rem; margin-bottom: 12px; padding-top: 8px; }
        .board-grid.mode-2 .card-body { font-size: 0.85rem; line-height: 1.8; }
        .board-grid.mode-2 .suspect-card.discarded { display: none; }

        /* --- TARJETAS --- */
        .suspect-card {
            background: #111; border: 1px solid #444; border-radius: 4px;
            padding: 8px 4px 4px 4px; cursor: pointer;
            transition: all 0.3s ease; position: relative;
            box-sizing: border-box;
            overflow: hidden; 
        }
        .gender-ribbon { position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        .ribbon-male { background: var(--ribbon-male); }
        .ribbon-female { background: var(--ribbon-female); }

        .card-header { font-size: 0.65rem; font-weight: bold; color: var(--gold); border-bottom: 1px solid #333; margin-bottom: 4px; text-align: center; }
        .card-body { color: #aaa; }

        .terminal-zone { background: #000; border: 1px solid #222; padding: 15px; border-radius: 5px; }
        #queryInput { width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--terminal-green); color: #fff; padding: 5px; font-family: 'Consolas', monospace; outline: none; }
        .output { color: var(--terminal-green); font-size: 0.7rem; min-height: 60px; margin-top: 10px; line-height: 1.4; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--dark-red); color: white; border: 1px solid #ff4400; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-abort { background: #222; border-color: #444; margin-top: 15px; font-size: 0.8rem; }
        .btn-abort:hover { background: #440000; border-color: var(--hazard); }
        
        .btn-mini { 
            background: #222; color: var(--gold); border: 1px solid var(--gold); 
            padding: 2px 10px; font-size: 0.65rem; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s;
        }
        .btn-mini:hover { background: var(--gold); color: #000; }

        #case-info-bar { display: flex; justify-content: space-between; align-items: center; color: var(--gold); margin-bottom: 10px; font-size: 0.75rem; border-bottom: 1px solid #222; padding-bottom: 5px; }

        #preload-status {
            position: fixed; bottom: 10px; left: 10px;
            font-size: 0.6rem; color: #444;
        }

        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-text">RECALIBRANDO SISTEMA...</div>
        <div class="loader-bar-container">
            <div id="loader-progress" class="loader-bar"></div>
        </div>
    </div>

    <div id="main-menu">
        <div id="wallet-display">
            <div style="font-size: 0.6rem; color: #666;">SALDO NETO</div>
            <div class="currency"><span id="total-money">0</span> S/</div>
        </div>
        <h1 class="menu-title">BIO-BREACH<br><span style="font-size: 1.2rem; color: #555;">SISTEMA DE RASTREO</span></h1>
        <div class="menu-buttons">
            <button class="btn-play" onclick="showTutorial()">INICIAR OPERACIÓN</button>
            <button class="btn-exit" onclick="openSettings()">CONFIGURACIÓN</button>
            <button class="btn-exit" onclick="exitGame()">SALIR DEL SISTEMA</button>
        </div>
        <div id="preload-status">SISTEMA: EN LÍNEA</div>
    </div>

    <div id="settings-modal">
        <div class="tutorial-box">
            <h2 style="color: var(--gold);">CONFIGURACIÓN DE MOSAICO</h2>
            <p style="color:#aaa; font-size: 0.8rem;">Seleccione la densidad de visualización de objetivos.</p>
            
            <div class="mosaic-options">
                <button class="mosaic-btn" id="btn-mode-2" onclick="selectMosaic(2)">2x2</button>
                <button class="mosaic-btn" id="btn-mode-3" onclick="selectMosaic(3)">3x3</button>
                <button class="mosaic-btn active" id="btn-mode-5" onclick="selectMosaic(5)">5x5</button>
            </div>
            <p id="mosaic-desc" style="font-size: 0.7rem; color: var(--terminal-green); min-height: 20px;">ESTÁNDAR: Vista completa, sin deslizamiento.</p>

            <button class="btn-main" onclick="saveSettings()">CONFIRMAR</button>
        </div>
    </div>

    <div id="tutorial-screen">
        <div class="tutorial-box">
            <h2 style="color: var(--gold); margin-top: 0;">MANUAL DE CAMPO</h2>
            <div class="step">
                <b>1. FILTRADO BIOMÉTRICO</b>
                Pregunta por los datos que se te otorgan. Cada pregunta te permite descartar hasta un MÁXIMO de 3 sospechosos relacionados.
            </div>
            <div class="step">
                <b>2. REGLA DE COHERENCIA</b>
                Solo puedes descartar sospechosos que no cumplan con la respuesta de la última consulta.
            </div>
            <div class="step">
                <b>3. OBJETIVO ÚNICO</b>
                La misión termina cuando descubres al culpable. ¡No lo descartes por error!
            </div>
            <button class="btn-main" onclick="startGame()">ENTENDIDO</button>
        </div>
    </div>

    <div id="abort-confirm">
        <div class="tutorial-box">
            <h2 style="color: var(--hazard);">¿ESTÁS SEGURO?</h2>
            <p>Perderás el monto de <span id="penalty-amount" style="color:var(--gold)">0</span> S/ del contrato actual.</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn-main" style="background:var(--hazard)" onclick="confirmAbort()">ESTOY SEGURO</button>
                <button class="btn-main" style="background:#333" onclick="closeAbortModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="overlay-title"></h1>
        <p id="overlay-desc"></p>
        <p id="overlay-reward-msg"></p>
        <button class="btn-main" style="width: 250px;" onclick="initGame()">SIGUIENTE CASO</button>
    </div>

    <div class="machine-body" id="main-ui">
        <div id="case-info-bar">
            <span id="case-id-display">CASO #----</span>
            <button class="btn-mini" onclick="initGame()">NUEVO CASO</button>
            <span style="color: var(--victory)">RECOMPENSA: <span id="case-reward-display">0</span> S/</span>
        </div>
        <div class="board-grid mode-5" id="board"></div>
        
        <div class="terminal-zone">
            <div id="limit-indicator" style="font-size: 0.6rem; color: var(--gold); margin-bottom: 5px; opacity: 0.7;">DESCARTES DISPONIBLES: 0/3</div>
            <input type="text" id="queryInput" autocomplete="off" placeholder="INTERROGAR SISTEMA (Accesorio mano/cabeza/ojos, País, Inicial)...">
            <div class="output" id="out">> AGUARDANDO COMANDOS...</div>
        </div>
        <button class="btn-main btn-abort" onclick="openAbortModal()">ABORTAR CASO</button>
    </div>

    <script>
        const CACHE_NAME = 'bio-breach-audio-v1';
        let currentMosaicMode = 5; 
        let tempMosaicMode = 5; 

        // --- SISTEMA DE CONFIGURACIÓN ---
        function openSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'flex';
            selectMosaic(currentMosaicMode); 
        }

        function selectMosaic(mode) {
            playSFX('click');
            tempMosaicMode = mode;
            document.querySelectorAll('.mosaic-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-mode-${mode}`).classList.add('active');
            
            const desc = document.getElementById('mosaic-desc');
            if (mode === 5) desc.innerText = "ESTÁNDAR: Vista completa, sin deslizamiento.";
            else desc.innerText = "ZOOM TÁCTICO: Tarjetas ampliadas, deslizamiento activo.";
        }

        function saveSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'none';
            if (tempMosaicMode !== currentMosaicMode) {
                applyMosaicChange(tempMosaicMode);
            }
        }

        function applyMosaicChange(newMode) {
            const loading = document.getElementById('loading-screen');
            const bar = document.getElementById('loader-progress');
            
            loading.style.display = 'flex';
            bar.style.width = "0%";
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if(progress > 100) progress = 100;
                bar.style.width = progress + "%";
                
                if(progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        currentMosaicMode = newMode;
                        updateBoardClass();
                        loading.style.display = 'none';
                        if(gameActive) renderBoard(); 
                    }, 500);
                }
            }, 100);
        }

        function updateBoardClass() {
            const board = document.getElementById('board');
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);
        }
        
        async function preloadAssets() {
            const statusEl = document.getElementById('preload-status');
            if (!('caches' in window)) {
                statusEl.innerText = "SISTEMA: CACHÉ NO SOPORTADA";
                return;
            }

            try {
                const cache = await caches.open(CACHE_NAME);
                const urlsToCache = Object.values(AUDIO_CONFIG).map(cfg => cfg.src);
                
                for (const url of urlsToCache) {
                    const response = await cache.match(url);
                    if (!response) {
                        statusEl.innerText = "DESCARGANDO ACTIVOS...";
                        await cache.add(url);
                    }
                }
                statusEl.innerText = "SISTEMA: LISTO";
            } catch (e) {
                statusEl.innerText = "SISTEMA: ERROR DE CONEXIÓN";
            }
        }

        window.addEventListener('load', () => {
            preloadAssets();
            updateBoardClass(); 
        });

        const AUDIO_CONFIG = {
            paper: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 0.6 },
            fail: { src: 'https://assets.mixkit.co/active_storage/sfx/2805/2805-preview.mp3', vol: 0.4 }, 
            error: { src: 'https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3', vol: 0.5 }, 
            win: { src: 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3', vol: 0.5 },
            click: { src: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3', vol: 0.4 },
            type: { src: 'https://assets.mixkit.co/active_storage/sfx/2544/2544-preview.mp3', vol: 0.015 },
            newCase: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 1 },
            discard: { src: 'https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3', vol: 0.1 }
        };

        const SFX_CACHE = {};
        let activeSounds = [];

        Object.keys(AUDIO_CONFIG).forEach(key => {
            const audio = new Audio(AUDIO_CONFIG[key].src);
            audio.volume = AUDIO_CONFIG[key].vol;
            audio.crossOrigin = "anonymous";
            SFX_CACHE[key] = audio;
        });

        async function playSFX(key, interrupt = false) {
            if (!SFX_CACHE[key]) return;
            if (interrupt || key === 'error' || key === 'fail' || key === 'win') {
                activeSounds.forEach(s => { s.pause(); s.currentTime = 0; });
                activeSounds = [];
            }
            const sound = SFX_CACHE[key].cloneNode();
            sound.volume = AUDIO_CONFIG[key].vol;
            if (key === 'discard') { sound.currentTime = 0.05; }
            activeSounds.push(sound);
            sound.onended = () => { activeSounds = activeSounds.filter(s => s !== sound); };
            try { await sound.play(); } catch (e) {}
        }

        let personas = [], objetivo = null, gameActive = false;
        let currentReward = 0;
        let totalMoney = parseInt(localStorage.getItem('bioBreachMoney')) || 0;
        let consultaRealizada = false;
        let mensajeDesbloqueoMostrado = false;
        let isTyping = false;

        // NUEVAS VARIABLES DE CONTROL
        let descartesUsados = 0;
        let lastQueryType = null; // { category: 'eyes', value: 'AZULES', response: 'SÍ' }

        async function typeWriter(text, elementId, speed = 20) {
            if (isTyping) return;
            isTyping = true;
            const element = document.getElementById(elementId);
            element.innerHTML = "> ";
            let currentHTML = "> ";
            const parts = text.split(/(<[^>]*>)/g);
            for (const part of parts) {
                if (part.startsWith('<')) {
                    currentHTML += part;
                    element.innerHTML = currentHTML;
                } else {
                    for (const char of part) {
                        currentHTML += char;
                        element.innerHTML = currentHTML;
                        if (char !== " " && char !== "\n") playSFX('type');
                        await new Promise(resolve => setTimeout(resolve, speed));
                    }
                }
            }
            isTyping = false;
        }

        function updateWalletUI() {
            document.getElementById('total-money').innerText = totalMoney.toLocaleString();
            localStorage.setItem('bioBreachMoney', totalMoney);
        }

        function showTutorial() {
            playSFX('click');
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('tutorial-screen').style.display = 'flex';
        }

        function exitGame() {
            playSFX('click');
            if (window.parent && typeof window.parent.cerrarMotor === 'function') {
                window.parent.cerrarMotor();
            } else {
                alert("SISTEMA DESCONECTADO DEL NÚCLEO.");
            }
        }

        function startGame() {
            playSFX('click');
            document.getElementById('tutorial-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            initGame();
        }

        function openAbortModal() {
            if (!gameActive) return;
            playSFX('click');
            document.getElementById('penalty-amount').innerText = currentReward;
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('abort-confirm').classList.add('active');
        }

        function closeAbortModal() {
            playSFX('click');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('abort-confirm').classList.remove('active');
        }

        function confirmAbort() {
            playSFX('click', true); 
            gameActive = false;
            closeAbortModal();
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function initGame() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('out').style.color = "var(--terminal-green)";
            playSFX('newCase', true);
            currentReward = Math.floor(Math.random() * 500) + 100;
            document.getElementById('case-id-display').innerText = `CASO #${Math.floor(Math.random() * 9000) + 1000}`;
            document.getElementById('case-reward-display').innerText = currentReward;
            generateNewSquad();
            objetivo = personas[Math.floor(Math.random() * personas.length)];
            gameActive = true;
            consultaRealizada = false;
            mensajeDesbloqueoMostrado = false;
            descartesUsados = 0;
            lastQueryType = null;
            updateLimitUI();
            document.getElementById('queryInput').disabled = false;
            typeWriter("ESCANEO FINALIZADO. REALICE UNA CONSULTA PARA HABILITAR DESCARTES.", "out", 15);
            renderBoard();
            updateWalletUI();
        }

        function updateLimitUI() {
            const indicator = document.getElementById('limit-indicator');
            indicator.innerText = `DESCARTES DISPONIBLES: ${descartesUsados}/3`;
            indicator.style.color = descartesUsados >= 3 ? "var(--hazard)" : "var(--gold)";
        }

        function generateNewSquad() {
            personas = [];
            const DP = {
                M: ["LEON", "MARC", "OTTO", "IVAN", "ERIC", "HUAN", "KURT", "NOAH", "AXEL", "SAUL", "IGOR", "LIAM", "ENZO", "HUGO", "OMAR", "LUC", "YURI", "RYAN", "FINN", "EZRA", "MILO", "IAN", "ALAN", "KAI", "BORIS", "OSCAR", "VICTOR", "FELIX", "DANTE", "BRUNO", "KALEB", "SILAS", "ARLO", "THEO", "REMY", "ZAYN", "LUCA", "NICO", "JUDE", "ELIAS", "SETH", "KANE", "AARON", "SIMON", "RAUL", "LEVI", "TOBIAS", "GAGE", "XANDER", "JACE", "KAREM", "NASH", "ZION", "COLE", "BEAU", "REID", "KNOX", "RHYS", "OTIS", "MILO", "ARLO", "EZRA", "HUGO", "FELIX", "JUDE", "LUCA", "THEO", "SILAS", "KAI", "ENZO", "AXEL", "NOAH", "OTTO", "IVAN", "YOSEF", "MALIK", "SAID", "OMAR", "AMIR", "ZAYD", "HAMZA", "TARIQ", "KHALIL", "IDRIS", "HASSAN", "RAYAN", "SAMI", "KARIM", "ADAM", "NOAH", "LIAM", "ERIC", "MARC", "LEON", "HUAN", "KURT", "IGOR", "LUC", "YURI", "RYAN", "ALAN", "BORIS", "OSCAR", "VICTOR", "DANTE", "BRUNO", "KALEB", "REMY", "ZAYN", "NICO", "ELIAS", "SETH", "KANE", "AARON", "SIMON", "RAUL", "LEVI", "TOBIAS", "GAGE", "XANDER", "JACE", "KAREN", "NASH", "ZION", "COLE", "BEAU", "REID", "KNOX", "RHYS", "OTIS", "ALEX", "BLAKE", "CALEB", "DYLAN", "ETHAN", "FLYNN", "GRANT", "HENRY", "ISAAC", "JACK", "KYLE", "LUKE", "MAX", "NATE", "OWEN", "PIKE", "QUINN", "RILEY", "SEAN", "TATE", "URIE", "VANCE", "WADE", "XAVI", "YORK", "ZANE", "ALDO", "BART", "CARL", "DIRK", "EMIL", "FRANZ", "GUST", "HANS", "IVAR", "JENS", "KARL", "LARS", "MADS", "NILS", "OLAF", "PIET", "ROLF", "STIG", "THOR", "ULF", "VERN", "WOLF", "YENS", "ZOLT", "ANTON", "BORIS", "CYRIL", "DIMITRI", "EVAN", "FEDOR", "GREG", "IVAN", "IGOR", "JAN", "KONRAD", "LEV", "MIKHAIL", "NIKOLAI", "OLEG", "PAVEL", "SERGEI", "VIKTOR", "YURI", "ZINO", "ANDRE", "BLAISE", "CLAUDE", "DIDIER", "ETIENNE", "FABIEN", "OSVALDO", "HENRI", "ISAAC", "JEAN", "LUC", "MARC", "NOEL", "OLIVER", "PIERRE", "REMY", "SERGE", "THIERRY", "URBAIN", "VICTOR", "YVES", "ZEPHYR"],
                F: ["MIA", "LARA", "YUNA", "OLGA", "ADRI", "ZOE", "INÉS", "KIRA", "EMMA", "RUTH", "SARA", "LUNA", "VERA", "NORA", "MAYA", "LEA", "IRIS", "ALBA", "GALA", "JUNE", "CLEO", "ANA", "EVA", "LISA", "NINA", "JADE", "ROSE", "MILA", "RUBY", "EDEN", "ISLA", "LYRA", "MAIA", "OPAL", "FAYE", "SKYE", "TESS", "WILLA", "ZARA", "ALEXA", "BELLA", "CHLOE", "DIANA", "ELSA", "FREYA", "HOPE", "IVY", "KYRA", "LANA", "MYRA", "AMARA", "BELLE", "CORA", "DAISY", "ELIZA", "FLORA", "GRETA", "HAZEL", "INDIE", "JUNE", "KEIRA", "LOLA", "MABEL", "NELL", "OLIVE", "PEARL", "QUINN", "RENA", "SADIE", "THEA", "UNA", "VADA", "WREN", "XENA", "YARA", "ZELDA", "ALMA", "BONNIE", "SOLANGE", "DORA", "EDNA", "FAITH", "GIA", "HOLLY", "IDA", "JOY", "KAY", "LILY", "MINA", "NELL", "ORA", "PIPA", "ROSA", "SHEA", "TARA", "UTAH", "VIDA", "WILD", "XIA", "YOLI", "ZOEY", "ANNA", "BETH", "CLARA", "DINA", "ELLA", "FAYE", "GWEN", "HEIDI", "IRIS", "JANE", "KATE", "LUCY", "MARY", "NELL", "OLGA", "POLY", "RUTH", "SARA", "TESS", "UMA", "VIV", "WYN", "XIA", "YARA", "ZITA", "ADELE", "BINA", "COCO", "DANA", "ENID", "FIFI", "GIGI", "HOPE", "INES", "JANA", "KIKI", "LULU", "MIMI", "NANA", "ORLY", "PEPE", "QUEE", "RIRI", "SISI", "TITI", "UVEE", "VIVI", "ISABEL", "XIXI", "YAYA", "ZIZI", "ALICE", "BIANCA", "CELIA", "DORIS", "ELENA", "FIONA", "GRACE", "HELEN", "IRENE", "JULIA", "KAREN", "LINDA", "MARIA", "NAOMI", "PAULA", "ROSE", "SONIA", "TANIA", "URSULA", "VAL", "WANDA", "XENIA", "YVON", "ZARA", "AUREA", "BRISA", "CIELO", "DALIA", "ESTER", "FLOR", "GEMMA", "HILDA", "IRMA", "JUANA", "KATIA", "LIDIA", "MARTA", "NURIA", "OLIVIA", "PILAR", "RAQUEL", "SILVIA", "TERE", "VICKY", "XEMA", "YIZA", "ZENIA", "AGATHA"],
                P: [{n: "ALEMANIA", c: "EUROPA"}, {n: "ESPAÑA", c: "EUROPA"}, {n: "ITALIA", c: "EUROPA"}, {n: "FRANCIA", c: "EUROPA"}, {n: "SUIZA", c: "EUROPA"}, {n: "RUSIA", c: "EUROPA"}, {n: "JAPÓN", c: "ASIA"}, {n: "CHINA", c: "ASIA"}, {n: "COREA", c: "ASIA"}, {n: "INDIA", c: "ASIA"}, {n: "TAILANDIA", c: "ASIA"}, {n: "VIETNAM", c: "ASIA"}, {n: "MÉXICO", c: "AMÉRICA"}, {n: "BRASIL", c: "AMÉRICA"}, {n: "USA", c: "AMÉRICA"}, {n: "BOLIVIA", c: "AMÉRICA"}, {n: "COLOMBIA", c: "AMÉRICA"}, {n: "ECUADOR", c: "AMÉRICA"}, {n: "PERÚ", c: "AMÉRICA"}, {n: "ARGENTINA", c: "AMÉRICA"}, {n: "CANADÁ", c: "AMÉRICA"}, {n: "AUSTRALIA", c: "OCEANÍA"}, {n: "NUEVA ZELANDA", c: "OCEANÍA"}, {n: "EGIPTO", c: "ÁFRICA"}, {n: "SUDAFRICA", c: "ÁFRICA"}, {n: "NIGERIA", c: "ÁFRICA"}, {n: "MARRUECOS", c: "ÁFRICA"}],
                T: ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"],
                O: ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"],
                A: [{n: "GORRA", u: "CABEZA"}, {n: "CASCO", u: "CABEZA"}, {n: "SOMBRERO", u: "CABEZA"}, {n: "DIADEMA", u: "CABEZA"}, {n: "BOINA", u: "CABEZA"}, {n: "PASAMONTAÑAS", u: "CABEZA"}, {n: "GAFAS", u: "OJOS"}, {n: "MONÓCULO", u: "OJOS"}, {n: "VISOR", u: "OJOS"}, {n: "PARCHE", u: "OJOS"}, {n: "LENTES SOL", u: "OJOS"}, {n: "MALETÍN", u: "MANO"}, {n: "TABLETA", u: "MANO"}, {n: "RELOJ", u: "MANO"}, {n: "ANILLO", u: "MANO"}, {n: "GUANTE", u: "MANO"}, {n: "CELULAR", u: "MANO"}, {n: "BASTÓN", u: "MANO"}]
            };

            const shuffle = (array) => array.sort(() => Math.random() - 0.5);
            const poolM = shuffle([...new Set(DP.M)]);
            const poolF = shuffle([...new Set(DP.F)]);

            for (let i = 0; i < 25; i++) {
                const genero = Math.random() > 0.5 ? "MASCULINO" : "FEMENINO";
                const pais = DP.P[Math.floor(Math.random() * DP.P.length)];
                const acc = DP.A[Math.floor(Math.random() * DP.A.length)];
                let nombre = genero === "MASCULINO" ? (poolM.pop() || "UNIT-M" + i) : (poolF.pop() || "UNIT-F" + i);

                personas.push({
                    n: nombre, g: genero, p: pais.n, cont: pais.c,
                    t: DP.T[Math.floor(Math.random() * DP.T.length)], o: DP.O[Math.floor(Math.random() * DP.O.length)],
                    edad: Math.floor(Math.random() * 50) + 18, altura: (Math.random() * 0.5 + 1.5).toFixed(2),
                    accName: acc.n, accUbi: acc.u
                });
            }
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);

            personas.forEach(p => {
                const card = document.createElement('div');
                card.className = 'suspect-card';
                card.id = `card-${p.n}`;
                card.onclick = () => { handleCardClick(p, card); };
                const rib = p.g === "MASCULINO" ? "ribbon-male" : "ribbon-female";
                card.innerHTML = `<div class="gender-ribbon ${rib}"></div><div class="card-header">${p.n}</div><div class="card-body"><b>ORG:</b> ${p.p}<br><b>TEZ:</b> ${p.t}<br><b>OJO:</b> ${p.o}<br><b>EDA:</b> ${p.edad}<br><b>ALT:</b> ${p.altura}M<br><b>ACC:</b> ${p.accName}</div>`;
                board.appendChild(card);
            });
        }

        function handleCardClick(p, card) {
            if(!gameActive) return;
            
            // 1. Validar si hay consulta
            if(!consultaRealizada) {
                playSFX('error');
                document.getElementById('out').style.color = "var(--hazard)";
                typeWriter("ERROR: SISTEMA BLOQUEADO. REALICE UNA CONSULTA.", "out", 10);
                return;
            }

            // 2. Validar límite de descartes
            if(descartesUsados >= 3) {
                playSFX('error');
                document.getElementById('out').style.color = "var(--hazard)";
                typeWriter("LÍMITE DE DESCARTES ALCANZADO (3/3). REALICE NUEVA CONSULTA.", "out", 10);
                return;
            }

            // 3. Validar Coherencia de Descarte
            let esCoherente = false;
            const res = lastQueryType.response; // "SÍ" o "NO"
            
            switch(lastQueryType.category) {
                case 'acc_ubi': esCoherente = (res === "SÍ") ? (p.accUbi !== lastQueryType.value) : (p.accUbi === lastQueryType.value); break;
                case 'acc_name': esCoherente = (res === "SÍ") ? (p.accName !== lastQueryType.value) : (p.accName === lastQueryType.value); break;
                case 'continent': esCoherente = (res === "SÍ") ? (p.cont !== lastQueryType.value) : (p.cont === lastQueryType.value); break;
                case 'country': esCoherente = (res === "SÍ") ? (p.p !== lastQueryType.value) : (p.p === lastQueryType.value); break;
                case 'initial': esCoherente = (res === "SÍ") ? (!p.n.startsWith(lastQueryType.value)) : (p.n.startsWith(lastQueryType.value)); break;
                case 'gender': esCoherente = (res === "SÍ") ? (p.g !== lastQueryType.value) : (p.g === lastQueryType.value); break;
                case 'eyes': esCoherente = (res === "SÍ") ? (p.o !== lastQueryType.value) : (p.o === lastQueryType.value); break;
                case 'skin': esCoherente = (res === "SÍ") ? (p.t !== lastQueryType.value) : (p.t === lastQueryType.value); break;
                case 'age':
                case 'height':
                    const pVal = (lastQueryType.category === 'age') ? p.edad : parseFloat(p.altura);
                    const qVal = lastQueryType.value;
                    const op = lastQueryType.op;
                    let cumpleQuery = false;
                    if(op === '>') cumpleQuery = pVal > qVal;
                    else if(op === '<') cumpleQuery = pVal < qVal;
                    else cumpleQuery = Math.abs(pVal - qVal) < 0.05;
                    esCoherente = (res === "SÍ") ? !cumpleQuery : cumpleQuery;
                    break;
            }

            if(!esCoherente) {
                playSFX('error');
                document.getElementById('out').style.color = "var(--hazard)";
                typeWriter(`ERROR: DESCARTE INCOHERENTE. EL SUJETO NO CONTRADICE LA ÚLTIMA RESPUESTA (${res}).`, "out", 10);
                return;
            }

            // Proceder con descarte
            playSFX('discard');
            descartesUsados++;
            updateLimitUI();
            
            if (currentMosaicMode === 5) card.classList.toggle('discarded'); 
            else card.classList.add('discarded');
            
            checkStatus();
        }

        function checkStatus() {
            const active = Array.from(document.querySelectorAll('.suspect-card:not(.discarded)'));
            if (document.getElementById(`card-${objetivo.n}`).classList.contains('discarded')) return endGame(false);
            if (active.length === 1 && active[0].id === `card-${objetivo.n}`) endGame(true);
        }

        function endGame(win) {
            gameActive = false;
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('overlay').classList.add('active');
            const rewardMsg = document.getElementById('overlay-reward-msg');
            if (win) { 
                playSFX('win', true); 
                totalMoney += currentReward;
                document.getElementById('overlay-title').innerText = "OBJETIVO LOCALIZADO"; 
                document.getElementById('overlay-title').style.color = "var(--victory)";
                rewardMsg.innerText = `+${currentReward} S/ TRANSFERIDOS`;
            } else { 
                playSFX('fail', true);
                document.getElementById('overlay-title').innerText = "OBJETIVO PERDIDO"; 
                document.getElementById('overlay-title').style.color = "var(--hazard)";
                rewardMsg.innerText = "CONTRATO CANCELADO";
            }
            document.getElementById('overlay-desc').innerText = `IDENTIDAD: ${objetivo.n}`;
            updateWalletUI();
        }

        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isTyping) {
                const q = this.value.toUpperCase();
                this.value = '';
                let resp = "DATOS NO RECONOCIDOS.";
                let consultaValida = false;
                let newQueryData = null;

                // --- LÓGICA DE PREGUNTAS CON REGISTRO DE TIPO ---
                if (q.includes("ACCESORIO") || q.includes("OBJETO")) {
                    if (q.includes("CABEZA") || q.includes("PELO") || q.includes("GORRO")) {
                        resp = (objetivo.accUbi === "CABEZA") ? "SÍ." : "NO.";
                        newQueryData = { category: 'acc_ubi', value: 'CABEZA' };
                        consultaValida = true;
                    } else if (q.includes("OJOS") || q.includes("CARA") || q.includes("LENTES")) {
                        resp = (objetivo.accUbi === "OJOS") ? "SÍ." : "NO.";
                        newQueryData = { category: 'acc_ubi', value: 'OJOS' };
                        consultaValida = true;
                    } else if (q.includes("MANO") || q.includes("BRAZO") || q.includes("DEDO")) {
                        resp = (objetivo.accUbi === "MANO") ? "SÍ." : "NO.";
                        newQueryData = { category: 'acc_ubi', value: 'MANO' };
                        consultaValida = true;
                    } else {
                        const accList = ["GORRA", "CASCO", "SOMBRERO", "GAFAS", "MONÓCULO", "VISOR", "MALETÍN", "TABLETA", "RELOJ", "DIADEMA", "BOINA", "PASAMONTAÑAS", "PARCHE", "ANILLO", "GUANTE", "CELULAR", "BASTÓN"];
                        const accBuscado = accList.find(a => q.includes(a));
                        if(accBuscado) {
                            resp = (objetivo.accName === accBuscado) ? "SÍ." : "NO.";
                            newQueryData = { category: 'acc_name', value: accBuscado };
                            consultaValida = true;
                        }
                    }
                }
                else if (q.match(/\b(EUROPA|EUROPEO|EUROPEA)\b/)) { resp = (objetivo.cont === "EUROPA") ? "SÍ." : "NO."; newQueryData = { category: 'continent', value: 'EUROPA' }; consultaValida = true; }
                else if (q.match(/\b(ASIA|ASIÁTICO|ASIÁTICA)\b/)) { resp = (objetivo.cont === "ASIA") ? "SÍ." : "NO."; newQueryData = { category: 'continent', value: 'ASIA' }; consultaValida = true; }
                else if (q.match(/\b(AMÉRICA|AMERICANO|AMERICANA)\b/)) { resp = (objetivo.cont === "AMÉRICA") ? "SÍ." : "NO."; newQueryData = { category: 'continent', value: 'AMÉRICA' }; consultaValida = true; }
                else if (q.match(/\b(OCEANÍA|OCEÁNICO|OCEÁNICA|AUSTRALIANO|AUSTRALIANA)\b/)) { resp = (objetivo.cont === "OCEANÍA") ? "SÍ." : "NO."; newQueryData = { category: 'continent', value: 'OCEANÍA' }; consultaValida = true; }
                else if (q.match(/\b(ÁFRICA|AFRICANO|AFRICANA)\b/)) { resp = (objetivo.cont === "ÁFRICA") ? "SÍ." : "NO."; newQueryData = { category: 'continent', value: 'ÁFRICA' }; consultaValida = true; }
                else if (q.includes("INICIAL") || q.includes("EMPIEZA POR")) {
                    const letraMatch = q.match(/\b[A-Z]\b/);
                    if (letraMatch) { 
                        resp = (objetivo.n.startsWith(letraMatch[0])) ? "SÍ." : "NO."; 
                        newQueryData = { category: 'initial', value: letraMatch[0] };
                        consultaValida = true; 
                    }
                }
                else if (q.includes("EDAD") || q.includes("MIDE") || q.includes("ALTO") || q.includes("ESTATURA")) {
                    const numMatch = q.match(/\d+(\.\d+)?/);
                    if (numMatch) {
                        const valNum = parseFloat(numMatch[0]);
                        const isAge = q.includes("EDAD");
                        const targetVal = isAge ? objetivo.edad : parseFloat(objetivo.altura);
                        let op = '=';
                        if (q.includes("MAYOR") || q.includes("MÁS")) op = '>';
                        else if (q.includes("MENOR") || q.includes("MENOS")) op = '<';
                        
                        if(op === '>') resp = (targetVal > valNum) ? "SÍ." : "NO.";
                        else if(op === '<') resp = (targetVal < valNum) ? "SÍ." : "NO.";
                        else resp = (Math.abs(targetVal - valNum) < 0.05) ? "SÍ." : "NO.";
                        
                        newQueryData = { category: isAge ? 'age' : 'height', value: valNum, op: op };
                        consultaValida = true;
                    }
                }
                else if (q.match(/\b(HOMBRE|MASCULINO)\b/)) { resp = (objetivo.g === "MASCULINO") ? "SÍ." : "NO."; newQueryData = { category: 'gender', value: 'MASCULINO' }; consultaValida = true; }
                else if (q.match(/\b(MUJER|FEMENINO)\b/)) { resp = (objetivo.g === "FEMENINO") ? "SÍ." : "NO."; newQueryData = { category: 'gender', value: 'FEMENINO' }; consultaValida = true; }
                else if (["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"].some(c => q.includes(c))) {
                    const color = ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"].find(c => q.includes(c));
                    resp = (objetivo.o === color) ? "SÍ." : "NO.";
                    newQueryData = { category: 'eyes', value: color };
                    consultaValida = true;
                }
                else if (["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"].some(t => q.includes(t))) {
                    const tez = ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"].find(t => q.includes(t));
                    resp = (objetivo.t === tez) ? "SÍ." : "NO.";
                    newQueryData = { category: 'skin', value: tez };
                    consultaValida = true;
                }
                else {
                    const countries = ["ALEMANIA", "ESPAÑA", "ITALIA", "JAPÓN", "CHINA", "COREA", "MÉXICO", "BRASIL", "BOLIVIA", "COLOMBIA", "ECUADOR", "PERÚ", "ARGENTINA", "FRANCIA", "INDIA", "EGIPTO", "USA", "AUSTRALIA", "MARRUECOS", "SUIZA", "RUSIA", "TAILANDIA", "VIETNAM", "CANADÁ", "NUEVA ZELANDA", "SUDAFRICA", "NIGERIA"];
                    const foundP = countries.find(p => q.includes(p));
                    if(foundP) {
                        resp = (objetivo.p === foundP) ? "SÍ." : "NO.";
                        newQueryData = { category: 'country', value: foundP };
                        consultaValida = true;
                    }
                }

                if(consultaValida) {
                    playSFX('click');
                    document.getElementById('out').style.color = "var(--terminal-green)";
                    consultaRealizada = true;
                    descartesUsados = 0; 
                    lastQueryType = { ...newQueryData, response: resp.includes("SÍ") ? "SÍ" : "NO" };
                    updateLimitUI();
                    
                    let finalMsg = `CONSULTA: ${q}<br>RESPUESTA: ${resp}`;
                    if (!mensajeDesbloqueoMostrado) {
                        finalMsg += "<br><span style='color:var(--victory)'>SISTEMA HABILITADO: 3 DESCARTES DISPONIBLES.</span>";
                        mensajeDesbloqueoMostrado = true;
                    }
                    typeWriter(finalMsg, "out", 20);
                } else {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter(`CONSULTA: ${q}<br>RESPUESTA: DATOS NO RECONOCIDOS O CATEGORÍA INVÁLIDA.`, "out", 20);
                }
            }
        });

        updateWalletUI();
    </script>
</body>
</html>
