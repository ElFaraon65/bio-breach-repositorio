<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-BREACH: THE LAST TRACE</title>
    <style>
        :root {
            --gold: #ffd700;
            --dark-red: #8b0000;
            --bg-dark: #07070a;
            --terminal-green: #00ff41;
            --victory: #00ff88;
            --hazard: #ff4400;
            --ribbon-male: #0088ff;
            --ribbon-female: #ff0077;
            --disabled: #444;
            --cork-bg: #1a1510;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            margin: 0; padding: 10px;
            font-family: 'Consolas', monospace;
            color: #eee;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: contain;
        }

        /* --- PANTALLA DE CARGA --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader-bar-container {
            width: 80%; max-width: 400px; height: 4px;
            background: #222; margin-top: 20px;
            border: 1px solid var(--gold);
        }
        .loader-bar {
            height: 100%; width: 0%;
            background: var(--gold);
            transition: width 0.1s linear;
        }
        .loading-text {
            color: var(--gold); font-size: 1.2rem; letter-spacing: 3px;
            animation: blink 0.8s infinite;
        }

        #wallet-display {
            position: absolute; top: 20px; right: 20px;
            border-left: 3px solid var(--gold); padding: 5px 15px;
            background: rgba(255, 215, 0, 0.05);
            text-align: right;
        }
        .currency { color: var(--gold); font-size: 1.2rem; font-weight: bold; }

        #main-menu {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
            transition: opacity 0.5s ease;
        }

        .menu-title {
            font-size: 3.5rem; color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            margin-bottom: 50px; text-align: center; letter-spacing: 5px;
            line-height: 1.2;
            padding: 0 20px;
        }

        .menu-buttons {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 400px; padding: 0 20px;
        }

        .btn-play {
            background: var(--dark-red); color: white; border: 2px solid #ff4400;
            padding: 20px 60px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            transition: all 0.2s; width: 100%;
        }

        .btn-exit {
            background: #222; color: #888; border: 2px solid #444;
            padding: 10px 40px; font-size: 1rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.2s;
        }
        .btn-exit:hover { background: #333; color: white; border-color: #666; }

        /* --- CONFIGURACIÓN Y MODALES --- */
        #settings-modal, #tutorial-screen, #abort-confirm, #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 4000; padding: 20px;
        }
        
        #settings-modal { z-index: 3500; }
        #overlay, #abort-confirm { background: rgba(0, 0, 0, 0.95); z-index: 2000; text-align: center; }
        #overlay.active, #abort-confirm.active { display: flex; opacity: 1; }

        /* CORRECCIÓN: SCROLL INTERNO PARA EVITAR CORTES EN PANTALLAS PEQUEÑAS */
        .tutorial-box {
            width: 100%;
            max-width: 500px; 
            border: 1px solid var(--gold);
            padding: 25px; 
            background: #0a0a0a; 
            text-align: center;
            max-height: 85vh; /* Altura máxima relativa a la pantalla */
            overflow-y: auto; /* Habilita scroll si el contenido es muy largo */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        /* Personalización de scrollbar para modales */
        .tutorial-box::-webkit-scrollbar { width: 6px; }
        .tutorial-box::-webkit-scrollbar-thumb { background: var(--dark-red); }

        .mosaic-options { display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap; justify-content: center;}
        .mosaic-btn {
            background: #111; border: 1px solid #444; color: #888;
            padding: 15px 25px; cursor: pointer; font-family: 'Consolas', monospace;
        }
        .mosaic-btn.active { border-color: var(--gold); color: var(--gold); background: #221a00; }

        .step { margin-bottom: 20px; text-align: left; border-left: 2px solid var(--dark-red); padding-left: 15px; }
        .step b { color: var(--gold); display: block; margin-bottom: 5px; }

        /* --- MURO DE CRIMINALES (CORREGIDO) --- */
        #archives-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cork-bg);
            background-image: radial-gradient(#2a2018 1px, transparent 1px);
            background-size: 10px 10px;
            display: none; flex-direction: column;
            align-items: center;
            z-index: 3500;
            padding-top: 90px; /* Aumentado para que el header no tape contenido */
            overflow-y: auto;
        }

        .wall-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(10, 5, 0, 0.98);
            border-bottom: 2px solid var(--dark-red);
            padding: 15px; text-align: center;
            z-index: 3600; box-shadow: 0 5px 20px #000;
        }
        .wall-title-text {
            color: var(--gold); font-size: 1.5rem; letter-spacing: 4px; 
            text-transform: uppercase; font-weight: bold;
        }

        .wall-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;
            width: 100%; max-width: 1200px;
            padding: 20px; padding-bottom: 100px;
        }

        /* Tarjeta estilo Polaroid/Ficha Policial */
        .wall-card {
            width: 150px; min-height: 210px;
            background: #e0e0e0; color: #111;
            padding: 8px 8px 25px 8px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            position: relative;
            transform-origin: center top;
            transition: transform 0.2s, z-index 0.2s;
            cursor: default;
        }
        .wall-card:hover { transform: scale(1.2) rotate(0deg) !important; z-index: 999; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }

        .pin {
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--dark-red); border: 1px solid #300;
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            box-shadow: 1px 2px 4px rgba(0,0,0,0.5);
        }

        .mugshot-zone {
            width: 100%; height: 90px;
            background: #222; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #999;
        }
        .mugshot-icon { font-size: 2rem; color: #555; }
        
        .wall-info { font-family: 'Courier New', monospace; font-size: 0.55rem; line-height: 1.3; text-align: left; }
        .wall-info b { color: #000; font-weight: 800; }
        
        .stamp-solved {
            position: absolute; bottom: 10px; right: 5px;
            border: 2px solid var(--dark-red); color: var(--dark-red);
            font-size: 0.7rem; font-weight: bold; padding: 2px 4px;
            transform: rotate(-15deg); opacity: 0.7;
        }

        .btn-back-wall {
            position: fixed; bottom: 20px; 
            background: #000; border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 30px; cursor: pointer; z-index: 3600;
            font-weight: bold; text-transform: uppercase;
        }
        .btn-back-wall:hover { background: var(--gold); color: #000; }
        /* --- FIN MURO --- */

        /* --- DOSSIER DE MISIÓN --- */
        .dossier-container {
            border: 2px solid var(--victory);
            background: rgba(0, 50, 20, 0.3);
            padding: 20px; margin: 20px 0; text-align: left;
            width: 100%; max-width: 400px;
            font-family: 'Courier New', monospace;
        }
        .dossier-header {
            border-bottom: 1px dashed var(--victory); margin-bottom: 10px;
            padding-bottom: 5px; color: var(--victory);
            font-weight: bold; display: flex; justify-content: space-between;
        }
        .dossier-info p { margin: 5px 0; font-size: 0.85rem; color: #ddd; }
        .dossier-info b { color: var(--gold); }
        .stamp-captured {
            color: var(--victory); border: 2px solid var(--victory);
            padding: 5px 10px; font-weight: bold;
            transform: rotate(-5deg); display: inline-block;
            margin-top: 10px; font-size: 1.2rem;
        }

        /* --- INTERFAZ PRINCIPAL (RESPONSIVA) --- */
        .machine-body {
            background: linear-gradient(145deg, #1a1a1a, #000);
            width: 100%; max-width: 900px; padding: 20px;
            border: 2px solid #333; border-radius: 12px; display: none;
            margin-bottom: 0px; 
            flex-grow: 1; /* Ocupa el espacio disponible */
            display: flex; flex-direction: column;
            /* Evita overflow del body principal */
            max-height: calc(100vh - 20px); 
        }
        .machine-body[style*="display: none"] { display: none !important; } 
        .machine-body[style*="display: block"] { display: flex !important; }


        .blur-effect { filter: blur(15px) grayscale(1); transition: filter 0.4s; }

        /* --- BOARD GRID SYSTEM (CORREGIDO EL ESCALADO) --- */
        .board-grid {
            display: grid; gap: 8px; margin-bottom: 10px; 
            transition: all 0.3s; width: 100%;
            overflow-y: auto; /* Scroll interno en el tablero */
            flex-grow: 1; /* Empuja el input hacia abajo pero sin salirse */
        }
        
        /* Personalización de scrollbar para el tablero */
        .board-grid::-webkit-scrollbar { width: 8px; background: #111; }
        .board-grid::-webkit-scrollbar-thumb { background: var(--dark-red); border-radius: 4px; }

        /* CONFIGURACIÓN 5x5 */
        .board-grid.mode-5 {
            grid-template-columns: repeat(5, 1fr);
            min-height: 200px; /* Altura mínima segura */
        }
        .board-grid.mode-5 .suspect-card { height: auto; aspect-ratio: 3/4; }
        .board-grid.mode-5 .card-body { font-size: 0.4rem; line-height: 1.2; }
        .board-grid.mode-5 .suspect-card.discarded {
            transform: scale(0.8); opacity: 0.1; 
            pointer-events: none; filter: grayscale(1);
        }

        /* CONFIGURACIÓN 3x3 - Altura Flexible */
        .board-grid.mode-3 {
            grid-template-columns: repeat(3, 1fr);
            /* ELIMINADO height: 600px FIJO */
            gap: 10px; padding-right: 5px;
        }
        .board-grid.mode-3 .suspect-card { height: auto; min-height: 140px; }
        .board-grid.mode-3 .card-header { font-size: 0.9rem; margin-bottom: 6px; }
        .board-grid.mode-3 .card-body { font-size: 0.65rem; line-height: 1.4; }
        .board-grid.mode-3 .suspect-card.discarded { display: none; }

        /* CONFIGURACIÓN 2x2 - Altura Flexible */
        .board-grid.mode-2 {
            grid-template-columns: repeat(2, 1fr);
            /* ELIMINADO height: 600px FIJO */
            gap: 15px; padding-right: 5px;
        }
        .board-grid.mode-2 .suspect-card { height: auto; min-height: 180px; }
        .board-grid.mode-2 .card-header { font-size: 1.2rem; margin-bottom: 10px; }
        .board-grid.mode-2 .card-body { font-size: 0.8rem; line-height: 1.5; }
        .board-grid.mode-2 .suspect-card.discarded { display: none; }

        /* --- TARJETAS --- */
        .suspect-card {
            background: #111; border: 1px solid #444; border-radius: 4px;
            padding: 8px 4px 4px 4px; cursor: pointer;
            transition: all 0.3s ease; position: relative;
            box-sizing: border-box; overflow: hidden; width: 100%;
            display: flex; flex-direction: column;
        }
        .suspect-card.target-glow {
            border-color: var(--hazard);
            box-shadow: 0 0 10px var(--hazard);
        }

        .gender-ribbon { position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        .ribbon-male { background: var(--ribbon-male); }
        .ribbon-female { background: var(--ribbon-female); }

        .card-header { font-size: 0.65rem; font-weight: bold; color: var(--gold); border-bottom: 1px solid #333; margin-bottom: 4px; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex-shrink: 0;}
        .card-body { color: #aaa; word-wrap: break-word; flex-grow: 1;}

        .terminal-zone { background: #000; border: 1px solid #222; padding: 10px; border-radius: 5px; margin-top: auto; flex-shrink: 0; }
        
        #queryInput { 
            width: 100%; background: transparent; border: none; 
            border-bottom: 1px solid var(--terminal-green); 
            color: #fff; padding: 5px; font-family: 'Consolas', monospace; outline: none; font-size: 16px; /* Evita zoom en iOS */
        }
        #queryInput:disabled {
            border-bottom: 1px dashed #444; color: #444; cursor: not-allowed;
        }

        .output { color: var(--terminal-green); font-size: 0.7rem; min-height: 50px; margin-top: 5px; line-height: 1.3; }
        
        .btn-main { width: 100%; padding: 12px; background: var(--dark-red); color: white; border: 1px solid #ff4400; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-abort { background: #222; border-color: #444; margin-top: 10px; font-size: 0.8rem; padding: 10px; }
        .btn-abort:hover { background: #440000; border-color: var(--hazard); }
        
        .btn-mini { 
            background: #222; color: var(--gold); border: 1px solid var(--gold); 
            padding: 4px 10px; font-size: 0.7rem; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s;
        }
        .btn-mini:hover { background: var(--gold); color: #000; }

        #case-info-bar { display: flex; justify-content: space-between; align-items: center; color: var(--gold); margin-bottom: 10px; font-size: 0.75rem; border-bottom: 1px solid #222; padding-bottom: 5px; flex-shrink: 0; }

        #preload-status {
            position: fixed; bottom: 10px; left: 10px;
            font-size: 0.6rem; color: #444;
        }

        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* RESPONSIVIDAD MEJORADA */
        @media (max-height: 600px) {
             /* Ajustes para pantallas apaisadas o muy cortas */
             .menu-title { font-size: 2rem; margin-bottom: 20px; }
             .machine-body { padding: 10px; border: none; }
             #wallet-display { top: 5px; right: 5px; }
        }

        @media (max-width: 768px) {
            body { padding: 0; }
            .machine-body { padding: 10px; max-width: 100%; border-radius: 0; border: none; height: 100vh; max-height: 100vh; }
            .menu-title { font-size: 2.5rem; }
            .btn-play { padding: 15px 30px; font-size: 1.2rem; }
            
            .board-grid.mode-5 { gap: 4px; }
            .board-grid.mode-5 .suspect-card { padding: 2px; }
            .board-grid.mode-5 .card-body { font-size: 0.35rem; }
        }

        @media (max-width: 480px) {
            .menu-title { font-size: 1.8rem; letter-spacing: 2px; }
            #wallet-display { top: 10px; right: 10px; padding: 2px 8px; }
            .currency { font-size: 1rem; }
            
            .board-grid.mode-5 { gap: 3px; }
            /* Ajuste para que quepan bien */
            .board-grid.mode-5 .card-header { font-size: 0.5rem; margin-bottom: 2px; padding-top: 2px; }
            .board-grid.mode-5 .card-body { font-size: 0.3rem; line-height: 1.1; letter-spacing: -0.2px; }
            
            .board-grid.mode-3 { gap: 6px; }
            .board-grid.mode-3 .suspect-card { min-height: 120px; }
            .board-grid.mode-3 .card-body { font-size: 0.55rem; }
            
            .board-grid.mode-2 { gap: 8px; }
            .board-grid.mode-2 .suspect-card { min-height: 150px; }
            .board-grid.mode-2 .card-body { font-size: 0.7rem; }
            
            .terminal-zone { padding: 8px; }
            #queryInput { font-size: 0.9rem; }
            .btn-main { padding: 10px; font-size: 0.9rem; }
            #case-info-bar { flex-direction: row; gap: 5px; font-size: 0.65rem; }
            /* Se ha corregido la superposición de botones mini */
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loading-text">RECALIBRANDO SISTEMA...</div>
        <div class="loader-bar-container">
            <div id="loader-progress" class="loader-bar"></div>
        </div>
    </div>

    <div id="archives-screen">
        <div class="wall-header">
            <div class="wall-title-text">CRIMINALES ATRAPADOS</div>
            <div style="font-size: 0.7rem; color: #888;">REGISTRO DE OPERACIONES EXITOSAS</div>
        </div>
        <div id="wall-container" class="wall-grid">
            </div>
        <button class="btn-back-wall" onclick="closeArchives()">VOLVER AL MENÚ</button>
    </div>

    <div id="main-menu">
        <div id="wallet-display">
            <div style="font-size: 0.6rem; color: #666;">SALDO NETO</div>
            <div class="currency"><span id="total-money">0</span> S/</div>
        </div>
        <h1 class="menu-title">BIO-BREACH<br><span style="font-size: 1.2rem; color: #555;">SISTEMA DE RASTREO</span></h1>
        <div class="menu-buttons">
            <button class="btn-play" onclick="showTutorial()">INICIAR OPERACIÓN</button>
            <button class="btn-exit" onclick="openArchives()">ARCHIVOS (MURO)</button>
            <button class="btn-exit" onclick="openSettings()">CONFIGURACIÓN</button>
            <button class="btn-exit" onclick="exitGame()">SALIR DEL SISTEMA</button>
        </div>
        <div id="preload-status">SISTEMA: EN LÍNEA</div>
    </div>

    <div id="settings-modal">
        <div class="tutorial-box">
            <h2 style="color: var(--gold);">CONFIGURACIÓN DE MOSAICO</h2>
            <p style="color:#aaa; font-size: 0.8rem;">Seleccione la densidad de visualización de objetivos.</p>
            
            <div class="mosaic-options">
                <button class="mosaic-btn" id="btn-mode-2" onclick="selectMosaic(2)">2x2</button>
                <button class="mosaic-btn" id="btn-mode-3" onclick="selectMosaic(3)">3x3</button>
                <button class="mosaic-btn active" id="btn-mode-5" onclick="selectMosaic(5)">5x5</button>
            </div>
            <p id="mosaic-desc" style="font-size: 0.7rem; color: var(--terminal-green); min-height: 20px;">ESTÁNDAR: Vista completa, sin deslizamiento.</p>

            <button class="btn-main" onclick="saveSettings()">CONFIRMAR</button>
        </div>
    </div>

    <div id="tutorial-screen">
        <div class="tutorial-box">
            <h2 style="color: var(--gold); margin-top: 0;">MANUAL DE CAMPO</h2>
            <div class="step">
                <b>1. INTERROGATORIO PRECISO</b>
                Formule las preguntas correctamente usando signos (¿...?). Ejemplo: "¿Es de España?". No escriba palabras sueltas al final.
            </div>
            <div class="step">
                <b>2. DESCARTE OBLIGATORIO</b>
                El sistema bloqueará nuevos comandos hasta que elimines a TODOS los sospechosos que creas incorrectos. <b>¡CUIDADO!</b> Si eliminas al sospechoso equivocado, no habrá aviso.
            </div>
            <div class="step">
                <b>3. OBJETIVO ÚNICO</b>
                La misión termina cuando descubres al culpable. Si lo descartas por error, pierdes el contrato inmediatamente.
            </div>
            <button class="btn-main" onclick="startGame()">ENTENDIDO</button>
        </div>
    </div>

    <div id="abort-confirm">
        <div class="tutorial-box">
            <h2 style="color: var(--hazard);">¿ESTÁS SEGURO?</h2>
            <p>Perderás el monto de <span id="penalty-amount" style="color:var(--gold)">0</span> S/ del contrato actual.</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-main" style="background:var(--hazard); width: auto;" onclick="confirmAbort()">ESTOY SEGURO</button>
                <button class="btn-main" style="background:#333; width: auto;" onclick="closeAbortModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="overlay-title"></h1>
        <div id="overlay-desc" style="width: 100%; display: flex; justify-content: center;"></div>
        <p id="overlay-reward-msg"></p>
        <button class="btn-main" style="width: 250px;" onclick="initGame()">SIGUIENTE CASO</button>
    </div>

    <div class="machine-body" id="main-ui">
        <div id="case-info-bar">
            <span id="case-id-display">CASO #----</span>
            <button class="btn-mini" onclick="initGame()">NUEVO CASO</button>
            <span style="color: var(--victory)">RECOMPENSA: <span id="case-reward-display">0</span> S/</span>
        </div>
        <div class="board-grid mode-5" id="board"></div>
        
        <div class="terminal-zone">
            <input type="text" id="queryInput" autocomplete="off" placeholder="INTERROGAR SISTEMA (¿...?)...">
            <div class="output" id="out">> AGUARDANDO COMANDOS...</div>
        </div>
        <button class="btn-main btn-abort" onclick="openAbortModal()">ABORTAR CASO</button>
    </div>

    <script>
        const CACHE_NAME = 'bio-breach-audio-v1';
        let currentMosaicMode = 5; 
        let tempMosaicMode = 5; 
        
        let DP = {}; 

        // --- MANEJO DE ARCHIVOS Y MURO ---
        function openArchives() {
            playSFX('click');
            renderWall();
            document.getElementById('archives-screen').style.display = 'flex';
            document.getElementById('main-menu').style.display = 'none';
        }

        function closeArchives() {
            playSFX('click');
            document.getElementById('archives-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function renderWall() {
            const container = document.getElementById('wall-container');
            const solvedList = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
            container.innerHTML = '';

            if (solvedList.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:1.2rem; margin-top:50px;">NO HAY REGISTROS. ATRAPE CRIMINALES PRIMERO.</div>';
                return;
            }

            solvedList.forEach(data => {
                const rotation = (Math.random() * 10) - 5; // Rotación aleatoria entre -5 y 5 grados
                const card = document.createElement('div');
                card.className = 'wall-card';
                card.style.transform = `rotate(${rotation}deg)`;
                
                card.innerHTML = `
                    <div class="pin"></div>
                    <div class="mugshot-zone"><span class="mugshot-icon">?</span></div>
                    <div class="wall-info">
                        <b>EXP:</b> ${data.recordId}<br>
                        <b>NOM:</b> ${data.n}<br>
                        <b>ORI:</b> ${data.p}<br>
                        <b>RAS:</b> ${data.t} / ${data.o}<br>
                        <b>ACC:</b> ${data.accName}
                    </div>
                    <div class="stamp-solved">CAPTURADO</div>
                `;
                container.appendChild(card);
            });
        }
        // --- FIN ARCHIVOS ---

        function openSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'flex';
            selectMosaic(currentMosaicMode); 
        }

        function selectMosaic(mode) {
            playSFX('click');
            tempMosaicMode = mode;
            document.querySelectorAll('.mosaic-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-mode-${mode}`).classList.add('active');
            
            const desc = document.getElementById('mosaic-desc');
            if (mode === 5) desc.innerText = "ESTÁNDAR: Vista completa, sin deslizamiento.";
            else desc.innerText = "ZOOM TÁCTICO: Tarjetas ampliadas, deslizamiento activo.";
        }

        function saveSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'none';
            if (tempMosaicMode !== currentMosaicMode) {
                applyMosaicChange(tempMosaicMode);
            }
        }

        function applyMosaicChange(newMode) {
            const loading = document.getElementById('loading-screen');
            const bar = document.getElementById('loader-progress');
            
            loading.style.display = 'flex';
            bar.style.width = "0%";
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if(progress > 100) progress = 100;
                bar.style.width = progress + "%";
                
                if(progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        currentMosaicMode = newMode;
                        updateBoardClass();
                        loading.style.display = 'none';
                        if(gameActive) renderBoard(); 
                    }, 500);
                }
            }, 100);
        }

        function updateBoardClass() {
            const board = document.getElementById('board');
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);
        }

        
        async function preloadAssets() {
            const statusEl = document.getElementById('preload-status');
            if (!('caches' in window)) {
                statusEl.innerText = "SISTEMA: CACHÉ NO SOPORTADA";
                return;
            }

            try {
                const cache = await caches.open(CACHE_NAME);
                const urlsToCache = Object.values(AUDIO_CONFIG).map(cfg => cfg.src);
                
                for (const url of urlsToCache) {
                    const response = await cache.match(url);
                    if (!response) {
                        statusEl.innerText = "DESCARGANDO ACTIVOS...";
                        await cache.add(url);
                    }
                }
                statusEl.innerText = "SISTEMA: LISTO";
            } catch (e) {
                statusEl.innerText = "SISTEMA: ERROR DE CONEXIÓN";
            }
        }

        window.addEventListener('load', () => {
            preloadAssets();
            updateBoardClass();
        });

        const AUDIO_CONFIG = {
            paper: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 0.6 },
            fail: { src: 'https://assets.mixkit.co/active_storage/sfx/2805/2805-preview.mp3', vol: 0.4 }, 
            error: { src: 'https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3', vol: 0.5 }, 
            win: { src: 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3', vol: 0.5 },
            click: { src: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3', vol: 0.4 },
            type: { src: 'https://assets.mixkit.co/active_storage/sfx/2544/2544-preview.mp3', vol: 0.015 },
            newCase: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 1 },
            discard: { src: 'https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3', vol: 0.1 }
        };

        const SFX_CACHE = {};
        let activeSounds = [];

        Object.keys(AUDIO_CONFIG).forEach(key => {
            const audio = new Audio(AUDIO_CONFIG[key].src);
            audio.volume = AUDIO_CONFIG[key].vol;
            audio.crossOrigin = "anonymous";
            SFX_CACHE[key] = audio;
        });

        async function playSFX(key, interrupt = false) {
            if (!SFX_CACHE[key]) return;
            
            if (interrupt || key === 'error' || key === 'fail' || key === 'win') {
                activeSounds.forEach(s => {
                    s.pause();
                    s.currentTime = 0;
                });
                activeSounds = [];
            }

            const sound = SFX_CACHE[key].cloneNode();
            sound.volume = AUDIO_CONFIG[key].vol;
            
            if (key === 'discard') { sound.currentTime = 0.05; }
            activeSounds.push(sound);
            sound.onended = () => {
                activeSounds = activeSounds.filter(s => s !== sound);
            };

            try {
                await sound.play();
            } catch (e) {
                console.log("Audio trigger");
            }
        }

        let personas = [], objetivo = null, gameActive = false;
        let currentReward = 0;
        let totalMoney = parseInt(localStorage.getItem('bioBreachMoney')) || 0;
        let isTyping = false;
        
        let pendingDiscards = []; 
        let lastQueryText = "";   

        async function typeWriter(text, elementId, speed = 20) {
            if (isTyping) return;
            isTyping = true;
            const element = document.getElementById(elementId);
            element.innerHTML = "> ";
            let currentHTML = "> ";
            const parts = text.split(/(<[^>]*>)/g);
            for (const part of parts) {
                if (part.startsWith('<')) {
                    currentHTML += part;
                    element.innerHTML = currentHTML;
                } else {
                    for (const char of part) {
                        currentHTML += char;
                        element.innerHTML = currentHTML;
                        if (char !== " " && char !== "\n") playSFX('type');
                        await new Promise(resolve => setTimeout(resolve, speed));
                    }
                }
            }
            isTyping = false;
        }

        function updateWalletUI() {
            document.getElementById('total-money').innerText = totalMoney.toLocaleString();
            localStorage.setItem('bioBreachMoney', totalMoney);
        }

        function showTutorial() {
            playSFX('click');
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('tutorial-screen').style.display = 'flex';
        }

        function exitGame() {
            playSFX('click');
            if (window.parent && typeof window.parent.cerrarMotor === 'function') {
                window.parent.cerrarMotor();
            } else {
                alert("SISTEMA DESCONECTADO DEL NÚCLEO.");
            }
        }

        function startGame() {
            playSFX('click');
            document.getElementById('tutorial-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex'; /* Flex para la estructura */
            initGame();
        }

        function openAbortModal() {
            if (!gameActive) return;
            playSFX('click');
            document.getElementById('penalty-amount').innerText = currentReward;
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('abort-confirm').classList.add('active');
        }

        function closeAbortModal() {
            playSFX('click');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('abort-confirm').classList.remove('active');
        }

        function confirmAbort() {
            playSFX('click', true); 
            gameActive = false;
            closeAbortModal();
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function generateCriminalRecordID() {
            let usedIDs = JSON.parse(localStorage.getItem('bioBreachUsedIDs')) || [];
            let newId;
            let unique = false;
            let attempts = 0;

            while (!unique && attempts < 500) {
                newId = "C-" + Math.floor(Math.random() * 8999 + 1000); 
                if (!usedIDs.includes(newId)) {
                    unique = true;
                }
                attempts++;
            }

            if (!unique) {
                usedIDs = [];
                newId = "C-" + Math.floor(Math.random() * 8999 + 1000);
            }

            usedIDs.push(newId);
            if (usedIDs.length > 5000) usedIDs.shift(); 
            
            localStorage.setItem('bioBreachUsedIDs', JSON.stringify(usedIDs));
            return newId;
        }

        function isCriminalCaptured(suspect) {
            const captured = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
            return captured.some(c => 
                c.n === suspect.n && 
                c.p === suspect.p && 
                c.t === suspect.t && 
                c.o === suspect.o && 
                c.accName === suspect.accName
            );
        }

        function initGame() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('out').style.color = "var(--terminal-green)";
            playSFX('newCase', true);
            
            currentReward = Math.floor(Math.random() * 500) + 100;
            document.getElementById('case-id-display').innerText = `CASO #${Math.floor(Math.random() * 9000) + 1000}`;
            document.getElementById('case-reward-display').innerText = currentReward;
            
            pendingDiscards = []; 
            lastQueryText = "";
            document.getElementById('queryInput').disabled = false;
            document.getElementById('queryInput').placeholder = "INTERROGAR SISTEMA (¿...?)...";

            let attempts = 0;
            let validCase = false;
            
            while (!validCase && attempts < 100) {
                generateNewSquad(); 
                const candidate = personas[Math.floor(Math.random() * personas.length)];
                
                if (!isCriminalCaptured(candidate)) {
                    objetivo = candidate;
                    validCase = true;
                } else {
                    attempts++;
                }
            }
            
            if (!validCase) {
                objetivo = personas[Math.floor(Math.random() * personas.length)];
            }

            objetivo.recordId = generateCriminalRecordID();

            gameActive = true;
            
            typeWriter("ESCANEO FINALIZADO. ESPERANDO CONSULTA...", "out", 15);
            renderBoard();
            updateWalletUI();
        }

        function generateNewSquad() {
            personas = [];
            DP = {
                M: [
                    "LEON", "MARC", "OTTO", "IVAN", "ERIC", "HUAN", "KURT", "NOAH", "AXEL", "SAUL", "IGOR", "LIAM", "ENZO", "HUGO", "OMAR", "LUC", "YURI", "RYAN", "FINN", "EZRA", "MILO", "IAN", "ALAN", "KAI", "BORIS",
                    "OSCAR", "VICTOR", "FELIX", "DANTE", "BRUNO", "KALEB", "SILAS", "ARLO", "THEO", "REMY", "ZAYN", "LUCA", "NICO", "JUDE", "ELIAS", "SETH", "KANE", "AARON", "SIMON", "RAUL", "LEVI", "TOBIAS", "GAGE", "XANDER", "JACE",
                    "KAREM", "NASH", "ZION", "COLE", "BEAU", "REID", "KNOX", "RHYS", "OTIS", "MILO", "ARLO", "EZRA", "HUGO", "FELIX", "JUDE", "LUCA", "THEO", "SILAS", "KAI", "ENZO", "AXEL", "NOAH", "OTTO", "IVAN",
                    "YOSEF", "MALIK", "SAID", "OMAR", "AMIR", "ZAYD", "HAMZA", "TARIQ", "KHALIL", "IDRIS", "HASSAN", "RAYAN", "SAMI", "KARIM", "ADAM", "NOAH", "LIAM", "ERIC", "MARC", "LEON", "HUAN", "KURT", "IGOR", "LUC", "YURI",
                    "RYAN", "ALAN", "BORIS", "OSCAR", "VICTOR", "DANTE", "BRUNO", "KALEB", "REMY", "ZAYN", "NICO", "ELIAS", "SETH", "KANE", "AARON", "SIMON", "RAUL", "LEVI", "TOBIAS", "GAGE", "XANDER", "JACE", "KAREN", "NASH", "ZION",
                    "COLE", "BEAU", "REID", "KNOX", "RHYS", "OTIS", "ALEX", "BLAKE", "CALEB", "DYLAN", "ETHAN", "FLYNN", "GRANT", "HENRY", "ISAAC", "JACK", "KYLE", "LUKE", "MAX", "NATE", "OWEN", "PIKE", "QUINN", "RILEY", "SEAN",
                    "TATE", "URIE", "VANCE", "WADE", "XAVI", "YORK", "ZANE", "ALDO", "BART", "CARL", "DIRK", "EMIL", "FRANZ", "GUST", "HANS", "IVAR", "JENS", "KARL", "LARS", "MADS", "NILS", "OLAF", "PIET", "ROLF", "STIG",
                    "THOR", "ULF", "VERN", "WOLF", "YENS", "ZOLT", "ANTON", "BORIS", "CYRIL", "DIMITRI", "EVAN", "FEDOR", "GREG", "IVAN", "IGOR", "JAN", "KONRAD", "LEV", "MIKHAIL", "NIKOLAI", "OLEG", "PAVEL", "SERGEI", "VIKTOR", "YURI",
                    "ZINO", "ANDRE", "BLAISE", "CLAUDE", "DIDIER", "ETIENNE", "FABIEN", "OSVALDO", "HENRI", "ISAAC", "JEAN", "LUC", "MARC", "NOEL", "OLIVER", "PIERRE", "REMY", "SERGE", "THIERRY", "URBAIN", "VICTOR", "YVES", "ZEPHYR"
                ],
                F: [
                    "MIA", "LARA", "YUNA", "OLGA", "ADRI", "ZOE", "INÉS", "KIRA", "EMMA", "RUTH", "SARA", "LUNA", "VERA", "NORA", "MAYA", "LEA", "IRIS", "ALBA", "GALA", "JUNE", "CLAUDIA", "ANA", "EVA", "LISA",
                    "NINA", "JADE", "ROSE", "MILA", "RUBY", "EDEN", "ISLA", "LYRA", "MAIA", "OPAL", "FAYE", "SKYE", "TESS", "WILLA", "ZARA", "ALEXA", "BELLA", "CHLOE", "DIANA", "ELSA", "FREYA", "HOPE", "IVY", "KYRA", "LANA", "MYRA",
                    "AMARA", "BELLE", "CORA", "DAISY", "ELIZA", "FLORA", "GRETA", "HAZEL", "INDIE", "JUNE", "KEIRA", "LOLA", "MABEL", "NELL", "OLIVE", "PEARL", "QUINN", "RENA", "SADIE", "THEA", "UNA", "VADA", "WREN", "XENA", "YARA",
                    "ZELDA", "ALMA", "BONNIE", "SOLANGE", "DORA", "EDNA", "FAITH", "GIA", "HOLLY", "IDA", "JOY", "KAY", "LILY", "MINA", "NELL", "ORA", "PIPA", "ROSA", "SHEA", "TARA", "UTAH", "VIDA", "WILD", "XIA", "YOLI",
                    "ZOEY", "ANNA", "BETH", "CLARA", "DINA", "ELLA", "FAYE", "GWEN", "HEIDI", "ASTRID", "JANE", "KATE", "LUCY", "MARY", "NELL", "OLGA", "POLY", "RUTH", "SARA", "TESS", "UMA", "VIV", "WYN", "XIA", "YARA", "ZITA",
                    "ADELE", "BINA", "COCO", "ALEXA", "ENID", "FIFI", "GIGI", "HOPE", "INES", "JANA", "KIKI", "LULU", "MIMI", "NANA", "ORLY", "PEPA", "QUEE", "RIRI", "SISI", "TITI", "UVEE", "VIVI", "ISABEL", "XIXI", "YAYA", "ZIZI",
                    "ALICE", "BIANCA", "CELIA", "DORIS", "ELENA", "FIONA", "GRACE", "HELEN", "IRENE", "JULIA", "KAREN", "LINDA", "MARIA", "NAOMI", "PAULA", "ROSE", "SONIA", "TANIA", "URSULA", "VAL", "WANDA", "XENIA", "YVON", "ZARA",
                    "AUREA", "BRISA", "CIELO", "DALIA", "ESTER", "FLOR", "GEMMA", "HILDA", "IRMA", "JUANA", "KATIA", "LIDIA", "MARTA", "NURIA", "OLIVIA", "PILAR", "RAQUEL", "SILVIA", "TERE", "VICKY", "XEMA", "YIZA", "ZENIA", "AGATHA"
                ],
                P: [
                    {n: "ALEMANIA", c: "EUROPA"}, {n: "ESPAÑA", c: "EUROPA"}, {n: "ITALIA", c: "EUROPA"}, {n: "FRANCIA", c: "EUROPA"}, {n: "SUIZA", c: "EUROPA"}, {n: "RUSIA", c: "EUROPA"},
                    {n: "JAPÓN", c: "ASIA"}, {n: "CHINA", c: "ASIA"}, {n: "COREA", c: "ASIA"}, {n: "INDIA", c: "ASIA"}, {n: "TAILANDIA", c: "ASIA"}, {n: "VIETNAM", c: "ASIA"},
                    {n: "MÉXICO", c: "AMÉRICA"}, {n: "BRASIL", c: "AMÉRICA"}, {n: "USA", c: "AMÉRICA"}, {n: "BOLIVIA", c: "AMÉRICA"}, {n: "COLOMBIA", c: "AMÉRICA"}, {n: "ECUADOR", c: "AMÉRICA"}, {n: "PERÚ", c: "AMÉRICA"}, {n: "ARGENTINA", c: "AMÉRICA"}, {n: "CANADÁ", c: "AMÉRICA"},
                    {n: "AUSTRALIA", c: "OCEANÍA"}, {n: "NUEVA ZELANDA", c: "OCEANÍA"},
                    {n: "EGIPTO", c: "ÁFRICA"}, {n: "SUDAFRICA", c: "ÁFRICA"}, {n: "NIGERIA", c: "ÁFRICA"}, {n: "MARRUECOS", c: "ÁFRICA"}
                ],
                T: ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"],
                O: ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"],
                A: [
                    {n: "GORRA", u: "CABEZA"}, {n: "CASCO", u: "CABEZA"}, {n: "SOMBRERO", u: "CABEZA"}, {n: "DIADEMA", u: "CABEZA"}, {n: "BOINA", u: "CABEZA"}, {n: "PASAMONTAÑAS", u: "CABEZA"},
                    {n: "GAFAS", u: "OJOS"}, {n: "MONÓCULO", u: "OJOS"}, {n: "VISOR", u: "OJOS"}, {n: "PARCHE", u: "OJOS"}, {n: "LENTES SOL", u: "OJOS"},
                    {n: "MALETÍN", u: "MANO"}, {n: "TABLETA", u: "MANO"}, {n: "RELOJ", u: "MANO"}, {n: "ANILLO", u: "MANO"}, {n: "GUANTE", u: "MANO"}, {n: "CELULAR", u: "MANO"}, {n: "BASTÓN", u: "MANO"}
                ]
            };

            const shuffle = (array) => array.sort(() => Math.random() - 0.5);
            const poolM = shuffle([...new Set(DP.M)]);
            const poolF = shuffle([...new Set(DP.F)]);

            for (let i = 0; i < 25; i++) {
                const genero = Math.random() > 0.5 ? "MASCULINO" : "FEMENINO";
                const pais = DP.P[Math.floor(Math.random() * DP.P.length)];
                const acc = DP.A[Math.floor(Math.random() * DP.A.length)];
                
                let nombre = "";
                if (genero === "MASCULINO") {
                    nombre = poolM.pop() || "UNIT-M" + i;
                } else {
                    nombre = poolF.pop() || "UNIT-F" + i;
                }

                personas.push({
                    n: nombre, g: genero, p: pais.n, cont: pais.c,
                    t: DP.T[Math.floor(Math.random() * DP.T.length)], o: DP.O[Math.floor(Math.random() * DP.O.length)],
                    edad: Math.floor(Math.random() * 50) + 18, altura: (Math.random() * 0.5 + 1.5).toFixed(2),
                    accName: acc.n, accUbi: acc.u
                });
            }
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);

            personas.forEach(p => {
                const card = document.createElement('div');
                card.className = 'suspect-card';
                card.id = `card-${p.n}`;
                
                card.onclick = () => { 
                    if(gameActive) { 
                        const cardEl = document.getElementById(`card-${p.n}`);
                        if(cardEl.classList.contains('discarded')) return;

                        if (pendingDiscards.length > 0) {
                            playSFX('discard');
                            discardVisual(cardEl);
                            
                            if (pendingDiscards.includes(p.n)) {
                                pendingDiscards = pendingDiscards.filter(id => id !== p.n);
                            }

                            if (p.n === objetivo.n) {
                                checkStatus(); 
                                return;
                            }

                            if (pendingDiscards.length > 0) {
                                document.getElementById('out').innerHTML = `> ${lastQueryText}<br><span style="color:var(--hazard)">OBJETIVOS RESTANTES: ${pendingDiscards.length}</span>`;
                            } else {
                                playSFX('click'); 
                                document.getElementById('out').innerHTML = `> ${lastQueryText}<br><span style="color:var(--terminal-green)">DESCARTE COMPLETADO. SISTEMA HABILITADO.</span>`;
                                document.getElementById('queryInput').disabled = false;
                                document.getElementById('queryInput').placeholder = "INTERROGAR SISTEMA (¿...?)...";
                                document.getElementById('queryInput').focus();
                            }
                            
                            checkStatus();

                        } 
                        else if (lastQueryText !== "") {
                            playSFX('discard');
                            discardVisual(cardEl);
                            if (p.n === objetivo.n) { checkStatus(); return; }
                            checkStatus();
                        }
                        else {
                            playSFX('error');
                            document.getElementById('out').style.color = "var(--hazard)";
                            typeWriter("ERROR: REALICE UNA CONSULTA PARA IDENTIFICAR OBJETIVOS.", "out", 10);
                        }
                    } 
                };

                const rib = p.g === "MASCULINO" ? "ribbon-male" : "ribbon-female";
                card.innerHTML = `<div class="gender-ribbon ${rib}"></div><div class="card-header">${p.n}</div><div class="card-body"><b>ORG:</b> ${p.p}<br><b>TEZ:</b> ${p.t}<br><b>OJO:</b> ${p.o}<br><b>EDA:</b> ${p.edad}<br><b>ALT:</b> ${p.altura}M<br><b>ACC:</b> ${p.accName}</div>`;
                board.appendChild(card);
            });
        }

        function discardVisual(card) {
            if (currentMosaicMode === 5) {
                card.classList.add('discarded'); 
            } else {
                card.classList.add('discarded');
            }
        }

        function checkStatus() {
            const activeCards = Array.from(document.querySelectorAll('.suspect-card')).filter(c => !c.classList.contains('discarded'));
            
            if (document.getElementById(`card-${objetivo.n}`).classList.contains('discarded')) {
                return endGame(false);
            }
            
            if (activeCards.length === 1 && activeCards[0].id === `card-${objetivo.n}`) {
                return endGame(true);
            }
        }

        function endGame(win) {
            gameActive = false;
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('overlay').classList.add('active');
            const rewardMsg = document.getElementById('overlay-reward-msg');
            const desc = document.getElementById('overlay-desc');
            
            if (win) { 
                playSFX('win', true); 
                totalMoney += currentReward;
                
                const solvedList = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
                solvedList.push(objetivo);
                localStorage.setItem('bioBreachSolved', JSON.stringify(solvedList));

                document.getElementById('overlay-title').innerText = "OBJETIVO LOCALIZADO"; 
                document.getElementById('overlay-title').style.color = "var(--victory)";
                rewardMsg.innerText = `+${currentReward} S/ TRANSFERIDOS`;
                
                desc.innerHTML = `
                    <div class="dossier-container">
                        <div class="dossier-header">
                            <span>REGISTRO CRIMINAL</span>
                            <span>[${objetivo.recordId}]</span>
                        </div>
                        <div class="dossier-info">
                            <p><b>SUJETO:</b> ${objetivo.n}</p>
                            <p><b>ORIGEN:</b> ${objetivo.p} (${objetivo.cont})</p>
                            <p><b>PERFIL:</b> ${objetivo.g} / ${objetivo.edad} AÑOS</p>
                            <p><b>RASGOS:</b> ${objetivo.t} / OJOS ${objetivo.o}</p>
                            <p><b>ESTATURA:</b> ${objetivo.altura} METROS</p>
                            <p><b>ACCESORIO DETECTADO:</b> ${objetivo.accName}</p>
                            <div class="stamp-captured">CAPTURED</div>
                        </div>
                    </div>
                `;

            } else { 
                playSFX('fail', true);
                document.getElementById('overlay-title').innerText = "OBJETIVO PERDIDO"; 
                document.getElementById('overlay-title').style.color = "var(--hazard)";
                rewardMsg.innerText = "CONTRATO CANCELADO";
                
                desc.innerHTML = `
                    <div class="dossier-container" style="border-color: var(--hazard); background: rgba(50, 0, 0, 0.3);">
                        <div class="dossier-header" style="border-color: var(--hazard); color: var(--hazard);">
                            <span>REGISTRO CRIMINAL</span>
                            <span>[${objetivo.recordId}]</span>
                        </div>
                        <div class="dossier-info">
                            <p><b>SUJETO:</b> ${objetivo.n}</p>
                            <p><b>ORIGEN:</b> ${objetivo.p} (${objetivo.cont})</p>
                            <p><b>PERFIL:</b> ${objetivo.g} / ${objetivo.edad} AÑOS</p>
                            <p><b>RASGOS:</b> ${objetivo.t} / OJOS ${objetivo.o}</p>
                            <p><b>ESTATURA:</b> ${objetivo.altura} METROS</p>
                            <p><b>ACCESORIO DETECTADO:</b> ${objetivo.accName}</p>
                            <div class="stamp-captured" style="color: var(--hazard); border-color: var(--hazard);">ESCAPED</div>
                        </div>
                    </div>
                `;
            }
            updateWalletUI();
        }

        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isTyping) {
                let rawValue = this.value.trim();
                
                if (!rawValue.startsWith('¿') || !rawValue.endsWith('?')) {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter("ERROR: SINTAXIS INVÁLIDA. FORMULE UNA PREGUNTA (¿...?)", "out", 10);
                    return;
                }

                const q = rawValue.toUpperCase();
                this.value = '';
                let checkFunc = null; 
                let validQuery = false;

                const hasWord = (word) => {
                    const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                    return new RegExp("(?:^|[\\s¿])" + escaped + "(?:$|[\\s?.,])").test(q);
                };

                const validateSyntax = (keyword, fullQuery) => {
                    if (new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + "\\s*\\?+$").test(fullQuery)) return true;
                    const validNextWords = ["ES", "TIENE", "USA", "LLEVA", "MIDE", "PESA", "ESTÁ", "ERA", "FUE", "DE", "EN", "EL", "LA", "CON", "POR", "QUE", "Y", "O"];
                    const escapedKw = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                    const contextRegex = new RegExp(`(?:^|[\\s¿])${escapedKw}\\s+(${validNextWords.join('|')})\\b`);
                    if (contextRegex.test(fullQuery)) return true;
                    return false;
                };

                if (hasWord("ACCESORIO") || hasWord("OBJETO")) {
                    validQuery = true;
                    if (hasWord("CABEZA") || hasWord("PELO")) checkFunc = p => p.accUbi === "CABEZA";
                    else if (hasWord("OJOS") || hasWord("CARA")) checkFunc = p => p.accUbi === "OJOS";
                    else if (hasWord("MANO") || hasWord("BRAZO")) checkFunc = p => p.accUbi === "MANO";
                    else {
                        const accList = ["GORRA", "CASCO", "SOMBRERO", "GAFAS", "MONÓCULO", "VISOR", "MALETÍN", "TABLETA", "RELOJ", "DIADEMA", "BOINA", "PASAMONTAÑAS", "PARCHE", "ANILLO", "GUANTE", "CELULAR", "BASTÓN"];
                        const found = accList.find(a => hasWord(a) && validateSyntax(a, q));
                        if(found) checkFunc = p => p.accName === found;
                        else validQuery = false;
                    }
                }
                else if (q.match(/\b(EUROPA|EUROPEO|EUROPEA)\b/)) { checkFunc = p => p.cont === "EUROPA"; validQuery = true; }
                else if (q.match(/\b(ASIA|ASIÁTICO|ASIÁTICA)\b/)) { checkFunc = p => p.cont === "ASIA"; validQuery = true; }
                else if (q.match(/\b(AMÉRICA|AMERICANO|AMERICANA)\b/)) { checkFunc = p => p.cont === "AMÉRICA"; validQuery = true; }
                else if (q.match(/\b(OCEANÍA|OCEÁNICO|OCEÁNICA)\b/)) { checkFunc = p => p.cont === "OCEANÍA"; validQuery = true; }
                else if (q.match(/\b(ÁFRICA|AFRICANO|AFRICANA)\b/)) { checkFunc = p => p.cont === "ÁFRICA"; validQuery = true; }
                
                else {
                    const demonyms = {
                        "ALEMANIA": "ALEMÁN", "ESPAÑA": "ESPAÑOL", "FRANCIA": "FRANCÉS", "ITALIA": "ITALIANO", "SUIZA": "SUIZO", "RUSIA": "RUSO",
                        "CHINA": "CHINO", "JAPÓN": "JAPONÉS", "COREA": "COREANO", "INDIA": "INDIO", "TAILANDIA": "TAILANDÉS", "VIETNAM": "VIETNAMITA", 
                        "MÉXICO": "MEXICANO", "BRASIL": "BRASILEÑO", "USA": "AMERICANO", "BOLIVIA": "BOLIVIANO", "COLOMBIA": "COLOMBIANO", "ECUADOR": "ECUATORIANO",
                        "PERÚ": "PERUANO", "ARGENTINA": "ARGENTINO", "CANADÁ": "CANADIENSE",
                        "AUSTRALIA": "AUSTRALIANO", "NUEVA ZELANDA": "NEOZELANDÉS",
                        "EGIPTO": "EGIPCIO", "SUDAFRICA": "SUDAFRICANO", "NIGERIA": "NIGERIANO", "MARRUECOS": "MARROQUÍ"
                    };

                    const getFem = (word) => {
                        if (word.endsWith('O')) return word.slice(0, -1) + 'A';
                        if (word.endsWith('ÉS')) return word.slice(0, -2) + 'ESA';
                        if (word.endsWith('OL')) return word + 'A'; 
                        if (word.endsWith('ÁN')) return word.slice(0, -2) + 'ANA'; 
                        return word;
                    };

                    const foundCountry = DP.P.find(c => {
                        const demo = demonyms[c.n];
                        if (hasWord(c.n) && validateSyntax(c.n, q)) return true;
                        if (demo && hasWord(demo) && validateSyntax(demo, q)) return true;
                        if (demo) {
                            const fem = getFem(demo);
                            if (fem !== demo && hasWord(fem) && validateSyntax(fem, q)) return true;
                        }
                        return false;
                    });

                    if (foundCountry) {
                        checkFunc = p => p.p === foundCountry.n;
                        validQuery = true;
                    } 
                    else if (hasWord("INICIAL") || hasWord("EMPIEZA")) {
                        const letra = q.match(/\b[A-Z]\b/); 
                        if (letra) { 
                            if (validateSyntax(letra[0], q)) {
                                checkFunc = p => p.n.startsWith(letra[0]); 
                                validQuery = true; 
                            } else {
                                validQuery = false; 
                            }
                        }
                        else { typeWriter("ESPECIFIQUE UNA LETRA.", "out", 10); return; }
                    }
                    else if (hasWord("EDAD") || hasWord("MIDE") || hasWord("ALTO")) {
                        const numMatch = q.match(/\d+(\.\d+)?/);
                        if (numMatch) {
                            validQuery = true;
                            const val = parseFloat(numMatch[0]);
                            const isAge = hasWord("EDAD");
                            if (hasWord("MAYOR") || hasWord("MÁS")) checkFunc = p => (isAge ? p.edad : parseFloat(p.altura)) > val;
                            else if (hasWord("MENOR") || hasWord("MENOS")) checkFunc = p => (isAge ? p.edad : parseFloat(p.altura)) < val;
                            else checkFunc = p => Math.abs((isAge ? p.edad : parseFloat(p.altura)) - val) < 0.05;
                        }
                    }
                    else if (q.match(/\b(HOMBRE|MASCULINO)\b/)) { checkFunc = p => p.g === "MASCULINO"; validQuery = true; }
                    else if (q.match(/\b(MUJER|FEMENINO)\b/)) { checkFunc = p => p.g === "FEMENINO"; validQuery = true; }
                    else {
                        const colors = ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"];
                        const skins = ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"];                                                                                    
                        
                        const cMatch = colors.find(c => hasWord(c) && validateSyntax(c, q));
                        const sMatch = skins.find(s => hasWord(s) && validateSyntax(s, q));
                        
                        if(cMatch) { checkFunc = p => p.o === cMatch; validQuery = true; }
                        else if(sMatch) { checkFunc = p => p.t === sMatch; validQuery = true; }
                    }
                }

                if (validQuery && checkFunc) {
                    playSFX('click');
                    document.getElementById('out').style.color = "var(--terminal-green)";
                    
                    const targetHasTrait = checkFunc(objetivo);
                    const respText = targetHasTrait ? "SÍ." : "NO.";
                    
                    const cards = document.querySelectorAll('.suspect-card');
                    pendingDiscards = personas.filter(p => {
                        const card = document.getElementById('card-' + p.n);
                        if (card.classList.contains('discarded')) return false; 
                        
                        const suspectHasTrait = checkFunc(p);
                        return suspectHasTrait !== targetHasTrait; 
                    }).map(p => p.n);

                    lastQueryText = `CONSULTA: ${q}<br>RESPUESTA: ${respText}`;

                    if (pendingDiscards.length > 0) {
                        const msg = `${lastQueryText}<br><span style="color:var(--hazard)">BLOQUEO ACTIVO: ELIMINE A ${pendingDiscards.length} SOSPECHOSOS INCOMPATIBLES.</span>`;
                        typeWriter(msg, "out", 15);
                        document.getElementById('queryInput').disabled = true;
                        document.getElementById('queryInput').placeholder = "!! DESCARTE REQUERIDO !!";
                    } else {
                        typeWriter(`${lastQueryText}<br>NINGÚN DESCARTE DISPONIBLE CON ESTA INFORMACIÓN.`, "out", 15);
                    }

                } else {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter("DATOS NO RECONOCIDOS O AMBIGUOS.", "out", 10);
                }
            }
        });

        updateWalletUI();
    </script>
</body>
</html>