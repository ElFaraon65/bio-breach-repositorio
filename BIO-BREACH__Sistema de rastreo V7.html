<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-BREACH: ONLINE SURVIVAL V8.2 - WARFARE UPDATE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --gold: #ffd700;
            --dark-red: #8b0000;
            --bg-dark: #07070a;
            --terminal-green: #00ff41;
            --victory: #00ff88;
            --hazard: #ff4400;
            --ribbon-male: #0088ff;
            --ribbon-female: #ff0077;
            --disabled: #444;
            --cork-bg: #1a1510;
            --ranking-blue: #0088ff;
        }

        /* CLASES DE SABOTAJE */
        .sabotage-blur {
            filter: blur(5px) !important;
            pointer-events: none;
            user-select: none;
            transition: filter 0.5s;
        }

        .sabotage-scramble {
            font-family: 'Wingdings', 'Zapf Dingbats', sans-serif !important; 
            letter-spacing: 2px;
        }
        
        /* Contenedor de sugerencias de comandos */
        #cmd-suggestions {
            position: absolute;
            bottom: 60px; /* Encima del input */
            left: 10px;
            width: calc(100% - 20px);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--terminal-green);
            z-index: 6000;
            display: none;
            flex-direction: column;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 -5px 20px rgba(0, 255, 65, 0.2);
        }

        .cmd-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            color: var(--terminal-green);
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cmd-item:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        .cmd-item.used {
            color: #555;
            text-decoration: line-through;
            pointer-events: none;
            background: #111;
        }
        .cmd-desc {
            font-size: 0.65rem;
            color: #888;
            font-style: italic;
        }

        /* Alerta de Sabotaje Recibido */
        #sabotage-alert {
            position: fixed; top: 150px; width: 100%; text-align: center;
            color: var(--hazard); font-weight: bold; font-size: 1.2rem;
            background: rgba(50, 0, 0, 0.8);
            padding: 15px; border-top: 2px solid var(--hazard);
            border-bottom: 2px solid var(--hazard);
            z-index: 8000; display: none;
            text-shadow: 0 0 10px var(--hazard);
            pointer-events: none;
            animation: glitch-anim 0.2s infinite;
        }

        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            margin: 0; padding: 10px;
            font-family: 'Consolas', monospace;
            color: #eee;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            transition: background-color 2s ease; /* Para efecto chromatic */
        }

        /* --- EFECTOS VISUALES (PUNTOS) --- */
        .flying-point {
            position: fixed;
            color: var(--gold);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 6000;
            text-shadow: 0 0 5px var(--gold);
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
        }
        
        .point-impact {
            animation: impactShake 0.3s ease-in-out;
            color: #fff !important;
            text-shadow: 0 0 10px #fff !important;
        }

        @keyframes impactShake {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* --- NOTIFICACIÓN RIVAL (PRESIÓN) --- */
        #rival-alert {
            position: fixed; top: 100px; width: 90%; left: 5%; text-align: center;
            color: #fff; font-weight: bold; font-size: 1rem;
            background: linear-gradient(90deg, transparent, rgba(0, 191, 255, 0.8), transparent);
            padding: 10px; border-top: 2px solid #00BFFF;
            border-bottom: 2px solid #00BFFF;
            z-index: 2000; display: none; opacity: 0;
            text-shadow: 0 0 5px #000;
            pointer-events: none;
        }
        
        @keyframes alertFadeSlow { 
            0% { opacity: 0; transform: scale(0.9); } 
            15% { opacity: 1; transform: scale(1.1); } 
            25% { transform: scale(1); }
            85% { opacity: 1; } 
            100% { opacity: 0; transform: translateY(-10px); } 
        }
        
        .active-alert {
            display: block !important;
            animation: alertFadeSlow 4s ease-in-out forwards;
        }

        /* --- PANTALLA DE INTERACCIÓN INICIAL --- */
        #interaction-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.8s ease, backdrop-filter 0.8s ease;
            cursor: pointer;
        }
        .interaction-text {
            color: var(--gold);
            font-size: 1.5rem;
            letter-spacing: 5px;
            text-transform: uppercase;
            animation: pulseText 2s infinite;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            pointer-events: none;
        }
        @keyframes pulseText { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- PANTALLA DE CARGA --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader-bar-container {
            width: 80%; max-width: 400px; height: 4px;
            background: #222; margin-top: 20px;
            border: 1px solid var(--gold);
        }
        .loader-bar {
            height: 100%; width: 0%;
            background: var(--gold);
            transition: width 0.1s linear;
        }
        .loading-text {
            color: var(--gold); font-size: 1.2rem; letter-spacing: 3px;
            animation: blink 0.8s infinite;
        }

        /* --- PANTALLA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 7000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
        }
        
        .login-input {
            background: #111; 
            border: 1px solid var(--gold); 
            color: var(--gold);
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 1.2rem;
            text-align: center; 
            text-transform: uppercase; 
            margin: 20px 0; 
            outline: none;
            width: 100%;
            max-width: 300px;
            letter-spacing: 2px;
        }
        .login-input:focus {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            background: #221a00;
        }

        #wallet-display {
            position: absolute; top: 20px; right: 20px;
            border-left: 3px solid var(--gold); padding: 5px 15px;
            background: rgba(255, 215, 0, 0.05);
            text-align: right;
        }
        
        #profile-display {
            position: absolute; top: 20px; left: 20px;
            border-right: 3px solid var(--terminal-green); padding: 5px 15px;
            background: rgba(0, 255, 65, 0.05);
            text-align: left;
            display: none;
        }
        
        .currency { color: var(--gold); font-size: 1.2rem; font-weight: bold; }
        .agent-id { color: var(--terminal-green); font-size: 0.7rem; letter-spacing: 1px;}
        .agent-name { color: #fff; font-size: 1rem; font-weight: bold; text-transform: uppercase;}

        #main-menu {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
            transition: opacity 0.5s ease;
        }

        .menu-title {
            font-size: 3.5rem; color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            margin-bottom: 50px; text-align: center; letter-spacing: 5px;
            line-height: 1.2;
            padding: 0 20px;
        }

        .menu-buttons {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 400px; padding: 0 20px;
        }

        .btn-play {
            background: var(--dark-red); color: white; border: 2px solid #ff4400;
            padding: 20px 60px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            transition: all 0.2s; width: 100%;
        }

        .btn-exit {
            background: #222; color: #888; border: 2px solid #444;
            padding: 10px 40px; font-size: 1rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.2s;
        }
        .btn-exit:hover { background: #333; color: white; border-color: #666; }

        /* --- ONLINE LOBBY & GAME MODES --- */
        #gamemode-screen, #online-lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3200; padding: 20px;
            overflow-y: auto;
        }

        @media (max-height: 850px) {
            #gamemode-screen {
                justify-content: flex-start;
                padding-top: 50px;
            }
        }

        .mode-container {
            display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 800px;
        }

        .mode-card {
            background: #111;
            border: 1px solid var(--gold);
            width: 100%; max-width: 300px;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; flex-direction: column;
        }

        .mode-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            background: #1a1500;
        }

        .mode-img-placeholder {
            width: 100%; height: 140px;
            background: #222;
            display: flex; justify-content: center; align-items: center;
            color: #555;
            font-size: 3rem;
            border-bottom: 1px solid #444;
        }

        .mode-info { padding: 20px; text-align: center; }
        .mode-title { color: var(--gold); font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px;}
        .mode-desc { color: #888; font-size: 0.8rem; line-height: 1.4; }

        .lobby-status-box {
            border: 1px solid var(--victory); background: rgba(0,255,136,0.05);
            padding: 20px; width: 100%; max-width: 500px; text-align: center;
            margin-bottom: 20px;
        }
        .room-code-display { font-size: 2rem; color: white; letter-spacing: 5px; margin: 10px 0; font-weight: bold; user-select: text; word-break: break-all; }
        
        .player-list { list-style: none; padding: 0; text-align: left; }
        .player-list li { border-bottom: 1px solid #333; padding: 5px; display: flex; justify-content: space-between;}
        .player-ready { color: var(--victory); }

        /* Range Slider Customization */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; margin: 15px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--gold); cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px var(--gold);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
        }
        .time-display {
            font-size: 1.2rem; color: var(--ranking-blue); font-weight: bold; margin-bottom: 10px;
        }

        /* Bloqueo visual para clientes en lobby */
        .locked-settings {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        .locked-settings::after {
            content: "SOLO ADMIN";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #444;
            font-size: 0.8rem;
            font-weight: bold;
            border: 1px solid #444;
            padding: 2px 5px;
            background: black;
            opacity: 0.8;
        }

        /* --- CONFIGURACIÓN Y MODALES --- */
        #settings-modal, #tutorial-screen, #abort-confirm, #overlay, #migration-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 4000; padding: 20px;
        }
        
        #settings-modal { z-index: 3500; }
        #migration-modal { z-index: 4500; } 
        #overlay, #abort-confirm { background: rgba(0, 0, 0, 0.95); z-index: 2000; text-align: center; }
        #overlay.active, #abort-confirm.active { display: flex; opacity: 1; }

        .tutorial-box {
            width: 100%;
            max-width: 500px; 
            border: 1px solid var(--gold);
            padding: 25px; 
            background: #0a0a0a; 
            text-align: center;
            max-height: 85vh; 
            overflow-y: auto; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .tutorial-box::-webkit-scrollbar { width: 6px; }
        .tutorial-box::-webkit-scrollbar-thumb { background: var(--dark-red); }

        .mosaic-options { display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap; justify-content: center;}
        .mosaic-btn {
            background: #111; border: 1px solid #444; color: #888;
            padding: 15px 25px; cursor: pointer; font-family: 'Consolas', monospace;
        }
        .mosaic-btn.active { border-color: var(--gold); color: var(--gold); background: #221a00; }

        .step { margin-bottom: 20px; text-align: left; border-left: 2px solid var(--dark-red); padding-left: 15px; }
        .step b { color: var(--gold); display: block; margin-bottom: 5px; }

        /* --- MURO DE CRIMINALES --- */
        #archives-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cork-bg);
            background-image: radial-gradient(#2a2018 1px, transparent 1px);
            background-size: 10px 10px;
            display: none; flex-direction: column;
            align-items: center;
            z-index: 3500;
            padding-top: 90px;
            overflow-y: auto;
        }

        .wall-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(10, 5, 0, 0.98);
            border-bottom: 2px solid var(--dark-red);
            padding: 15px; text-align: center;
            z-index: 3600; box-shadow: 0 5px 20px #000;
        }
        .wall-title-text {
            color: var(--gold); font-size: 1.5rem; letter-spacing: 4px; 
            text-transform: uppercase; font-weight: bold;
        }

        .wall-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;
            width: 100%; max-width: 1200px;
            padding: 20px; padding-bottom: 100px;
        }

        .wall-card {
            width: 150px; min-height: 210px;
            background: #e0e0e0; color: #111;
            padding: 8px 8px 25px 8px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            position: relative;
            transform-origin: center top;
            transition: transform 0.2s, z-index 0.2s;
            cursor: default;
        }
        .wall-card:hover { transform: scale(1.2) rotate(0deg) !important; z-index: 999; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }

        .pin {
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--dark-red); border: 1px solid #300;
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            box-shadow: 1px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .pin.gold { background: var(--gold); border-color: #886600; box-shadow: 0 0 5px var(--gold); }
        .pin.blue { background: #0088ff; border-color: #003366; box-shadow: 0 0 5px #0088ff; }

        .mugshot-zone {
            width: 100%; height: 90px;
            background: #222; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #999;
        }
        .mugshot-icon { font-size: 2rem; color: #555; }
        
        .wall-info { font-family: 'Courier New', monospace; font-size: 0.55rem; line-height: 1.3; text-align: left; }
        .wall-info b { color: #000; font-weight: 800; }
        
        .stamp-solved {
            position: absolute; bottom: 10px; right: 5px;
            border: 2px solid var(--dark-red); color: var(--dark-red);
            font-size: 0.7rem; font-weight: bold; padding: 2px 4px;
            transform: rotate(-15deg); opacity: 0.7;
        }

        .btn-back-wall {
            position: fixed; bottom: 20px; 
            background: #000; border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 30px; cursor: pointer; z-index: 3600;
            font-weight: bold; text-transform: uppercase;
        }
        .btn-back-wall:hover { background: var(--gold); color: #000; }

        /* --- DOSSIER DE MISIÓN --- */
        .dossier-container {
            border: 2px solid var(--victory);
            background: rgba(0, 50, 20, 0.3);
            padding: 20px; margin: 20px 0; text-align: left;
            width: 100%; max-width: 400px;
            font-family: 'Courier New', monospace;
        }
        .dossier-header {
            border-bottom: 1px dashed var(--victory); margin-bottom: 10px;
            padding-bottom: 5px; color: var(--victory);
            font-weight: bold; display: flex; justify-content: space-between;
        }
        .dossier-info p { margin: 5px 0; font-size: 0.85rem; color: #ddd; }
        .dossier-info b { color: var(--gold); }
        .stamp-captured {
            color: var(--victory); border: 2px solid var(--victory);
            padding: 5px 10px; font-weight: bold;
            transform: rotate(-5deg); display: inline-block;
            margin-top: 10px; font-size: 1.2rem;
        }

        /* --- INTERFAZ PRINCIPAL --- */
        .machine-body {
            background: linear-gradient(145deg, #1a1a1a, #000);
            width: 100%; max-width: 900px; padding: 20px;
            border: 2px solid #333; border-radius: 12px; display: none;
            margin-bottom: 0px; 
            flex-grow: 1; 
            display: flex; flex-direction: column;
            max-height: calc(100vh - 20px); 
        }
        .machine-body[style*="display: none"] { display: none !important; } 
        .machine-body[style*="display: block"] { display: flex !important; }

        .blur-effect { filter: blur(15px) grayscale(1); transition: filter 0.4s; }

        /* --- BOARD GRID SYSTEM --- */
        .board-grid {
            display: grid; gap: 8px; margin-bottom: 10px; 
            transition: all 0.3s; width: 100%;
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        .board-grid::-webkit-scrollbar { width: 8px; background: #111; }
        .board-grid::-webkit-scrollbar-thumb { background: var(--dark-red); border-radius: 4px; }

        /* CONFIGURACIÓN 5x5 */
        .board-grid.mode-5 {
            grid-template-columns: repeat(5, 1fr);
            min-height: 200px; 
        }
        .board-grid.mode-5 .suspect-card { height: auto; aspect-ratio: 2/3; }
        .board-grid.mode-5 .card-body { font-size: 1.0rem; line-height: 1.2; }
        .board-grid.mode-5 .suspect-card.discarded {
            transform: scale(0.8); opacity: 0.1; 
            pointer-events: none; filter: grayscale(1);
        }

        /* CONFIGURACIÓN 3x3 */
        .board-grid.mode-3 {
            grid-template-columns: repeat(3, 1fr);
            gap: 10px; padding-right: 5px;
        }
        .board-grid.mode-3 .suspect-card { height: auto; min-height: 140px; }
        .board-grid.mode-3 .card-header { font-size: 0.9rem; margin-bottom: 6px; }
        .board-grid.mode-3 .card-body { font-size: 0.65rem; line-height: 1.4; }
        .board-grid.mode-3 .suspect-card.discarded { display: none; }

        /* CONFIGURACIÓN 2x2 */
        .board-grid.mode-2 {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px; padding-right: 5px;
        }
        .board-grid.mode-2 .suspect-card { height: auto; min-height: 180px; }
        .board-grid.mode-2 .card-header { font-size: 1.2rem; margin-bottom: 10px; }
        .board-grid.mode-2 .card-body { font-size: 0.8rem; line-height: 1.5; }
        .board-grid.mode-2 .suspect-card.discarded { display: none; }

        /* --- TARJETAS --- */
        .suspect-card {
            background: #111; border: 1px solid #444; border-radius: 4px;
            padding: 8px 4px 4px 4px; cursor: pointer;
            transition: all 0.3s ease; position: relative;
            box-sizing: border-box; overflow: hidden; width: 100%;
            display: flex; flex-direction: column;
        }
        .suspect-card.target-glow {
            border-color: var(--hazard);
            box-shadow: 0 0 10px var(--hazard);
        }

        .gender-ribbon { position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        .ribbon-male { background: var(--ribbon-male); }
        .ribbon-female { background: var(--ribbon-female); }

        .card-header { font-size: 0.65rem; font-weight: bold; color: var(--gold); border-bottom: 1px solid #333; margin-bottom: 4px; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex-shrink: 0;}
        .card-body { color: #aaa; word-wrap: break-word; flex-grow: 1;}

        .terminal-zone { background: #000; border: 1px solid #222; padding: 10px; border-radius: 5px; margin-top: auto; flex-shrink: 0; position: relative; }
        
        #queryInput { 
            width: 100%; background: transparent; border: none; 
            border-bottom: 1px solid var(--terminal-green); 
            color: #fff; padding: 5px; font-family: 'Consolas', monospace; outline: none; font-size: 16px; 
        }
        #queryInput:disabled {
            border-bottom: 1px dashed #444; color: #444; cursor: not-allowed;
        }

        .output { color: var(--terminal-green); font-size: 0.7rem; min-height: 50px; margin-top: 5px; line-height: 1.3; }
        
        .btn-main { width: 100%; padding: 12px; background: var(--dark-red); color: white; border: 1px solid #ff4400; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-abort { background: #222; border-color: #444; margin-top: 10px; font-size: 0.8rem; padding: 10px; }
        .btn-abort:hover { background: #440000; border-color: var(--hazard); }
        
        .btn-mini { 
            background: #222; color: var(--gold); border: 1px solid var(--gold); 
            padding: 4px 10px; font-size: 0.7rem; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s;
        }
        .btn-mini:hover { background: var(--gold); color: #000; }

        #case-info-bar { display: flex; justify-content: space-between; align-items: center; color: var(--gold); margin-bottom: 10px; font-size: 0.75rem; border-bottom: 1px solid #222; padding-bottom: 5px; flex-shrink: 0; transition: filter 0.5s; }

        #preload-status {
            position: fixed; bottom: 10px; left: 10px;
            font-size: 0.6rem; color: #444;
        }

        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* RESPONSIVIDAD */
        @media (max-height: 600px) {
             .menu-title { font-size: 2rem; margin-bottom: 20px; }
             .machine-body { padding: 10px; border: none; }
             #wallet-display { top: 5px; right: 5px; }
             #profile-display { top: 5px; left: 5px; }
        }

        @media (max-width: 768px) {
            body { padding: 0; }
            .machine-body { padding: 10px; max-width: 100%; border-radius: 0; border: none; height: 100vh; max-height: 100vh; }
            .menu-title { font-size: 2.5rem; }
            .btn-play { padding: 15px 30px; font-size: 1.2rem; }
            
            .board-grid.mode-5 { gap: 4px; }
            .board-grid.mode-5 .suspect-card { padding: 2px; }
            .board-grid.mode-5 .card-body { font-size: 0.35rem; }
        }

        @media (max-width: 480px) {
            .menu-title { font-size: 1.8rem; letter-spacing: 2px; }
            #wallet-display { top: 10px; right: 10px; padding: 2px 8px; }
            #profile-display { top: 10px; left: 10px; padding: 2px 8px; }
            .currency { font-size: 1rem; }
            .agent-id { font-size: 0.6rem; }
            .agent-name { font-size: 0.8rem; }
            
            .board-grid.mode-5 { gap: 3px; }
            .board-grid.mode-5 .card-header { font-size: 0.8rem; margin-bottom: 2px; padding-top: 2px; }
            .board-grid.mode-5 .card-body { font-size: 0.5rem; line-height: 1.1; letter-spacing: -0.2px; }
            
            .board-grid.mode-3 { gap: 6px; }
            .board-grid.mode-3 .suspect-card { min-height: 120px; }
            .board-grid.mode-3 .card-body { font-size: 0.55rem; }
            
            .board-grid.mode-2 { gap: 8px; }
            .board-grid.mode-2 .suspect-card { min-height: 250px; }
            .board-grid.mode-2 .card-body { font-size: 1.0rem; }
            
            .terminal-zone { padding: 8px; }
            #queryInput { font-size: 0.9rem; }
            .btn-main { padding: 10px; font-size: 0.9rem; }
            #case-info-bar { flex-direction: row; gap: 5px; font-size: 0.65rem; }
        }
    </style>
</head>
<body>

    <div id="interaction-overlay" onclick="initAudioSystem()">
        <div class="interaction-text">TOCAR PARA INICIAR SISTEMA</div>
    </div>

    <div id="rival-alert">EL RIVAL HA DESCARTADO</div>
    
    <!-- Alerta de Sabotaje recibido -->
    <div id="sabotage-alert">¡ERROR CRÍTICO!</div>

    <div id="loading-screen">
        <div class="loading-text">RECALIBRANDO SISTEMA...</div>
        <div class="loader-bar-container">
            <div id="loader-progress" class="loader-bar"></div>
        </div>
    </div>

    <div id="login-screen">
        <div class="tutorial-box">
            <h2 style="color: var(--gold); text-shadow: 0 0 10px var(--gold);">IDENTIFICACIÓN</h2>
            <p style="color: #aaa;">SE REQUIERE ALIAS DE AGENTE PARA ACCEDER A LA RED GLOBAL.</p>
            
            <input type="text" id="agent-name-input" class="login-input" placeholder="NOMBRE DE AGENTE..." maxlength="12" autocomplete="off">
            
            <p style="font-size: 0.7rem; color: var(--terminal-green);">EL SISTEMA ASIGNARÁ UNA ID ÚNICA AUTOMÁTICAMENTE.</p>

            <button class="btn-main" onclick="registerUser()">CONFIRMAR IDENTIDAD</button>
        </div>
    </div>

    <div id="archives-screen">
        <div class="wall-header">
            <div class="wall-title-text">CRIMINALES ATRAPADOS</div>
            <div style="font-size: 0.7rem; color: #888;">REGISTRO DE OPERACIONES EXITOSAS</div>
        </div>
        <div id="wall-container" class="wall-grid">
            </div>
        <button class="btn-back-wall" onclick="closeArchives()">VOLVER AL MENÚ</button>
    </div>

    <div id="main-menu">
        <div id="profile-display">
            <div class="agent-name" id="display-agent-name">AGENTE</div>
            <div class="agent-id" id="display-agent-id">ID: ----</div>
        </div>
        <div id="wallet-display">
            <div style="font-size: 0.6rem; color: #666;">SALDO NETO</div>
            <div class="currency"><span id="total-money">0</span> S/</div>
        </div>
        <h1 class="menu-title">BIO-BREACH<br><span style="font-size: 1.2rem; color: #555;">SISTEMA DE RASTREO</span></h1>
        <div class="menu-buttons">
            <button class="btn-play" onclick="openGameModeSelection()">INICIAR OPERACIÓN</button>
            <button class="btn-exit" onclick="openArchives()">ARCHIVOS (MURO)</button>
            <button class="btn-exit" onclick="openSettings()">CONFIGURACIÓN</button>
            <button class="btn-exit" onclick="exitGame()">SALIR DEL SISTEMA</button>
        </div>
        <div id="preload-status">SISTEMA: EN LÍNEA</div>
    </div>

    <div id="gamemode-screen">
        <h2 style="color: var(--gold); text-shadow: 0 0 15px rgba(255,215,0,0.5); font-size: 2rem; margin-bottom: 40px; text-transform: uppercase;">Seleccionar Protocolo</h2>
        
        <div class="mode-container">
            <div class="mode-card" onclick="selectMode('classic')">
                <div class="mode-img-placeholder">
                    <span>★</span>
                </div>
                <div class="mode-info">
                    <div class="mode-title">Modo Clásico</div>
                    <div class="mode-desc">Operación estándar. Sin límite de tiempo. Resolución paciente de casos individuales.</div>
                </div>
            </div>

            <div class="mode-card" style="border-color: var(--ranking-blue);" onclick="openOnlineMenu()">
                <div class="mode-img-placeholder" style="color: var(--ranking-blue);">
                    <span>⚡</span>
                </div>
                <div class="mode-info">
                    <div class="mode-title" style="color: var(--ranking-blue);">Modo Supervivencia (ONLINE)</div>
                    <div class="mode-desc">Resuelve infinitos casos contra un rival. Comandos de sabotaje habilitados.</div>
                </div>
            </div>
        </div>
        <button class="btn-exit" onclick="closeGameModeSelection()" style="margin-top: 30px; margin-bottom: 50px; position:relative; z-index:3500; width: 100%; max-width: 300px; background: #333; color: white; border: 1px solid #666;">CANCELAR</button>
    </div>

    <div id="online-lobby">
        <div class="tutorial-box" style="width:100%; max-width:600px; border-color: var(--ranking-blue);">
            <h2 style="color: var(--ranking-blue);">RED PRIVADA ENCRIPTADA</h2>
            
            <div id="online-main-options">
                <button class="btn-main" style="margin-bottom:10px;" onclick="createRoom()">CREAR SALA NUEVA (HOST)</button>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="join-room-input" class="login-input" style="margin:0; font-size:1rem;" placeholder="CÓDIGO DE SALA" maxlength="6">
                    <button class="btn-main" style="width:auto; background:#222; border-color:var(--gold);" onclick="joinRoom()">UNIRSE</button>
                </div>
            </div>

            <div id="online-wait-room" style="display:none;">
                <p>CÓDIGO DE ACCESO SEGURO:</p>
                <div class="room-code-display" id="lobby-room-code">GENERANDO...</div>
                
                <div class="lobby-status-box">
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">AGENTES CONECTADOS:</div>
                    <ul id="lobby-player-list" class="player-list">
                        <li>ESPERANDO CONEXIÓN...</li>
                    </ul>
                </div>

                <div id="lobby-settings" style="margin-bottom:15px;">
                    <p style="font-size:0.7rem; color:var(--gold);">CONFIGURACIÓN DE SALA</p>
                    
                    <div style="margin: 20px 0; border: 1px dashed #444; padding: 10px;">
                        <label for="time-slider" style="color:#aaa; font-size:0.8rem;">TIEMPO DE OPERACIÓN:</label>
                        <div class="time-display"><span id="time-val-display">10</span> MINUTOS</div>
                        <input type="range" id="time-slider" min="2" max="10" value="10" step="1" oninput="updateTimeSliderDisplay(this.value)">
                    </div>

                    <div class="mosaic-options" style="margin:5px 0;">
                        <button class="mosaic-btn active" id="btn-seed-same" onclick="setOnlineMode('same')">CASO COMÚN</button>
                        <button class="mosaic-btn" id="btn-seed-diff" onclick="setOnlineMode('diff')">CASOS DISTINTOS</button>
                    </div>
                </div>

                <button id="btn-start-host" class="btn-main" style="background:var(--ranking-blue); color:black; display:none;" onclick="hostStartGame()">INICIAR OPERACIÓN</button>

                <div id="client-wait-msg" style="display:none; color:var(--terminal-green);">
                    > ESPERANDO A QUE EL LÍDER INICIE LA MISIÓN...
                </div>
            </div>

            <button class="btn-exit" onclick="exitOnlineLobby()">SALIR DEL LOBBY</button>
        </div>
    </div>

    <div id="migration-modal">
        <div class="tutorial-box" style="border-color: var(--gold);">
            <h2 style="color: var(--gold); text-shadow: 0 0 10px rgba(0,255,65,0.4);">REPORTE DE SISTEMA</h2>
            <p style="color: #eee; font-size: 0.9rem; margin-bottom: 20px;">ACTUALIZACIÓN CRÍTICA DETECTADA</p>
            
            <div class="step" style="border-left-color: var(--terminal-green);">
                <b>ESTADO DE BASE DE DATOS:</b>
                <span style="color: #aaa;">HISTORIAL DESHECHO POR ACTUALIZACIÓN V8 CON CORRECCCIONES.</span>
            </div>
            
            <div class="step" style="border-left-color: var(--gold);">
                <b>RECOMPENSA OTORGADA:</b>
                <div style="margin-top: 5px;">
                    CRIMINALES PROCESADOS: <span id="mig-count" style="color: white; font-weight: bold;">0</span><br>
                    BONIFICACIÓN: <span id="mig-money" style="color: var(--gold); font-size: 1.2rem; font-weight: bold;">0</span> S/
                </div>
            </div>

            <button class="btn-main" onclick="closeMigrationModal()" style="background: #222; border-color: var(--gold); color: var(--gold);">CONFIRMAR RECEPCIÓN</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="tutorial-box">
            <h2 style="color: var(--gold);">CONFIGURACIÓN DE MOSAICO</h2>
            <p style="color:#aaa; font-size: 0.8rem;">Seleccione la densidad de visualización de objetivos.</p>
            
            <div class="mosaic-options">
                <button class="mosaic-btn" id="btn-mode-2" onclick="selectMosaic(2)">2x2</button>
                <button class="mosaic-btn" id="btn-mode-3" onclick="selectMosaic(3)">3x3</button>
                <button class="mosaic-btn active" id="btn-mode-5" onclick="selectMosaic(5)">5x5</button>
            </div>
            <p id="mosaic-desc" style="font-size: 0.7rem; color: var(--terminal-green); min-height: 20px;">ESTÁNDAR: Vista completa, sin deslizamiento.</p>

            <button class="btn-main" onclick="saveSettings()">CONFIRMAR</button>
        </div>
    </div>

    <div id="tutorial-screen">
        <div class="tutorial-box">
            <h2 id="tutorial-title" style="color: var(--gold); margin-top: 0;">MANUAL DE CAMPO</h2>
            <div id="tutorial-content">
                </div>
            <button class="btn-main" onclick="startGame()">ENTENDIDO</button>
        </div>
    </div>

    <div id="abort-confirm">
        <div class="tutorial-box">
            <h2 style="color: var(--hazard);">¿ESTÁS SEGURO?</h2>
            <p>Perderás el monto de <span id="penalty-amount" style="color:var(--gold)">0</span> S/ del contrato actual.</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-main" style="background:var(--hazard); width: auto;" onclick="confirmAbort()">ESTOY SEGURO</button>
                <button class="btn-main" style="background:#333; width: auto;" onclick="closeAbortModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="overlay-title"></h1>
        <div id="overlay-desc" style="width: 100%; display: flex; justify-content: center;"></div>
        <p id="overlay-reward-msg"></p>
        <button class="btn-main" id="btn-next-case" style="width: 250px;" onclick="initGame()">SIGUIENTE CASO</button>
    </div>

    <div class="machine-body" id="main-ui">
        <div id="case-info-bar">
            <span id="case-id-display">CASO #----</span>
            <span id="game-points" style="color: var(--terminal-green)">PTS: 0</span>
            <span id="comp-timer-display" style="display:none; color: var(--ranking-blue); font-weight: bold;">10:00</span>
            <button id="btn-new-case" class="btn-mini" onclick="initGame()">NUEVO CASO</button>
            
            <span style="color: var(--victory)">RECOMPENSA: <span id="case-reward-display">0</span> S/</span>
        </div>
        <div class="board-grid mode-5" id="board"></div>
        
        <div class="terminal-zone">
            <div id="cmd-suggestions"></div>
            <input type="text" id="queryInput" autocomplete="off" placeholder="INTERROGAR SISTEMA (¿...?)...">
            <div class="output" id="out">> AGUARDANDO COMANDOS...</div>
        </div>
        <button class="btn-main btn-abort" onclick="openAbortModal()">ABORTAR CASO</button>
    </div>

    <script>
        // ==========================================
        // === MOTOR DE AUDIO (MANTENIDO) ===
        // ==========================================
        let actx, musicMaster, limiter, reverbNode, warmDistortion;
        let isMusicRunning = false;
        let musicTimerID;
        let nextNoteTime = 0;
        let musicBeat = 0;
        let musicMode = 1; 
        let currentTempo = 80;
        
        const CHORDS = {
            cm11_L: [130.81, 196.00, 293.66], cm11_R: [311.13, 466.16, 698.46], 
            ab_L: [103.83, 155.56, 233.08], ab_R: [311.13, 415.30, 622.25], 
            g7_L: [98.00, 146.83, 233.08], g7_R: [311.13, 415.30, 587.33],
            f_maj_L: [87.31, 130.81, 174.61], f_maj_R: [349.23, 440.00, 523.25],
            dm_L: [73.42, 110.00, 146.83], dm_R: [293.66, 349.23, 440.00],
            doom_cluster_L: [65.41, 77.78, 92.50], doom_cluster_R: [155.56, 185.00, 220.00],
            taxi_stab_L: [146.83, 185.00, 233.08], taxi_stab_R: [369.99, 440.00, 523.25],
            f_min_L: [87.31, 103.83, 130.81], f_min_R: [174.61, 207.65, 261.63],
            eb_maj7_L: [155.56, 196.00, 233.08], eb_maj7_R: [311.13, 392.00, 466.16],
            d7alt_L: [146.83, 185.00, 246.94], d7alt_R: [293.66, 369.99, 440.00]
        };

        const SCALES = {
            dorian_sharp4: [196.00, 220.00, 233.08, 277.18, 293.66, 329.63, 369.99],
            blues_min: [196.00, 233.08, 261.63, 277.18, 293.66, 349.23], 
            lydian: [261.63, 329.63, 369.99, 392.00, 440.00], 
            mystery_dim: [65.41, 77.78, 92.50, 110.00, 130.81], 
            urban_penta: [196.00, 233.08, 261.63, 293.66, 349.23], 
            noir_theme: [196.00, 207.65, 233.08, 261.63, 293.66],
            taxi_extended: [196.00, 233.08, 261.63, 293.66, 311.13, 349.23, 392.00, 466.16]
        };

        async function initAudioSystem() {
            const overlay = document.getElementById('interaction-overlay');
            overlay.style.opacity = '0';
            overlay.style.backdropFilter = 'blur(0px)';
            overlay.style.webkitBackdropFilter = 'blur(0px)';
            setTimeout(() => { overlay.style.display = 'none'; }, 800);

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            actx = new AudioContext({ latencyHint: 'playback' });
            await actx.resume();

            limiter = actx.createDynamicsCompressor();
            limiter.threshold.value = -8;
            limiter.knee.value = 30;
            limiter.ratio.value = 12;
            
            musicMaster = actx.createGain();
            musicMaster.gain.value = 0.6; 

            warmDistortion = actx.createWaveShaper();
            warmDistortion.curve = makeDistortionCurve(10); 
            warmDistortion.oversample = '4x';

            limiter.connect(musicMaster);
            musicMaster.connect(actx.destination);

            createReverb();
            startAtmosphere(); 
            
            isMusicRunning = true;
            nextNoteTime = actx.currentTime + 0.1;
            scheduler();
            
            checkUserProfile();
        }

        let currentUser = null;

        function checkUserProfile() {
            const storedProfile = localStorage.getItem('bioBreachProfile');
            if (storedProfile) {
                currentUser = JSON.parse(storedProfile);
                updateProfileUI();
                fadeToMode(1); 
            } else {
                fadeToMode(1);
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('agent-name-input').focus();
            }
        }

        function registerUser() {
            const nameInput = document.getElementById('agent-name-input');
            const name = nameInput.value.trim().toUpperCase();

            if (name.length < 2) {
                playSFX('error');
                nameInput.style.borderColor = 'var(--hazard)';
                return;
            }

            playSFX('click');
            const uniqueId = "U-" + Date.now().toString(36).toUpperCase().slice(-4) + Math.floor(Math.random()*1000);
            currentUser = {
                name: name,
                id: uniqueId,
                created: Date.now()
            };

            localStorage.setItem('bioBreachProfile', JSON.stringify(currentUser));
            document.getElementById('login-screen').style.display = 'none';
            updateProfileUI();
            playSFX('win'); 
        }

        function updateProfileUI() {
            if(currentUser) {
                document.getElementById('profile-display').style.display = 'block';
                document.getElementById('display-agent-name').innerText = currentUser.name;
                document.getElementById('display-agent-id').innerText = "ID: " + currentUser.id;
            }
        }

        function makeDistortionCurve(amount) {
            const k = typeof amount === 'number' ? amount : 50, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                let x = i * 2 / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function createReverb() {
            const len = 3 * actx.sampleRate;
            const buffer = actx.createBuffer(2, len, actx.sampleRate);
            for (let i = 0; i < len; i++) {
                const decay = Math.pow(1 - i / len, 3);
                buffer.getChannelData(0)[i] = (Math.random() * 2 - 1) * decay * 0.5;
                buffer.getChannelData(1)[i] = (Math.random() * 2 - 1) * decay * 0.5;
            }
            reverbNode = actx.createConvolver();
            reverbNode.buffer = buffer;
            const revGain = actx.createGain();
            revGain.gain.value = 0.35; 
            reverbNode.connect(revGain);
            revGain.connect(limiter);
        }

        function fadeToMode(newMode) {
            if (!isMusicRunning) return;
            const t = actx.currentTime;
            musicMaster.gain.cancelScheduledValues(t);
            musicMaster.gain.setTargetAtTime(0, t, 0.1); 
            setTimeout(() => {
                setMusicModeData(newMode);
                musicMaster.gain.setTargetAtTime(0.55, actx.currentTime, 0.2); 
            }, 300);
        }
        
        function silenceMusic() {
            if (!actx) return;
            const t = actx.currentTime;
            musicMaster.gain.cancelScheduledValues(t);
            musicMaster.gain.setTargetAtTime(0, t, 0.05); 
        }

        function restoreMusic() {
            if (!actx) return;
            setMusicModeData(3);
            const t = actx.currentTime;
            musicMaster.gain.cancelScheduledValues(t);
            musicMaster.gain.setTargetAtTime(0.55, t, 0.5);
        }

        function setMusicModeData(m) {
            musicMode = m;
            musicBeat = 0; 
            const tempos = [95, 80, 60, 105]; 
            currentTempo = tempos[m];
        }

        function playSax(note, duration, technique = 'normal') {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            const carrier = actx.createOscillator(); carrier.type = 'sawtooth'; carrier.frequency.value = note;
            const modulator = actx.createOscillator(); modulator.type = 'sine'; modulator.frequency.value = note; 
            const modGain = actx.createGain(); modGain.gain.value = note * 0.8; 
            modulator.connect(modGain); modGain.connect(carrier.frequency); 
            const dynFilter = actx.createBiquadFilter(); dynFilter.type = 'lowpass'; dynFilter.Q.value = 1.5; 
            const bodyFilter = actx.createBiquadFilter(); bodyFilter.type = 'peaking'; bodyFilter.frequency.value = 900; 
            bodyFilter.gain.value = 8; bodyFilter.Q.value = 1.0;
            const noiseBufferSize = actx.sampleRate * 0.5; const noiseBuffer = actx.createBuffer(1, noiseBufferSize, actx.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0); for (let i = 0; i < noiseBufferSize; i++) noiseData[i] = Math.random() * 2 - 1;
            const breathSrc = actx.createBufferSource(); breathSrc.buffer = noiseBuffer; breathSrc.loop = true;
            const breathFilter = actx.createBiquadFilter(); breathFilter.type = 'bandpass'; breathFilter.frequency.value = note * 4; breathFilter.Q.value = 0.5;
            const breathGain = actx.createGain(); breathGain.gain.value = 0.03; 
            const masterGain = actx.createGain();
            masterGain.gain.setValueAtTime(0, t);
            masterGain.gain.linearRampToValueAtTime(0.5, t + 0.1); 
            masterGain.gain.exponentialRampToValueAtTime(0.3, t + duration * 0.6); 
            masterGain.gain.exponentialRampToValueAtTime(0.001, t + duration);
            dynFilter.frequency.setValueAtTime(note, t);
            dynFilter.frequency.exponentialRampToValueAtTime(note * 4, t + 0.15); 
            dynFilter.frequency.linearRampToValueAtTime(note * 2, t + duration);
            carrier.connect(dynFilter); breathSrc.connect(breathFilter); breathFilter.connect(breathGain); breathGain.connect(dynFilter); 
            dynFilter.connect(bodyFilter); bodyFilter.connect(masterGain); masterGain.connect(warmDistortion); 
            warmDistortion.connect(limiter); warmDistortion.connect(reverbNode);
            const vib = actx.createOscillator(); vib.frequency.value = 4.0;
            const vibGain = actx.createGain(); vibGain.gain.value = 0;
            vibGain.gain.setValueAtTime(0, t); vibGain.gain.linearRampToValueAtTime(note * 0.015, t + 0.6); 
            vib.connect(vibGain); vibGain.connect(carrier.frequency);
            carrier.start(t); modulator.start(t); breathSrc.start(t); vib.start(t);
            carrier.stop(t + duration); modulator.stop(t + duration); breathSrc.stop(t + duration); vib.stop(t + duration);
        }

        function playChord(chordName, duration, arpeggioSpeed = 0.02) {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            const freqs = [...CHORDS[chordName + "_L"], ...CHORDS[chordName + "_R"]];
            const lfo = actx.createOscillator(); lfo.frequency.value = 4.5; 
            const lfoGain = actx.createGain(); lfoGain.gain.value = 0.25; 
            const tremoloMaster = actx.createGain(); tremoloMaster.gain.value = 1; 
            lfo.connect(lfoGain); lfoGain.connect(tremoloMaster.gain); lfo.start(t); lfo.stop(t+duration);

            freqs.forEach((f, i) => {
                const osc = actx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = f;
                const oscSub = actx.createOscillator(); oscSub.type = 'triangle'; oscSub.frequency.value = f;
                const oscGain = actx.createGain(); oscGain.gain.value = 0.4;
                const subGain = actx.createGain(); subGain.gain.value = 0.8; 
                const deepSub = actx.createOscillator(); deepSub.type = 'sine'; deepSub.frequency.value = 50; 
                const deepGain = actx.createGain(); deepGain.gain.setValueAtTime(0.5, t + (i*arpeggioSpeed));
                deepGain.gain.exponentialRampToValueAtTime(0.001, t + (i*arpeggioSpeed) + 0.15); 
                osc.connect(oscGain); oscSub.connect(subGain);
                const filter = actx.createBiquadFilter(); filter.type = 'lowpass';
                filter.frequency.setValueAtTime(f * 3, t + (i*arpeggioSpeed));
                filter.frequency.exponentialRampToValueAtTime(f * 0.5, t + (i*arpeggioSpeed) + 0.3); 
                const noiseLen = 0.03; const noiseBuff = actx.createBuffer(1, actx.sampleRate * noiseLen, actx.sampleRate);
                const nData = noiseBuff.getChannelData(0); for(let k=0; k<nData.length; k++) nData[k] = (Math.random()*2-1);
                const hammer = actx.createBufferSource(); hammer.buffer = noiseBuff;
                const hammerFilter = actx.createBiquadFilter(); hammerFilter.type = 'lowpass'; hammerFilter.frequency.value = 600; 
                const hammerGain = actx.createGain(); hammerGain.gain.value = 0.4; 
                const env = actx.createGain(); const startT = t + (i * arpeggioSpeed);
                env.gain.setValueAtTime(0, t); env.gain.linearRampToValueAtTime(0.3, startT + 0.01); 
                env.gain.exponentialRampToValueAtTime(0.1, startT + 0.5); env.gain.exponentialRampToValueAtTime(0.001, startT + duration);
                oscGain.connect(filter); subGain.connect(filter); filter.connect(env);
                hammer.connect(hammerFilter); hammerFilter.connect(hammerGain); hammerGain.connect(env);
                deepSub.connect(deepGain); deepGain.connect(tremoloMaster); env.connect(tremoloMaster);
                osc.start(startT); osc.stop(startT + duration); oscSub.start(startT); oscSub.stop(startT + duration);
                hammer.start(startT); deepSub.start(startT); deepSub.stop(startT + 0.2);
            });
            tremoloMaster.connect(limiter); tremoloMaster.connect(reverbNode);
        }

        function playBass(note, duration) {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            const osc = actx.createOscillator(); osc.type = 'triangle'; osc.frequency.value = note;
            const filter = actx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 220; 
            const env = actx.createGain();
            env.gain.setValueAtTime(0, t);
            env.gain.linearRampToValueAtTime(0.7, t + 0.03); 
            env.gain.exponentialRampToValueAtTime(0.01, t + duration);
            osc.connect(filter); filter.connect(env); env.connect(limiter);
            osc.start(t); osc.stop(t + duration);
        }

        function playDrum(type) {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            if (type === 'kick') {
                const osc = actx.createOscillator(); osc.frequency.setValueAtTime(120, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                const gain = actx.createGain(); gain.gain.setValueAtTime(0.8, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                osc.connect(gain); gain.connect(limiter); osc.start(t); osc.stop(t + 0.5);
            }
            else if (type === 'snare') { 
                const bufferSize = actx.sampleRate * 0.1; const buffer = actx.createBuffer(1, bufferSize, actx.sampleRate);
                const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = actx.createBufferSource(); noise.buffer = buffer;
                const filt = actx.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 2000;
                const gain = actx.createGain(); gain.gain.setValueAtTime(0.4, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                noise.connect(filt); filt.connect(gain); gain.connect(musicMaster); noise.start(t);
            }
            else if (type === 'ride') {
                const bufferSize = actx.sampleRate * 0.5; 
                const buffer = actx.createBuffer(1, bufferSize, actx.sampleRate);
                const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = actx.createBufferSource(); noise.buffer = buffer;
                const filt = actx.createBiquadFilter(); filt.type = 'highpass'; filt.frequency.value = 6000;
                const gain = actx.createGain(); 
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.25, t + 0.02); 
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4); 
                noise.connect(filt); filt.connect(gain); gain.connect(musicMaster); noise.start(t);
            }
        }

        function startAtmosphere() {
            const t = actx.currentTime;
            const buffSize = actx.sampleRate * 2; const b = actx.createBuffer(1, buffSize, actx.sampleRate);
            const d = b.getChannelData(0); let lastOut = 0;
            for(let i=0; i<buffSize; i++) {
                const white = Math.random()*2-1; d[i] = (lastOut + (0.02*white)) / 1.02; lastOut = d[i]; d[i] *= 3.5;
            }
            const noise = actx.createBufferSource(); noise.buffer = b; noise.loop = true;
            const filter = actx.createBiquadFilter(); filter.type = 'bandpass'; filter.frequency.value = 1000; filter.Q.value = 1;
            const lfo = actx.createOscillator(); lfo.frequency.value = 0.5; 
            const lfoGain = actx.createGain(); lfoGain.gain.value = 0.05;
            const masterG = actx.createGain(); masterG.gain.value = 0.04; 
            noise.connect(filter); filter.connect(masterG); lfo.connect(lfoGain); lfoGain.connect(masterG.gain);
            masterG.connect(musicMaster); noise.start(t); lfo.start(t);
        }

        function scheduler() {
            if(!isMusicRunning) return;
            const lookahead = 25.0; const scheduleAheadTime = 0.1;
            while (nextNoteTime < actx.currentTime + scheduleAheadTime) {
                runPattern(nextNoteTime, musicBeat);
                const secondsPerBeat = 60.0 / currentTempo;
                nextNoteTime += secondsPerBeat;
                musicBeat++;
            }
            musicTimerID = setTimeout(scheduler, lookahead);
        }

        function runPattern(t, b) {
            if (musicMode === 0) {
                const bassNotes = [32.70, 38.89, 43.65, 46.25]; 
                playBass(bassNotes[b % 4], 0.6); 
                if (b % 4 === 0) playDrum('ride'); 
                if (b % 4 === 2 || b % 4 === 0) playDrum('snare'); 
                if (b % 8 === 0) playChord('cm11', 4, 0.05);
                if (b % 16 === 4) playSax(SCALES.noir_theme[0], 0.8, 'normal'); 
                if (b % 16 === 5) playSax(SCALES.noir_theme[1], 0.8, 'normal'); 
                if (b % 16 === 6) playSax(SCALES.noir_theme[0], 0.8, 'normal'); 
                if (b % 16 === 7) playSax(SCALES.noir_theme[3], 2.0, 'growl'); 
            }
            else if (musicMode === 1) {
                if (b % 8 === 0) playBass(32.70, 6.0); 
                if (b % 8 === 4) playBass(46.25, 6.0); 
                if (b % 8 === 0) playDrum('ride'); 
                if (b % 8 === 0) playDrum('kick'); 
                if (b % 8 === 1) playDrum('kick'); 
                if (b % 8 === 4) playDrum('snare'); 
                if (b % 8 === 0) playChord('doom_cluster', 8, 0.3); 
                if (b % 16 === 0) playSax(SCALES.mystery_dim[0], 2.5, 'growl'); 
                if (b % 16 === 4) playSax(SCALES.mystery_dim[1], 3.0, 'growl'); 
            }
            else if (musicMode === 2) {
                if (b % 4 === 0) playBass(43.65, 2.0); 
                if (b % 4 === 2) playBass(43.65, 2.0); 
                if (b % 8 === 0) playDrum('ride'); 
                if (b % 8 === 0) playChord('f_maj', 4, 0.1); 
                if (b % 8 === 4) playChord('f_min', 4, 0.1);
            }
            else if (musicMode === 3) {
                const loop = 420;
                const lb = b % loop; 
                if (lb < 380) { 
                    if (lb % 2 === 0 || (lb % 4 === 3 && Math.random() > 0.4)) playDrum('ride');
                }
                if (lb > 32 && lb < 224) { 
                    if (lb % 4 === 0) playDrum('kick');
                    if (lb % 8 === 6) playDrum('snare');
                } else if (lb >= 224 && lb < 320) { 
                     if (lb % 2 === 0) playDrum('kick');
                     if (Math.random() > 0.6) playDrum('snare');
                } else if (lb >= 320 && lb < 380) { 
                     if (lb % 4 === 0) playDrum('kick');
                }
                if (lb < 32) { 
                    if (lb % 8 === 0) playBass(49.00, 1.5); 
                } 
                else if (lb < 160) { 
                    const walk = [49.00, 58.27, 65.41, 73.42]; 
                    if (lb % 2 === 0) playBass(walk[(lb/2)%4], 0.8);
                } 
                else if (lb < 288) { 
                    if (lb % 2 === 0) playBass(Math.random() > 0.5 ? 46.25 : 49.00, 0.6); 
                } 
                else { 
                    if (lb % 8 === 0) playBass(49.00, 3.0);
                }
                if (lb > 16 && lb < 360) {
                    if (lb % 32 === 0) playChord('taxi_stab', 0.5, 0.0); 
                    if (lb % 32 === 16) playChord('cm11', 0.6, 0.05); 
                    if (lb > 128 && lb < 256 && lb % 16 === 12) {
                        playChord(Math.random() > 0.5 ? 'eb_maj7' : 'd7alt', 0.4, 0.02);
                    }
                }
                if (lb >= 32 && lb < 96) {
                    if (lb % 16 === 0) playSax(SCALES.urban_penta[0], 2.0, 'normal');
                    if (lb % 16 === 4) playSax(SCALES.urban_penta[2], 1.5, 'normal');
                    if (lb % 16 === 14) playSax(SCALES.urban_penta[1], 1.0, 'normal');
                }
                else if (lb >= 96 && lb < 192) {
                    if (lb % 8 === 0 && Math.random() > 0.3) playSax(SCALES.taxi_extended[4], 1.2, 'normal'); 
                    if (lb % 16 === 10) playSax(SCALES.taxi_extended[6], 1.5, 'growl'); 
                    if (lb % 32 === 30) playSax(SCALES.taxi_extended[3], 0.5, 'normal');
                }
                else if (lb >= 192 && lb < 288) {
                    if (lb % 4 === 0 && Math.random() > 0.4) {
                        const randomNote = SCALES.taxi_extended[Math.floor(Math.random() * SCALES.taxi_extended.length)];
                        playSax(randomNote * 2, 0.3, 'growl'); 
                    }
                }
                else if (lb >= 288 && lb < 360) {
                    if (lb % 16 === 0) playSax(SCALES.urban_penta[0], 2.5, 'normal');
                    if (lb % 16 === 8) playSax(SCALES.urban_penta[3], 1.5, 'normal');
                }
            }
        }
        // ==========================================
        // === FIN MOTOR DE AUDIO ===
        // ==========================================

        const CACHE_NAME = 'bio-breach-audio-v1';
        let currentMosaicMode = parseInt(localStorage.getItem('bioBreachMosaic')) || 5; 
        let tempMosaicMode = currentMosaicMode; 
        
        let DP = {}; 
        
        // --- VARIABLES DE MODO DE JUEGO ---
        let isCompetitiveMode = false;
        let isGameStarted = false; // Flag para saber si la partida esta en curso
        let compRound = 0; 
        let compTimeLeft = 600; // 10 MIN DEFAULT
        let hostTimeMinutes = 10; // Variable de configuración del host
        let compTotalScore = 0;
        let compTimerInterval = null; 

        // --- ONLINE VARIABLES ---
        let peer = null;
        let conn = null;
        let isHost = false;
        let myPeerId = null;
        let connections = []; // Solo para Host
        let onlinePlayers = []; 
        let sameCaseMode = true; 
        let seededRNGVal = 1;

        // --- SABOTAJE / CIBERGUERRA ---
        // Lista de comandos disponibles (se reinicia cada partida)
        let sabotageCmds = {}; 
        
        const SABOTAGE_DEFINITIONS = {
            'REORGANIZED': { desc: 'ALTERAR POSICIÓN FÍSICA DE TARJETAS' },
            'RESTORE': { desc: 'RESTAURAR 3 SOSPECHOSOS DESCARTADOS' },
            'DATABLIND': { desc: 'OCULTAR CONTADORES Y DIFUMINAR CONSOLA' },
            'ENCRYPTEDFILES': { desc: 'CIFRAR TEXTO DE TARJETAS (SÍMBOLOS)' },
            'CHROMATIC': { desc: 'ALTERAR ESPECTRO DE COLOR VISUAL' }
        };

        function initSabotageSystem() {
            // Reiniciar estado de comandos
            sabotageCmds = {
                'REORGANIZED': false,
                'RESTORE': false,
                'DATABLIND': false,
                'ENCRYPTEDFILES': false,
                'CHROMATIC': false
            };
            document.getElementById('cmd-suggestions').style.display = 'none';
        }

        // Función pseudo-aleatoria para "Same Case"
        function seededRandom() {
            var x = Math.sin(seededRNGVal++) * 10000;
            return x - Math.floor(x);
        }

        function getRand() {
            if (isCompetitiveMode && sameCaseMode) return seededRandom();
            return Math.random();
        }

        // --- MANEJO DE ARCHIVOS Y MURO ---
        function openArchives() {
            playSFX('click');
            renderWall();
            fadeToMode(0); 
            document.getElementById('archives-screen').style.display = 'flex';
            document.getElementById('main-menu').style.display = 'none';
        }

        function closeArchives() {
            playSFX('click');
            fadeToMode(1); 
            document.getElementById('archives-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function renderWall() {
            const container = document.getElementById('wall-container');
            const solvedList = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
            container.innerHTML = '';

            if (solvedList.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:1.2rem; margin-top:50px;">NO HAY REGISTROS. ATRAPE CRIMINALES PRIMERO.</div>';
                return;
            }

            solvedList.forEach(data => {
                const rotation = (Math.random() * 10) - 5; 
                const card = document.createElement('div');
                card.className = 'wall-card';
                card.style.transform = `rotate(${rotation}deg)`;
                
                let pinClass = "";
                const pts = data.points || 0;
                if(pts >= 28) pinClass = "gold";
                else if(pts >= 15) pinClass = "blue";
                
                card.innerHTML = `
                    <div class="pin ${pinClass}"></div>
                    <div class="mugshot-zone"><span class="mugshot-icon">?</span></div>
                    <div class="wall-info">
                        <b>EXPEDIENTE:</b> ${data.recordId}<br>
                        <b>NOMBRE:</b> ${data.n}<br>
                        <b>EDAD:</b> ${data.edad} AÑOS<br>
                        <b>ORIGEN:</b> ${data.p}<br>
                        <b>TEZ:</b> ${data.t}<br>
                        <b>OJOS:</b> ${data.o}<br>
                        <b>ACCESORIO:</b> ${data.accName}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'flex';
            selectMosaic(currentMosaicMode); 
        }

        function selectMosaic(mode) {
            playSFX('click');
            tempMosaicMode = mode;
            document.querySelectorAll('.mosaic-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-mode-${mode}`).classList.add('active');
            
            const desc = document.getElementById('mosaic-desc');
            if (mode === 5) desc.innerText = "ESTÁNDAR: Vista completa, sin deslizamiento.";
            else desc.innerText = "ZOOM TÁCTICO: Tarjetas ampliadas, deslizamiento activo.";
        }

        function saveSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'none';
            if (tempMosaicMode !== currentMosaicMode) {
                applyMosaicChange(tempMosaicMode);
            }
        }

        function applyMosaicChange(newMode) {
            const loading = document.getElementById('loading-screen');
            const bar = document.getElementById('loader-progress');
            loading.style.display = 'flex';
            bar.style.width = "0%";
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if(progress > 100) progress = 100;
                bar.style.width = progress + "%";
                if(progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        currentMosaicMode = newMode;
                        localStorage.setItem('bioBreachMosaic', newMode);
                        updateBoardClass();
                        loading.style.display = 'none';
                        if(gameActive) renderBoard(); 
                    }, 500);
                }
            }, 100);
        }

        function updateBoardClass() {
            const board = document.getElementById('board');
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);
        }
        
        async function preloadAssets() {
            const statusEl = document.getElementById('preload-status');
            if (!('caches' in window)) {
                statusEl.innerText = "SISTEMA: CACHÉ NO SOPORTADA";
                return;
            }
            try {
                const cache = await caches.open(CACHE_NAME);
                const urlsToCache = Object.values(AUDIO_CONFIG).map(cfg => cfg.src);
                for (const url of urlsToCache) {
                    const response = await cache.match(url);
                    if (!response) {
                        statusEl.innerText = "DESCARGANDO ACTIVOS...";
                        await cache.add(url);
                    }
                }
                statusEl.innerText = "SISTEMA: LISTO";
            } catch (e) {
                statusEl.innerText = "SISTEMA: ERROR DE CONEXIÓN";
            }
        }

        function checkMigration() {
            if (!localStorage.getItem('bioBreach_v8_migration')) {
                localStorage.setItem('bioBreach_v8_migration', 'true');
                totalMoney = parseInt(localStorage.getItem('bioBreachMoney')) || 0;
                updateWalletUI();
            }
        }

        function closeMigrationModal() {
            playSFX('click');
            document.getElementById('migration-modal').style.display = 'none';
        }

        window.addEventListener('load', () => {
            preloadAssets();
            updateBoardClass();
            checkMigration(); 
        });

        const AUDIO_CONFIG = {
            paper: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 0.6 },
            fail: { src: 'https://assets.mixkit.co/active_storage/sfx/2805/2805-preview.mp3', vol: 0.4 }, 
            error: { src: 'https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3', vol: 0.5 }, 
            win: { src: 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3', vol: 0.5 },
            click: { src: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3', vol: 0.4 },
            type: { src: 'https://assets.mixkit.co/active_storage/sfx/2544/2544-preview.mp3', vol: 0.015 },
            newCase: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 1 },
            discard: { src: 'https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3', vol: 0.1 }
        };

        const SFX_CACHE = {};
        let activeSounds = [];

        Object.keys(AUDIO_CONFIG).forEach(key => {
            const audio = new Audio(AUDIO_CONFIG[key].src);
            audio.volume = AUDIO_CONFIG[key].vol;
            audio.crossOrigin = "anonymous";
            SFX_CACHE[key] = audio;
        });

        async function playSFX(key, interrupt = false) {
            if (!SFX_CACHE[key]) return;
            
            if (interrupt || key === 'error' || key === 'fail' || key === 'win') {
                activeSounds.forEach(s => {
                    s.pause();
                    s.currentTime = 0;
                });
                activeSounds = [];
            }

            const sound = SFX_CACHE[key].cloneNode();
            sound.volume = AUDIO_CONFIG[key].vol;
            
            if (key === 'discard') { sound.currentTime = 0.05; }
            activeSounds.push(sound);
            sound.onended = () => {
                activeSounds = activeSounds.filter(s => s !== sound);
            };

            try {
                await sound.play();
            } catch (e) {
                console.log("Audio trigger");
            }
        }

        let personas = [], objetivo = null, gameActive = false;
        let currentReward = 0;
        let totalMoney = parseInt(localStorage.getItem('bioBreachMoney')) || 0;
        let isTyping = false;
        
        let pendingDiscards = []; 
        let currentBatchTotal = 0; // Para contar descartes en lote
        let lastQueryText = "";   
        let matchPoints = 0; 
        let pointsPool = 0; 

        async function typeWriter(text, elementId, speed = 20) {
            if (isTyping) return;
            isTyping = true;
            const element = document.getElementById(elementId);
            element.innerHTML = "> ";
            let currentHTML = "> ";
            const parts = text.split(/(<[^>]*>)/g);
            for (const part of parts) {
                if (part.startsWith('<')) {
                    currentHTML += part;
                    element.innerHTML = currentHTML;
                } else {
                    for (const char of part) {
                        currentHTML += char;
                        element.innerHTML = currentHTML;
                        if (char !== " " && char !== "\n") playSFX('type');
                        await new Promise(resolve => setTimeout(resolve, speed));
                    }
                }
            }
            isTyping = false;
        }

        function updateWalletUI() {
            document.getElementById('total-money').innerText = totalMoney.toLocaleString();
            localStorage.setItem('bioBreachMoney', totalMoney);
        }

        function openGameModeSelection() {
            playSFX('click');
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('gamemode-screen').style.display = 'flex';
        }

        function closeGameModeSelection() {
            playSFX('click');
            document.getElementById('gamemode-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function selectMode(mode) {
            playSFX('click');
            isCompetitiveMode = false;
            if (mode === 'competitive') { 
                isCompetitiveMode = true; 
            }
            document.getElementById('gamemode-screen').style.display = 'none';
            showTutorial();
        }

        // --- ONLINE LOGIC START ---
        
        function openOnlineMenu() {
            playSFX('click');
            document.getElementById('gamemode-screen').style.display = 'none';
            document.getElementById('online-lobby').style.display = 'flex';
            document.getElementById('online-main-options').style.display = 'block';
            document.getElementById('online-wait-room').style.display = 'none';
            
            // Re-iniciar Peer si es necesario
            if(peer) {
                peer.destroy();
                peer = null;
            }

            // Generar nuevo ID
            const randomId = Math.floor(100000 + Math.random() * 900000).toString(); 
            peer = new Peer(randomId);
            
            document.getElementById('lobby-room-code').innerText = "CONECTANDO...";
            
            peer.on('open', (id) => {
                myPeerId = id;
                // Si ya estoy en la pantalla de host, actualizar
                if(isHost) document.getElementById('lobby-room-code').innerText = myPeerId;
            });

            peer.on('error', (err) => {
                document.getElementById('lobby-room-code').innerText = "ERROR RED";
                alert("Error de conexión al servidor de salas: " + err.type);
            });

            peer.on('connection', (c) => {
                if(!isHost) return;
                handleHostConnection(c);
            });
        }
        
        function exitOnlineLobby() {
            playSFX('click');
            if(peer) peer.destroy();
            peer = null;
            connections = [];
            onlinePlayers = [];
            isHost = false;
            isGameStarted = false;
            
            document.getElementById('online-lobby').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }
        
        function createRoom() {
            playSFX('click');
            isHost = true;
            isCompetitiveMode = true;
            compRound = 1;
            compTotalScore = 0;
            onlinePlayers = [{id: myPeerId, name: currentUser.name, score: 0, done: false}];
            
            document.getElementById('online-main-options').style.display = 'none';
            document.getElementById('online-wait-room').style.display = 'block';
            
            // Host controls visibles y habilitados, botón de start visible
            document.getElementById('lobby-settings').classList.remove('locked-settings');
            document.getElementById('btn-start-host').style.display = 'block';
            
            document.getElementById('lobby-room-code').innerText = myPeerId || "GENERANDO...";
            
            updateLobbyUI();
        }

        function handleHostConnection(c) {
            connections.push(c);
            
            c.on('open', () => {
                c.send({type: 'REQUEST_INFO'});
            });

            c.on('data', (data) => {
                if(data.type === 'INFO_RESPONSE') {
                    onlinePlayers.push({id: c.peer, name: data.name, score: 0, done: false});
                    broadcast({type: 'UPDATE_LOBBY', players: onlinePlayers});
                    // SINCRONIZACIÓN INICIAL: Enviar configuración actual al nuevo jugador
                    c.send({
                        type: 'LOBBY_SETTINGS_UPDATE', 
                        time: hostTimeMinutes, 
                        mode: sameCaseMode ? 'same' : 'diff'
                    });
                    updateLobbyUI();
                    playSFX('newCase');
                }
                else if(data.type === 'PLAYER_SCORE_UPDATE') {
                    const p = onlinePlayers.find(pl => pl.id === c.peer);
                    if(p) { p.score = data.score; }
                }
                else if (data.type === 'GAME_OVER_TIME') {
                    const p = onlinePlayers.find(pl => pl.id === c.peer);
                    if(p) { p.score = data.score; p.done = true; }
                    checkAllFinishedTimer();
                }
                else if (data.type === 'RIVAL_BATCH_DISCARD') {
                    broadcastExcluding(c.peer, {type: 'RIVAL_BATCH_DISCARD', count: data.count});
                    triggerRivalAlert(data.count); 
                }
                else if (data.type === 'SABOTAGE') {
                    // Host recibe un ataque y lo procesa si es para él, o lo ignora (aquí asumimos 1v1 el peer que envía es el atacante)
                    // Si el juego fuera multi-jugador >2, habría que definir target. Asumimos 1v1.
                    applySabotageEffect(data.effect);
                }
            });
            
            c.on('close', () => {
                 const wasPlayerCount = onlinePlayers.length;
                 onlinePlayers = onlinePlayers.filter(p => p.id !== c.peer);
                 connections = connections.filter(con => con.peer !== c.peer);
                 
                 // Si el juego está activo y alguien se sale
                 if(isGameStarted) {
                     if(wasPlayerCount === 2 && onlinePlayers.length === 1 && onlinePlayers[0].id === myPeerId) {
                         alert("EL RIVAL HA ABANDONADO LA SALA. VICTORIA POR DEFECTO.");
                         endGameTimer(); 
                         showRanking([{name: currentUser.name, score: compTotalScore + 1000}]); 
                     }
                     else if (wasPlayerCount === 2 && onlinePlayers.length === 1) {
                         const survivor = onlinePlayers[0];
                         const connSurvivor = connections.find(con => con.peer === survivor.id);
                         if(connSurvivor) connSurvivor.send({type: 'GAME_OVER_DISCONNECT_WIN'});
                     }
                 }

                 broadcast({type: 'UPDATE_LOBBY', players: onlinePlayers});
                 updateLobbyUI();
            });
        }
        
        function joinRoom() {
            const code = document.getElementById('join-room-input').value.trim();
            if(code.length < 4) { playSFX('error'); return; }
            playSFX('click');
            
            isHost = false;
            isCompetitiveMode = true;
            compRound = 1;
            compTotalScore = 0;
            
            if(!peer || peer.disconnected) {
                alert("Error: No hay conexión con el servidor. Reintentando...");
                openOnlineMenu();
                return;
            }

            conn = peer.connect(code);
            
            conn.on('open', () => {
                document.getElementById('online-main-options').style.display = 'none';
                document.getElementById('online-wait-room').style.display = 'block';
                document.getElementById('client-wait-msg').style.display = 'block';
                
                // Cliente ve controles bloqueados
                document.getElementById('lobby-settings').classList.add('locked-settings');
                document.getElementById('btn-start-host').style.display = 'none';

                document.getElementById('lobby-room-code').innerText = code;
            });
            
            conn.on('error', (err) => {
                alert("No se pudo conectar a la sala. Verifica el código.");
            });

            conn.on('data', (data) => {
                if(data.type === 'REQUEST_INFO') {
                    conn.send({type: 'INFO_RESPONSE', name: currentUser.name});
                }
                else if(data.type === 'UPDATE_LOBBY') {
                    onlinePlayers = data.players;
                    updateLobbyUI();
                }
                else if (data.type === 'LOBBY_SETTINGS_UPDATE') {
                    updateLobbySettingsUI(data.time, data.mode);
                }
                                else if(data.type === 'START_GAME') {
                    sameCaseMode = data.sameCase;
                    seededRNGVal = data.seed;
                    compTimeLeft = data.timeLimit || 600; 
                    isGameStarted = true; 
                    initSabotageSystem(); 
                    
                    // Iniciar temporizador global para el Cliente
                    if (compTimerInterval) clearInterval(compTimerInterval);
                    compTimerInterval = setInterval(updateCompTimer, 1000);
                    
                    document.getElementById('online-lobby').style.display = 'none';
                    showTutorial();  
                }
                else if(data.type === 'GAME_OVER_FINAL') {
                     showRanking(data.ranking);
                }
                else if (data.type === 'GAME_OVER_DISCONNECT_WIN') {
                    alert("EL RIVAL HA ABANDONADO. VICTORIA POR DEFECTO.");
                    gameActive = false;
                    silenceMusic();
                    if(compTimerInterval) clearInterval(compTimerInterval);
                    showRanking([{name: currentUser.name, score: compTotalScore + 1000}]);
                }
                else if (data.type === 'RIVAL_BATCH_DISCARD') {
                    triggerRivalAlert(data.count);
                }
                else if (data.type === 'SABOTAGE') {
                    applySabotageEffect(data.effect);
                }
            });
            
            // Si el host se desconecta
            conn.on('close', () => {
                alert("CONEXIÓN CON SALA PERDIDA (HOST DESCONECTADO).");
                exitOnlineLobby();
            });
        }
        
        function updateLobbyUI() {
            const list = document.getElementById('lobby-player-list');
            list.innerHTML = '';
            onlinePlayers.forEach(p => {
                const li = document.createElement('li');
                li.innerText = p.name + (p.id === myPeerId ? " (TÚ)" : "");
                if(p.done) li.classList.add('player-ready');
                list.appendChild(li);
            });
        }
        
        function broadcast(msg) {
            connections.forEach(c => c.send(msg));
        }

        function broadcastExcluding(peerId, msg) {
            connections.forEach(c => {
                if(c.peer !== peerId) c.send(msg);
            });
        }
        
        // --- CONTROL DE TIEMPO Y MODOS (HOST & SYNC) ---
        function updateTimeSliderDisplay(val) {
            hostTimeMinutes = parseInt(val);
            document.getElementById('time-val-display').innerText = hostTimeMinutes;
            
            // SI SOY HOST, ENVÍO LA ACTUALIZACIÓN A TODOS
            if (isHost) {
                broadcast({
                    type: 'LOBBY_SETTINGS_UPDATE', 
                    time: hostTimeMinutes, 
                    mode: sameCaseMode ? 'same' : 'diff'
                });
            }
        }

        function setOnlineMode(mode) {
            playSFX('click');
            sameCaseMode = (mode === 'same');
            updateUIButtonsMode();

            // SI SOY HOST, ENVÍO LA ACTUALIZACIÓN
            if (isHost) {
                 broadcast({
                    type: 'LOBBY_SETTINGS_UPDATE', 
                    time: hostTimeMinutes, 
                    mode: sameCaseMode ? 'same' : 'diff'
                });
            }
        }

        function updateUIButtonsMode() {
            document.getElementById('btn-seed-same').className = sameCaseMode ? 'mosaic-btn active' : 'mosaic-btn';
            document.getElementById('btn-seed-diff').className = !sameCaseMode ? 'mosaic-btn active' : 'mosaic-btn';
        }

        function updateLobbySettingsUI(time, mode) {
            document.getElementById('time-slider').value = time;
            document.getElementById('time-val-display').innerText = time;
            sameCaseMode = (mode === 'same');
            updateUIButtonsMode();
        }
        
        function hostStartGame() {
            playSFX('click');

            if (onlinePlayers.length < 2) {
                playSFX('error');
                alert("ERROR DE PROTOCOLO: SE REQUIEREN MÍNIMO 2 AGENTES PARA INICIAR EL MODO SUPERVIVENCIA.");
                return;
            }

            onlinePlayers.forEach(p => p.done = false);
            isGameStarted = true; // Host marca inicio
            initSabotageSystem(); // Reiniciar sabotajes
            
            const seed = Math.floor(Math.random() * 100000);
            seededRNGVal = seed;
                        const timeInSeconds = hostTimeMinutes * 60;
            compTimeLeft = timeInSeconds; 

            // Iniciar temporizador global para el Host
            if (compTimerInterval) clearInterval(compTimerInterval);
            compTimerInterval = setInterval(updateCompTimer, 1000);

            broadcast({
                type: 'START_GAME', 
                seed: seed, 
                sameCase: sameCaseMode,
                timeLimit: timeInSeconds 
            });
            
            document.getElementById('online-lobby').style.display = 'none';
            showTutorial();
        }

        function triggerRivalAlert(count) {
            const el = document.getElementById('rival-alert');
            el.innerText = `EL RIVAL HA DESCARTADO A ${count} SOSPECHOSOS`;
            el.classList.remove('active-alert');
            void el.offsetWidth; 
            el.classList.add('active-alert');
        }

        // --- SISTEMA DE SABOTAJE - LÓGICA DE APLICACIÓN ---
        function applySabotageEffect(effectName) {
            playSFX('error'); // Sonido de alerta
            
            // Mostrar Alerta Visual
            const alertBox = document.getElementById('sabotage-alert');
            alertBox.innerText = `¡ATAQUE DE SISTEMA: ${effectName}!`;
            alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, 4000);

            // LOGICA ESPECÍFICA POR COMANDO
            switch(effectName) {
                case 'REORGANIZED':
                    const board = document.getElementById('board');
                    // Mezclar hijos del DOM
                    for (let i = board.children.length; i >= 0; i--) {
                        board.appendChild(board.children[Math.random() * i | 0]);
                    }
                    typeWriter("ADVERTENCIA: INTEGRIDAD ESTRUCTURAL DEL TABLERO COMPROMETIDA.", "out", 5);
                    break;
                    
                case 'RESTORE':
                    const discarded = Array.from(document.querySelectorAll('.suspect-card.discarded'));
                    if(discarded.length > 0) {
                        // Barajar y tomar hasta 3
                        discarded.sort(() => Math.random() - 0.5);
                        const toRestore = discarded.slice(0, 3);
                        toRestore.forEach(card => {
                            card.classList.remove('discarded');
                            // Efecto visual de restauración
                            card.style.filter = "sepia(1) hue-rotate(90deg)";
                            setTimeout(() => { card.style.filter = ""; }, 1000);
                        });
                        typeWriter(`ALERTA: SE HAN REINTEGRADO ${toRestore.length} SOSPECHOSOS A LA BASE DE DATOS.`, "out", 5);
                    }
                    break;
                    
                case 'DATABLIND':
                    const out = document.getElementById('out');
                    const infoBar = document.getElementById('case-info-bar');
                    out.classList.add('sabotage-blur');
                    infoBar.classList.add('sabotage-blur');
                    
                    setTimeout(() => {
                        out.classList.remove('sabotage-blur');
                        infoBar.classList.remove('sabotage-blur');
                        typeWriter("SISTEMA VISUAL RESTAURADO.", "out", 5);
                    }, 15000); // 15 segundos
                    break;
                    
                case 'ENCRYPTEDFILES':
                    const bodies = document.querySelectorAll('.card-body');
                    bodies.forEach(b => {
                        b.setAttribute('data-original', b.innerHTML);
                        b.classList.add('sabotage-scramble');
                        // Generar texto basura
                        let trash = "";
                        for(let i=0; i<30; i++) trash += String.fromCharCode(33 + Math.random()*30);
                        b.innerHTML = trash;
                    });
                    
                    setTimeout(() => {
                        bodies.forEach(b => {
                            b.classList.remove('sabotage-scramble');
                            b.innerHTML = b.getAttribute('data-original');
                        });
                        typeWriter("ENCRIPTACIÓN FINALIZADA. DATOS LEGIBLES.", "out", 5);
                    }, 15000); // 15 segundos
                    break;
                    
                case 'CHROMATIC':
    // 1. Efecto visual global (invierte negro a blanco y viceversa)
    document.body.style.filter = "hue-rotate(180deg) invert(1)";

    // 2. Intercambio de clases para las cintas
    const allRibbons = document.querySelectorAll('.gender-ribbon');
    allRibbons.forEach(r => {
        if (r.classList.contains('ribbon-male')) {
            r.classList.remove('ribbon-male');
            r.classList.add('ribbon-female');
        } else {
            r.classList.remove('ribbon-female');
            r.classList.add('ribbon-male');
        }
    });

    setTimeout(() => {
        // 3. Restaurar filtro visual
        document.body.style.filter = "none";

        // 4. Restaurar clases de las cintas a su estado original
        const activeRibbons = document.querySelectorAll('.gender-ribbon');
        activeRibbons.forEach(r => {
            if (r.classList.contains('ribbon-male')) {
                r.classList.remove('ribbon-male');
                r.classList.add('ribbon-female');
            } else {
                r.classList.remove('ribbon-female');
                r.classList.add('ribbon-male');
            }
        });
        typeWriter("CALIBRACIÓN DE COLOR COMPLETADA.", "out", 5);
    }, 20000); // 20 segundos
    break;
            }
        }

        function triggerSabotage(cmd) {
            if(!isCompetitiveMode || !gameActive) return;
            if(sabotageCmds[cmd]) return; // Ya usado

            // Marcar como usado
            sabotageCmds[cmd] = true;
            
            // Enviar al rival
            if(isHost) broadcastExcluding(myPeerId, {type: 'SABOTAGE', effect: cmd});
            else if(conn) conn.send({type: 'SABOTAGE', effect: cmd});
            
            // Feedback local
            playSFX('type');
            typeWriter(`UPLOAD COMPLETE: EJECUTANDO PROTOCOLO ${cmd}...`, "out", 10);
            document.getElementById('cmd-suggestions').style.display = 'none';
            document.getElementById('queryInput').value = '';
        }

        // --- END ONLINE LOGIC ---

        function showTutorial() {
            if (isCompetitiveMode && compRound > 1) {
                initGame();
                return;
            }

            fadeToMode(2); 
            const tContent = document.getElementById('tutorial-content');
            
            if (isCompetitiveMode) {
                tContent.innerHTML = `
                    <div class="step" style="border-left-color: var(--ranking-blue);">
                        <b>1. SUPERVIVENCIA</b>
                        El reloj cuenta hacia atrás. Resuelve tantos casos como puedas antes de que llegue a cero.
                    </div>
                    <div class="step" style="border-left-color: var(--hazard);">
                        <b>2. GUERRA CIBERNÉTICA</b>
                        Usa la consola escribiendo <b>"/"</b> para ver comandos de sabotaje. ¡Ciega, confunde y entorpece a tu rival!
                    </div>
                    <div class="step">
                        <b>3. PRESIÓN</b>
                        El sistema te alertará cuando tus rivales completen un descarte masivo.
                    </div>
                `;
            } else {
                tContent.innerHTML = `
                    <div class="step">
                        <b>1. INTERROGATORIO PRECISO</b>
                        Pregunte por los datos que se le otorgan en las tarjetas de los sospechosos, ejemplo:"¿Tiene ojos azules?".
                    </div>
                    <div class="step">
                        <b>2. DESCARTE OBLIGATORIO</b>
                        Haga clic en las tarjetas de los sospechosos para descartarlos en base a la respuesta que le dio la consola, debe descartar a todos los relacionados antes de volver a preguntar.
                    </div>
                    <div class="step">
                        <b>3. OBJETIVO ÚNICO</b>
                        Descubra al culpable sin eliminarlo por error.
                    </div>
                `;
            }

            document.getElementById('tutorial-screen').style.display = 'flex';
        }

        function exitGame() {
            playSFX('click');
            if (window.parent && typeof window.parent.cerrarMotor === 'function') {
                window.parent.cerrarMotor();
            } else {
                fadeToMode(1); 
                alert("SISTEMA DESCONECTADO DEL NÚCLEO. SIMULANDO SALIDA.");
            }
        }

        function updateCompTimer() {
            if (!gameActive || !isCompetitiveMode) return;
            
            compTimeLeft--;
            
            if (compTimeLeft <= 0) {
                compTimeLeft = 0;
                endGameTimer(); 
            }
            
            const m = Math.floor(compTimeLeft / 60).toString().padStart(2, '0');
            const s = (compTimeLeft % 60).toString().padStart(2, '0');
            
            const timerEl = document.getElementById('comp-timer-display');
            if(timerEl) timerEl.innerText = `${m}:${s}`;
        }
        
        function endGameTimer() {
            gameActive = false;
            if(compTimerInterval) clearInterval(compTimerInterval);
            
            if(isHost) {
                const me = onlinePlayers.find(p => p.id === myPeerId);
                if(me) { me.score = compTotalScore; me.done = true; }
                checkAllFinishedTimer();
            } else {
                conn.send({type: 'GAME_OVER_TIME', score: compTotalScore});
                document.getElementById('overlay').classList.add('active');
                document.getElementById('overlay-title').innerText = "TIEMPO AGOTADO";
                document.getElementById('overlay-reward-msg').innerText = "SINCRONIZANDO RESULTADOS...";
                document.getElementById('btn-next-case').style.display = 'none';
            }
        }

                function startGame() {
            playSFX('click');
            fadeToMode(3); 
            document.getElementById('tutorial-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex'; 
            
            if (isCompetitiveMode) {
                if (compRound === 1) {
                    // Se elimina la creación del intervalo aquí para mantener la sincronía inicial
                }
            }

            initGame();
        }

        function openAbortModal() {
            if (!gameActive) return;
            playSFX('click');
            document.getElementById('penalty-amount').innerText = currentReward;
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('abort-confirm').classList.add('active');
        }

        function closeAbortModal() {
            playSFX('click');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('abort-confirm').classList.remove('active');
        }

        function confirmAbort() {
            playSFX('click', true); 
            gameActive = false;
            
            if(compTimerInterval) clearInterval(compTimerInterval);
            if(isHost && peer) { peer.destroy(); peer = null; }
            if(conn) { conn.close(); conn = null; }

            closeAbortModal();
            fadeToMode(1); 
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function generateCriminalRecordID() {
            let usedIDs = JSON.parse(localStorage.getItem('bioBreachUsedIDs')) || [];
            let newId;
            let unique = false;
            let attempts = 0;

            while (!unique && attempts < 500) {
                newId = "C-" + Math.floor(getRand() * 8999 + 1000); 
                if (!usedIDs.includes(newId)) {
                    unique = true;
                }
                attempts++;
            }
            if (!unique) {
                usedIDs = [];
                newId = "C-" + Math.floor(getRand() * 8999 + 1000);
            }
            if (!isCompetitiveMode) { 
                usedIDs.push(newId);
                if (usedIDs.length > 5000) usedIDs.shift(); 
                localStorage.setItem('bioBreachUsedIDs', JSON.stringify(usedIDs));
            }
            return newId;
        }

        function initGame() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('out').style.color = "var(--terminal-green)";
            
            restoreMusic();
            playSFX('newCase', true);
            
            currentReward = Math.floor(getRand() * 500) + 100;
            matchPoints = 0;
            pointsPool = 0;
            document.getElementById('game-points').innerText = "PTS: " + matchPoints;

            const btnNewCase = document.getElementById('btn-new-case');
            const timerDisplay = document.getElementById('comp-timer-display');

            if (isCompetitiveMode) {
                document.getElementById('case-id-display').innerText = `CASO #${compRound}`; 
                btnNewCase.style.display = 'none';
                timerDisplay.style.display = 'inline';
            } else {
                document.getElementById('case-id-display').innerText = `CASO #${Math.floor(Math.random() * 9000) + 1000}`;
                btnNewCase.style.display = 'inline';
                timerDisplay.style.display = 'none';
                if(compTimerInterval) clearInterval(compTimerInterval);
            }

            document.getElementById('case-reward-display').innerText = currentReward;
            
            pendingDiscards = []; 
            currentBatchTotal = 0;
            lastQueryText = "";
            document.getElementById('queryInput').disabled = false;
            document.getElementById('queryInput').placeholder = "INTERROGAR SISTEMA (¿...?)...";
            document.getElementById('queryInput').value = ""; 

            generateNewSquad(); 
            if(isCompetitiveMode && sameCaseMode) seededRNGVal += (compRound * 100);
            
            objetivo = personas[Math.floor(getRand() * personas.length)];
            objetivo.recordId = generateCriminalRecordID();

            gameActive = true;
            typeWriter("ESCANEO FINALIZADO. ESPERANDO CONSULTA...", "out", 15);
            renderBoard();
            updateWalletUI();
        }

        function generateNewSquad() {
            personas = [];
            DP = {
                M: ["LEON", "MARC", "OTTO", "IVAN", "ERIC", "HUAN", "KURT", "NOAH", "AXEL", "SAUL", "IGOR", "LIAM", "ENZO", "HUGO", "OMAR", "LUC", "YURI", "RYAN", "FINN", "EZRA", "MILO", "IAN", "ALAN", "KAI", "BORIS", "OSCAR", "VICTOR", "FELIX", "DANTE", "BRUNO", "KALEB", "SILAS", "ARLO", "THEO", "REMY", "ZAYN", "LUCA", "NICO", "JUDE", "ELIAS", "SETH", "KANE", "AARON", "SIMON", "RAUL", "LEVI", "TOBIAS", "GAGE", "XANDER", "JACE", "JOHN", "JAMES", "WILLIAM", "DAVID"],
                F: ["MIA", "LARA", "YUNA", "OLGA", "ADRIANA", "ZOE", "INÉS", "KIRA", "EMMA", "RUTH", "SARA", "LUNA", "VERA", "NORA", "MAYA", "LEA", "IRIS", "ALBA", "GALA", "JUNE", "CLAUDIA", "ANA", "EVA", "LISA", "NINA", "JADE", "ROSE", "MILA", "RUBY", "EDEN", "ISLA", "LYRA", "MAIA", "OPAL", "FAYE", "SKYE", "TESS", "WILLA", "ZARA", "ALEXA", "BELLA", "CHLOE", "DIANA", "ELSA", "FREYA", "KAREN", "MARIA", "SOFIA", "JULIA"],
                P: [
                    // EUROPA (Agregados Portugal, Inglaterra, Suecia, Noruega, Paises Bajos)
                    {n: "ALEMANIA", c: "EUROPA"}, {n: "ESPAÑA", c: "EUROPA"}, {n: "ITALIA", c: "EUROPA"}, {n: "FRANCIA", c: "EUROPA"}, {n: "SUIZA", c: "EUROPA"}, {n: "RUSIA", c: "EUROPA"},
                    {n: "PORTUGAL", c: "EUROPA"}, {n: "INGLATERRA", c: "EUROPA"}, {n: "SUECIA", c: "EUROPA"}, {n: "NORUEGA", c: "EUROPA"}, {n: "PAÍSES BAJOS", c: "EUROPA"},
                    
                    // ASIA
                    {n: "JAPÓN", c: "ASIA"}, {n: "CHINA", c: "ASIA"}, {n: "COREA", c: "ASIA"}, {n: "INDIA", c: "ASIA"}, {n: "TAILANDIA", c: "ASIA"}, {n: "VIETNAM", c: "ASIA"},
                    
                    // AMÉRICA (Dividido en NORTE y SUR)
                    {n: "MÉXICO", c: "AMÉRICA DEL NORTE"}, {n: "USA", c: "AMÉRICA DEL NORTE"}, {n: "CANADÁ", c: "AMÉRICA DEL NORTE"},
                    
                    {n: "BRASIL", c: "AMÉRICA DEL SUR"}, {n: "BOLIVIA", c: "AMÉRICA DEL SUR"}, {n: "COLOMBIA", c: "AMÉRICA DEL SUR"}, {n: "ECUADOR", c: "AMÉRICA DEL SUR"}, 
                    {n: "PERÚ", c: "AMÉRICA DEL SUR"}, {n: "ARGENTINA", c: "AMÉRICA DEL SUR"}, {n: "CHILE", c: "AMÉRICA DEL SUR"}, {n: "URUGUAY", c: "AMÉRICA DEL SUR"}, {n: "VENEZUELA", c: "AMÉRICA DEL SUR"},
                    
                    // OCEANÍA
                    {n: "AUSTRALIA", c: "OCEANÍA"}, {n: "NUEVA ZELANDA", c: "OCEANÍA"},
                    
                    // ÁFRICA (Agregados Kenia, Senegal, Ghana, Etiopia)
                    {n: "EGIPTO", c: "ÁFRICA"}, {n: "SUDAFRICA", c: "ÁFRICA"}, {n: "NIGERIA", c: "ÁFRICA"}, {n: "MARRUECOS", c: "ÁFRICA"},
                    {n: "KENIA", c: "ÁFRICA"}, {n: "SENEGAL", c: "ÁFRICA"}, {n: "GHANA", c: "ÁFRICA"}, {n: "ETIOPÍA", c: "ÁFRICA"}
                ],
                T: ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"],
                O: ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"],
                A: [
                    {n: "GORRA", u: "CABEZA"}, {n: "CASCO", u: "CABEZA"}, {n: "SOMBRERO", u: "CABEZA"}, {n: "DIADEMA", u: "CABEZA"}, {n: "BOINA", u: "CABEZA"}, {n: "PASAMONTAÑAS", u: "CABEZA"},
                    {n: "GAFAS", u: "OJOS"}, {n: "MONÓCULO", u: "OJOS"}, {n: "VISOR", u: "OJOS"}, {n: "PARCHE", u: "OJOS"}, {n: "LENTES SOL", u: "OJOS"},
                    {n: "MALETÍN", u: "MANO"}, {n: "TABLETA", u: "MANO"}, {n: "RELOJ", u: "MANO"}, {n: "ANILLO", u: "MANO"}, {n: "GUANTE", u: "MANO"}, {n: "CELULAR", u: "MANO"}, {n: "BASTÓN", u: "MANO"}
                ]
            };

            const customShuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(getRand() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            const poolM = customShuffle([...new Set(DP.M)]);
            const poolF = customShuffle([...new Set(DP.F)]);

            for (let i = 0; i < 25; i++) {
                const genero = getRand() > 0.5 ? "MASCULINO" : "FEMENINO";
                const pais = DP.P[Math.floor(getRand() * DP.P.length)];
                const acc = DP.A[Math.floor(getRand() * DP.A.length)];
                
                let nombre = "";
                if (genero === "MASCULINO") {
                    nombre = poolM.pop() || "UNIT-M" + i;
                } else {
                    nombre = poolF.pop() || "UNIT-F" + i;
                }

                personas.push({
                    n: nombre, g: genero, p: pais.n, cont: pais.c,
                    t: DP.T[Math.floor(getRand() * DP.T.length)], o: DP.O[Math.floor(getRand() * DP.O.length)],
                    edad: Math.floor(getRand() * 50) + 18, altura: (getRand() * 0.5 + 1.5).toFixed(2),
                    accName: acc.n, accUbi: acc.u
                });
            }
        }

        function spawnFloatingPoint(startX, startY, val) {
            if (val <= 0) return;
            const el = document.createElement('div');
            el.className = 'flying-point';
            el.innerText = `+${val}`;
            el.style.left = startX + 'px';
            el.style.top = startY + 'px';
            document.body.appendChild(el);

            const target = document.getElementById('game-points').getBoundingClientRect();
            const destX = target.left + (target.width / 2);
            const destY = target.top + (target.height / 2);

            requestAnimationFrame(() => {
                el.style.transform = `translate(${destX - startX}px, ${destY - startY}px) scale(0.5)`;
                el.style.opacity = '0';
            });

            setTimeout(() => {
                el.remove();
                matchPoints += val;
                document.getElementById('game-points').innerText = "PTS: " + matchPoints;
                document.getElementById('game-points').classList.add('point-impact');
                setTimeout(() => document.getElementById('game-points').classList.remove('point-impact'), 300);
            }, 800);
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);

            personas.forEach(p => {
                const card = document.createElement('div');
                card.className = 'suspect-card';
                card.id = `card-${p.n}`;
                
                card.onclick = () => { 
                    if(gameActive) { 
                        const cardEl = document.getElementById(`card-${p.n}`);
                        if(cardEl.classList.contains('discarded')) return;

                        if (pendingDiscards.length > 0) {
                            playSFX('discard');
                            
                            const rect = cardEl.getBoundingClientRect();
                            const centerX = rect.left + rect.width / 2;
                            const centerY = rect.top + rect.height / 2;

                            let ptsToGive = 0;
                            if (pointsPool > 0) {
                                const remainingDiscards = pendingDiscards.length; 
                                ptsToGive = Math.ceil(pointsPool / remainingDiscards);
                                if (ptsToGive > pointsPool) ptsToGive = pointsPool;
                                pointsPool -= ptsToGive;
                            }
                            
                            let winDelay = 0;
                            if (ptsToGive > 0) {
                                spawnFloatingPoint(centerX, centerY, ptsToGive);
                                winDelay = 900; 
                            }

                            discardVisual(cardEl);
                            
                            if (pendingDiscards.includes(p.n)) {
                                pendingDiscards = pendingDiscards.filter(id => id !== p.n);
                            }

                            if (p.n === objetivo.n) {
                                checkStatus(0); 
                                return;
                            }

                            if (pendingDiscards.length > 0) {
                                document.getElementById('out').innerHTML = `> ${lastQueryText}<br><span style="color:var(--hazard)">OBJETIVOS RESTANTES: ${pendingDiscards.length}</span>`;
                            } else {
                                playSFX('click'); 
                                document.getElementById('out').innerHTML = `> ${lastQueryText}<br><span style="color:var(--terminal-green)">DESCARTE COMPLETADO. SISTEMA HABILITADO.</span>`;
                                document.getElementById('queryInput').disabled = false;
                                document.getElementById('queryInput').placeholder = "INTERROGAR SISTEMA (¿...?)...";
                                document.getElementById('queryInput').focus();

                                if(isCompetitiveMode && currentBatchTotal > 0) {
                                    if(isHost) broadcastExcluding(myPeerId, {type: 'RIVAL_BATCH_DISCARD', count: currentBatchTotal});
                                    else if(conn) conn.send({type: 'RIVAL_BATCH_DISCARD', count: currentBatchTotal});
                                    currentBatchTotal = 0;
                                }
                            }
                            
                            checkStatus(winDelay);

                        } 
                        else if (lastQueryText !== "") {
                            playSFX('discard');
                            discardVisual(cardEl);
                            if (p.n === objetivo.n) { checkStatus(0); return; }
                            checkStatus(0);
                        }
                        else {
                            playSFX('error');
                            document.getElementById('out').style.color = "var(--hazard)";
                            typeWriter("ERROR: REALICE UNA CONSULTA PARA IDENTIFICAR OBJETIVOS.", "out", 10);
                        }
                    } 
                };

                const rib = p.g === "MASCULINO" ? "ribbon-male" : "ribbon-female";
                card.innerHTML = `<div class="gender-ribbon ${rib}"></div><div class="card-header">${p.n}</div><div class="card-body"><b>ORG:</b> ${p.p}<br><b>TEZ:</b> ${p.t}<br><b>OJO:</b> ${p.o}<br><b>EDA:</b> ${p.edad}<br><b>ALT:</b> ${p.altura}M<br><b>ACC:</b> ${p.accName}</div>`;
                board.appendChild(card);
            });
        }

        function discardVisual(card) {
            card.classList.add('discarded'); 
        }

        function checkStatus(delay = 0) {
            const activeCards = Array.from(document.querySelectorAll('.suspect-card')).filter(c => !c.classList.contains('discarded'));
            
            if (document.getElementById(`card-${objetivo.n}`).classList.contains('discarded')) {
                return endGame(false);
            }
            
            if (activeCards.length === 1 && activeCards[0].id === `card-${objetivo.n}`) {
                setTimeout(() => {
                    endGame(true);
                }, delay);
                return;
            }
        }

        function checkAllFinishedTimer() {
            if(!isHost) return;
            const allDone = onlinePlayers.every(p => p.done);
            if(allDone) {
                 const ranking = onlinePlayers.sort((a,b) => b.score - a.score);
                 broadcast({type: 'GAME_OVER_FINAL', ranking: ranking});
                 showRanking(ranking);
            }
        }

        function showRanking(ranking) {
            silenceMusic();
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('overlay').classList.add('active');
            
            let html = '<h2 style="color:var(--gold);">RANKING GLOBAL</h2><ol style="text-align:left; font-size:1.2rem; color:white;">';
            ranking.forEach((p, index) => {
                const color = index === 0 ? 'var(--victory)' : 'white';
                html += `<li style="color:${color}; margin-bottom:10px;">#${index+1} ${p.name} - ${p.score} PTS</li>`;
            });
            html += '</ol>';
            
            document.getElementById('overlay-desc').innerHTML = html;
            document.getElementById('overlay-title').innerText = "TIEMPO FINALIZADO";
            document.getElementById('overlay-title').style.color = "var(--ranking-blue)";
            document.getElementById('overlay-reward-msg').innerText = "CLASIFICACIÓN DE SUPERVIVENCIA";
            
            const btn = document.getElementById('btn-next-case');
            btn.style.display = 'inline-block'; 
            btn.innerText = "VOLVER AL MENÚ";
            
            btn.onclick = () => { 
                playSFX('click');
                document.getElementById('overlay').classList.remove('active');
                document.getElementById('main-ui').style.display = 'none';
                document.getElementById('main-ui').classList.remove('blur-effect'); 
                document.getElementById('main-menu').style.display = 'flex'; 

                if(peer) { peer.destroy(); peer = null; }
                if(conn) { conn.close(); conn = null; }
                connections = [];
                onlinePlayers = [];
                isHost = false;
                isCompetitiveMode = false;
                isGameStarted = false;

                fadeToMode(1);
            };
        }

        function endGame(win) {
            if (isCompetitiveMode) {
                if (win) {
                    playSFX('win', true);
                    const pointBonus = matchPoints * 10;
                    compTotalScore += matchPoints + pointBonus + 50; 
                    compRound++; 
                    
                    if(!isHost && conn) conn.send({type: 'PLAYER_SCORE_UPDATE', score: compTotalScore});
                    
                    initGame();
                } else {
                    playSFX('fail', true);
                    compTotalScore = Math.max(0, compTotalScore - 100);
                    
                    document.getElementById('main-ui').classList.add('blur-effect');
                    const overlay = document.getElementById('interaction-overlay'); 
                    overlay.style.display = 'flex'; overlay.style.opacity = 1;
                    overlay.innerHTML = '<div style="color:var(--hazard); font-size:2rem; font-weight:bold;">OBJETIVO PERDIDO<br><span style="font-size:1rem">RECALIBRANDO...</span></div>';
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        document.getElementById('main-ui').classList.remove('blur-effect');
                        initGame(); 
                    }, 2000);
                }
                return;
            }

            gameActive = false;
            silenceMusic();
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('overlay').classList.add('active');
            const rewardMsg = document.getElementById('overlay-reward-msg');
            const desc = document.getElementById('overlay-desc');
            const nextBtn = document.getElementById('btn-next-case');
            nextBtn.style.display = 'inline-block';
            
            if (win) { 
                playSFX('win', true); 
                const pointBonus = matchPoints * 10;
                totalMoney += currentReward + pointBonus;
                document.getElementById('overlay-title').innerText = "OBJETIVO LOCALIZADO"; 
                rewardMsg.innerHTML = `+${currentReward} S/ CONTRATO<br><span style="color:var(--gold)">+${pointBonus} S/ BONUS (${matchPoints} PTS)</span>`;
                nextBtn.innerText = "SIGUIENTE CASO";
                nextBtn.onclick = () => { initGame(); };

                document.getElementById('overlay-title').style.color = "var(--victory)";
                objetivo.points = matchPoints; 

                const solvedList = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
                solvedList.push(objetivo);
                localStorage.setItem('bioBreachSolved', JSON.stringify(solvedList));
                
                desc.innerHTML = `
                    <div class="dossier-container">
                        <div class="dossier-header">
                            <span>REGISTRO CRIMINAL</span>
                            <span>[${objetivo.recordId}]</span>
                        </div>
                        <div class="dossier-info">
                            <p><b>SUJETO:</b> ${objetivo.n}</p>
                            <p><b>ORIGEN:</b> ${objetivo.p} (${objetivo.cont})</p>
                            <p><b>PERFIL:</b> ${objetivo.g} / ${objetivo.edad} AÑOS</p>
                            <p><b>RASGOS:</b> ${objetivo.t} / OJOS ${objetivo.o}</p>
                            <p><b>ESTATURA:</b> ${objetivo.altura} METROS</p>
                            <p><b>ACCESORIO DETECTADO:</b> ${objetivo.accName}</p>
                            <div class="stamp-captured">CAPTURED</div>
                        </div>
                    </div>
                `;

            } else { 
                playSFX('fail', true);
                document.getElementById('overlay-title').innerText = "OBJETIVO PERDIDO"; 
                document.getElementById('overlay-title').style.color = "var(--hazard)";
                rewardMsg.innerText = "CONTRATO CANCELADO";
                nextBtn.innerText = "INTENTAR OTRO CASO";
                nextBtn.onclick = () => { initGame(); };

                desc.innerHTML = `
                    <div class="dossier-container" style="border-color: var(--hazard); background: rgba(50, 0, 0, 0.3);">
                        <div class="dossier-header" style="border-color: var(--hazard); color: var(--hazard);">
                            <span>REGISTRO CRIMINAL</span>
                            <span>[${objetivo.recordId}]</span>
                        </div>
                        <div class="dossier-info">
                            <p><b>SUJETO:</b> ${objetivo.n}</p>
                            <p><b>ORIGEN:</b> ${objetivo.p} (${objetivo.cont})</p>
                            <p><b>PERFIL:</b> ${objetivo.g} / ${objetivo.edad} AÑOS</p>
                            <p><b>RASGOS:</b> ${objetivo.t} / OJOS ${objetivo.o}</p>
                            <p><b>ESTATURA:</b> ${objetivo.altura} METROS</p>
                            <p><b>ACCESORIO DETECTADO:</b> ${objetivo.accName}</p>
                            <div class="stamp-captured" style="color: var(--hazard); border-color: var(--hazard);">ESCAPED</div>
                        </div>
                    </div>
                `;
            }
            updateWalletUI();
        }

        // Evento para mostrar sugerencias al escribir "/"
        document.getElementById('queryInput').addEventListener('input', function(e) {
            if(!isCompetitiveMode || !gameActive) return;
            
            const val = this.value;
            const suggestions = document.getElementById('cmd-suggestions');
            
            if(val.startsWith('/')) {
                suggestions.style.display = 'flex';
                suggestions.innerHTML = '';
                
                Object.keys(SABOTAGE_DEFINITIONS).forEach(cmd => {
                    const isUsed = sabotageCmds[cmd];
                    const div = document.createElement('div');
                    div.className = `cmd-item ${isUsed ? 'used' : ''}`;
                    div.innerHTML = `<span>/${cmd}</span><span class="cmd-desc">${SABOTAGE_DEFINITIONS[cmd].desc}</span>`;
                    
                    if(!isUsed) {
                        div.onclick = () => {
                            triggerSabotage(cmd);
                        };
                    }
                    suggestions.appendChild(div);
                });
            } else {
                suggestions.style.display = 'none';
            }
        });

        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isTyping) {
                let rawValue = this.value.trim();
                
                // CHEQUEO DE COMANDO DE SABOTAJE
                if (isCompetitiveMode && rawValue.startsWith('/')) {
                    const cmd = rawValue.substring(1).toUpperCase();
                    if(SABOTAGE_DEFINITIONS[cmd]) {
                        triggerSabotage(cmd);
                        return;
                    }
                }

                if (!rawValue.startsWith('¿') || !rawValue.endsWith('?')) {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter("ERROR: SINTAXIS INVÁLIDA. FORMULE UNA PREGUNTA (¿...?)", "out", 10);
                    return;
                }

                const q = rawValue.toUpperCase();
                this.value = '';
                let checkFunc = null; 
                let validQuery = false;

                const hasWord = (word) => {
                    const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                    return new RegExp("(?:^|[\\s¿])" + escaped + "(?:$|[\\s?.,])").test(q);
                };

                const validateSyntax = (keyword, fullQuery) => {
                    if (new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + "\\s*\\?+$").test(fullQuery)) return true;
                    const validNextWords = ["ES", "TIENE", "USA", "LLEVA", "MIDE", "PESA", "ESTÁ", "ERA", "FUE", "DE", "EN", "EL", "LA", "CON", "POR", "QUE", "Y", "O"];
                    const escapedKw = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                    const contextRegex = new RegExp(`(?:^|[\\s¿])${escapedKw}\\s+(${validNextWords.join('|')})\\b`);
                    if (contextRegex.test(fullQuery)) return true;
                    return false;
                };

                if (hasWord("ACCESORIO") || hasWord("OBJETO")) {
                    validQuery = true;
                    if (hasWord("CABEZA") || hasWord("PELO")) checkFunc = p => p.accUbi === "CABEZA";
                    else if (hasWord("OJOS") || hasWord("CARA")) checkFunc = p => p.accUbi === "OJOS";
                    else if (hasWord("MANO") || hasWord("BRAZO")) checkFunc = p => p.accUbi === "MANO";
                    else {
                        const accList = ["GORRA", "CASCO", "SOMBRERO", "GAFAS", "MONÓCULO", "VISOR", "MALETÍN", "TABLETA", "RELOJ", "DIADEMA", "BOINA", "PASAMONTAÑAS", "PARCHE", "ANILLO", "GUANTE", "CELULAR", "BASTÓN"];
                        const found = accList.find(a => hasWord(a) && validateSyntax(a, q));
                        if(found) checkFunc = p => p.accName === found;
                        else validQuery = false;
                    }
                }
                // MODIFICADO: Lógica expandida para Norte/Sur América y nuevos países
                else if (q.match(/\b(EUROPA|EUROPEO|EUROPEA)\b/)) { checkFunc = p => p.cont === "EUROPA"; validQuery = true; }
                else if (q.match(/\b(ASIA|ASIÁTICO|ASIÁTICA)\b/)) { checkFunc = p => p.cont === "ASIA"; validQuery = true; }
                else if (q.match(/\b(NORTEAMÉRICA|NORTEAMERICANO|NORTEAMERICANA)\b/) || (hasWord("AMÉRICA") && hasWord("NORTE"))) { 
                    checkFunc = p => p.cont === "AMÉRICA DEL NORTE"; validQuery = true; 
                }
                else if (q.match(/\b(SUDAMÉRICA|SUDAMERICANO|SUDAMERICANA|SURAMÉRICA|SURAMERICANO)\b/) || (hasWord("AMÉRICA") && hasWord("SUR"))) { 
                    checkFunc = p => p.cont === "AMÉRICA DEL SUR"; validQuery = true; 
                }
                else if (q.match(/\b(AMÉRICA|AMERICANO|AMERICANA)\b/)) { 
                    // Si solo preguntan por América (general), incluye Norte y Sur
                    checkFunc = p => p.cont.includes("AMÉRICA"); validQuery = true; 
                }
                else if (q.match(/\b(OCEANÍA|OCEÁNICO|OCEÁNICA)\b/)) { checkFunc = p => p.cont === "OCEANÍA"; validQuery = true; }
                else if (q.match(/\b(ÁFRICA|AFRICANO|AFRICANA)\b/)) { checkFunc = p => p.cont === "ÁFRICA"; validQuery = true; }
                
                else {
                    const demonyms = {
                        "ALEMANIA": "ALEMÁN", "ESPAÑA": "ESPAÑOL", "FRANCIA": "FRANCÉS", "ITALIA": "ITALIANO", "SUIZA": "SUIZO", "RUSIA": "RUSO",
                        "CHINA": "CHINO", "JAPÓN": "JAPONÉS", "COREA": "COREANO", "INDIA": "INDIO", "TAILANDIA": "TAILANDÉS", "VIETNAM": "VIETNAMITA", 
                        
                        // AMÉRICA DEL NORTE
                        "MÉXICO": "MEXICANO", "USA": "AMERICANO", "EEUU": "AMERICANO", "ESTADOS UNIDOS": "AMERICANO", "CANADÁ": "CANADIENSE",
                        
                        // AMÉRICA DEL SUR
                        "BRASIL": "BRASILEÑO", "BOLIVIA": "BOLIVIANO", "COLOMBIA": "COLOMBIANO", "ECUADOR": "ECUATORIANO",
                        "PERÚ": "PERUANO", "ARGENTINA": "ARGENTINO", "CHILE": "CHILENO", "URUGUAY": "URUGUAYO", "VENEZUELA": "VENEZOLANO",
                        
                        "AUSTRALIA": "AUSTRALIANO", "NUEVA ZELANDA": "NEOZELANDÉS",
                        
                        // ÁFRICA
                        "EGIPTO": "EGIPCIO", "SUDAFRICA": "SUDAFRICANO", "NIGERIA": "NIGERIANO", "MARRUECOS": "MARROQUÍ",
                        "KENIA": "KENIANO", "SENEGAL": "SENEGALÉS", "GHANA": "GHANÉS", "ETIOPÍA": "ETÍOPE",
                        
                        // EUROPA EXTRA
                        "PORTUGAL": "PORTUGUÉS", "INGLATERRA": "INGLÉS", "SUECIA": "SUECO", "NORUEGA": "NORUEGO", "PAÍSES BAJOS": "HOLANDÉS"
                    };

                    const getFem = (word) => {
                        if (word.endsWith('O')) return word.slice(0, -1) + 'A';
                        if (word.endsWith('ÉS')) return word.slice(0, -2) + 'ESA';
                        if (word.endsWith('OL')) return word + 'A'; 
                        if (word.endsWith('ÁN')) return word.slice(0, -2) + 'ANA'; 
                        return word;
                    };

                    const foundCountry = DP.P.find(c => {
                        const demo = demonyms[c.n];
                        
                        // Check exact country name
                        if (hasWord(c.n) && validateSyntax(c.n, q)) return true;
                        
                        // Check logic for mapped demonyms/aliases
                        if (c.n === "USA") { // Special aliases for USA
                             if (hasWord("EEUU") || hasWord("ESTADOS UNIDOS")) return true;
                        }

                        if (demo && hasWord(demo) && validateSyntax(demo, q)) return true;
                        if (demo) {
                            const fem = getFem(demo);
                            if (fem !== demo && hasWord(fem) && validateSyntax(fem, q)) return true;
                        }
                        return false;
                    });

                    if (foundCountry) {
                        checkFunc = p => p.p === foundCountry.n;
                        validQuery = true;
                    } 
                    else if (hasWord("INICIAL") || hasWord("EMPIEZA")) {
                        const letra = q.match(/\b[A-Z]\b/); 
                        if (letra) { 
                            if (validateSyntax(letra[0], q)) {
                                checkFunc = p => p.n.startsWith(letra[0]); 
                                validQuery = true; 
                            } else {
                                validQuery = false; 
                            }
                        }
                        else { typeWriter("ESPECIFIQUE UNA LETRA.", "out", 10); return; }
                    }
                    else if (hasWord("EDAD") || hasWord("MIDE") || hasWord("ALTO")) {
                        const numMatch = q.match(/\d+(\.\d+)?/);
                        if (numMatch) {
                            validQuery = true;
                            const val = parseFloat(numMatch[0]);
                            const isAge = hasWord("EDAD");
                            if (hasWord("MAYOR") || hasWord("MÁS")) checkFunc = p => (isAge ? p.edad : parseFloat(p.altura)) > val;
                            else if (hasWord("MENOR") || hasWord("MENOS")) checkFunc = p => (isAge ? p.edad : parseFloat(p.altura)) < val;
                            else checkFunc = p => Math.abs((isAge ? p.edad : parseFloat(p.altura)) - val) < 0.05;
                        }
                    }
                    else if (q.match(/\b(HOMBRE|MASCULINO)\b/)) { checkFunc = p => p.g === "MASCULINO"; validQuery = true; }
                    else if (q.match(/\b(MUJER|FEMENINO)\b/)) { checkFunc = p => p.g === "FEMENINO"; validQuery = true; }
                    else {
                        const colors = ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"];
                        const skins = ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"];                                                                                    
                        
                        const cMatch = colors.find(c => hasWord(c) && validateSyntax(c, q));
                        const sMatch = skins.find(s => hasWord(s) && validateSyntax(s, q));
                        
                        if(cMatch) { checkFunc = p => p.o === cMatch; validQuery = true; }
                        else if(sMatch) { checkFunc = p => p.t === sMatch; validQuery = true; }
                    }
                }

                if (validQuery && checkFunc) {
                    playSFX('click');
                    document.getElementById('out').style.color = "var(--terminal-green)";
                    
                    const targetHasTrait = checkFunc(objetivo);
                    const respText = targetHasTrait ? "SÍ." : "NO.";
                    
                    pendingDiscards = personas.filter(p => {
                        const card = document.getElementById('card-' + p.n);
                        if (card.classList.contains('discarded')) return false; 
                        const suspectHasTrait = checkFunc(p);
                        return suspectHasTrait !== targetHasTrait; 
                    }).map(p => p.n);

                    currentBatchTotal = pendingDiscards.length;

                    lastQueryText = `CONSULTA: ${q}<br>RESPUESTA: ${respText}`;

                    let earned = 0;
                    let count = pendingDiscards.length;
                    if(count > 0) {
                        if(count >= 8) earned = 10;
                        else if(count >= 5) earned = 8;
                        else if(count >= 3) earned = 5;
                        else earned = count; 
                        pointsPool = earned;
                        lastQueryText += ` <span style="color:var(--gold)">[DETECTADOS: ${earned} PTS]</span>`;
                    }

                    if (pendingDiscards.length > 0) {
                        const msg = `${lastQueryText}<br><span style="color:var(--hazard)">BLOQUEO ACTIVO: ELIMINE A ${pendingDiscards.length} SOSPECHOSOS INCOMPATIBLES.</span>`;
                        typeWriter(msg, "out", 15);
                        document.getElementById('queryInput').disabled = true;
                        document.getElementById('queryInput').placeholder = "!! DESCARTE REQUERIDO !!";
                    } else {
                        typeWriter(`${lastQueryText}<br>NINGÚN DESCARTE DISPONIBLE CON ESTA INFORMACIÓN.`, "out", 15);
                        currentBatchTotal = 0; 
                    }

                } else {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter("DATOS NO RECONOCIDOS O AMBIGUOS.", "out", 10);
                }
            }
        });

        updateWalletUI();
    </script>
</body>
</html>