<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-BREACH: ONLINE PROTOCOL</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --gold: #ffd700;
            --dark-red: #8b0000;
            --bg-dark: #07070a;
            --terminal-green: #00ff41;
            --victory: #00ff88;
            --hazard: #ff4400;
            --ribbon-male: #0088ff;
            --ribbon-female: #ff0077;
            --disabled: #444;
            --cork-bg: #1a1510;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            margin: 0; padding: 10px;
            font-family: 'Consolas', monospace;
            color: #eee;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: contain;
        }

        /* --- EFECTOS VISUALES (PUNTOS) --- */
        .flying-point {
            position: fixed;
            color: var(--gold);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 6000;
            text-shadow: 0 0 5px var(--gold);
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
        }
        
        .point-impact {
            animation: impactShake 0.3s ease-in-out;
            color: #fff !important;
            text-shadow: 0 0 10px #fff !important;
        }

        @keyframes impactShake {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* --- PANTALLA DE INTERACCIÓN INICIAL --- */
        #interaction-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.8s ease, backdrop-filter 0.8s ease;
            cursor: pointer;
        }
        .interaction-text {
            color: var(--gold);
            font-size: 1.5rem;
            letter-spacing: 5px;
            text-transform: uppercase;
            animation: pulseText 2s infinite;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            pointer-events: none;
        }
        @keyframes pulseText { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- PANTALLA DE CARGA --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader-bar-container {
            width: 80%; max-width: 400px; height: 4px;
            background: #222; margin-top: 20px;
            border: 1px solid var(--gold);
        }
        .loader-bar {
            height: 100%; width: 0%;
            background: var(--gold);
            transition: width 0.1s linear;
        }
        .loading-text {
            color: var(--gold); font-size: 1.2rem; letter-spacing: 3px;
            animation: blink 0.8s infinite;
        }

        #wallet-display {
            position: absolute; top: 20px; right: 20px;
            border-left: 3px solid var(--gold); padding: 5px 15px;
            background: rgba(255, 215, 0, 0.05);
            text-align: right;
            z-index: 3100;
        }
        .currency { color: var(--gold); font-size: 1.2rem; font-weight: bold; }

        /* LOGIN SCREEN (NUEVO) */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
        }
        .login-box {
            border: 2px solid var(--gold); padding: 30px;
            background: #111; text-align: center; max-width: 400px; width: 100%;
        }
        .input-dark {
            background: #000; border: 1px solid #444; color: var(--gold);
            padding: 10px; font-family: 'Consolas', monospace; width: 100%;
            margin: 15px 0; font-size: 1.1rem; text-align: center; outline: none;
            text-transform: uppercase;
        }
        .input-dark:focus { border-color: var(--gold); }

        /* MAIN MENU */
        #main-menu {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
            transition: opacity 0.5s ease;
        }

        .menu-title {
            font-size: 3.5rem; color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            margin-bottom: 50px; text-align: center; letter-spacing: 5px;
            line-height: 1.2;
            padding: 0 20px;
        }

        .menu-buttons {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 400px; padding: 0 20px;
        }

        .btn-play {
            background: var(--dark-red); color: white; border: 2px solid #ff4400;
            padding: 20px 60px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            transition: all 0.2s; width: 100%;
        }

        .btn-exit {
            background: #222; color: #888; border: 2px solid #444;
            padding: 10px 40px; font-size: 1rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.2s;
        }
        .btn-exit:hover { background: #333; color: white; border-color: #666; }

        /* MODE SELECTION SCREEN (NUEVO) */
        #mode-selection {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3200;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 30px;
        }
        .mode-btn-container {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 300px;
        }
        .mode-img-placeholder {
            width: 100%; height: 100px; background: #222;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid #444; border-bottom: none;
            color: #666; font-size: 2rem;
        }
        .btn-mode {
            width: 100%; padding: 20px; font-size: 1.2rem;
            border: 2px solid var(--gold); background: #111; color: var(--gold);
            cursor: pointer; text-transform: uppercase; font-weight: bold;
        }
        .btn-mode:hover { background: var(--gold); color: #000; }

        /* LOBBY SCREEN (NUEVO) */
        #lobby-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #080808; z-index: 3300;
            display: none; flex-direction: column; align-items: center; padding-top: 50px;
        }
        .lobby-panel {
            width: 90%; max-width: 600px; background: #111; border: 1px solid var(--terminal-green);
            padding: 20px; text-align: center;
        }
        .player-list {
            min-height: 150px; background: #000; border: 1px solid #333;
            margin: 20px 0; padding: 10px; text-align: left;
        }
        .player-item {
            padding: 10px; border-bottom: 1px solid #222; display: flex; justify-content: space-between;
        }
        .player-item.ready { color: var(--terminal-green); }
        .room-code {
            font-size: 3rem; color: var(--gold); letter-spacing: 10px; font-weight: bold;
            margin: 20px 0; border: 2px dashed #444; padding: 10px;
        }

        /* CONFIGURACIÓN Y MODALES */
        #settings-modal, #tutorial-screen, #abort-confirm, #overlay, #migration-modal, #comp-results-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 4000; padding: 20px;
        }
        
        #settings-modal { z-index: 3500; }
        #migration-modal { z-index: 4500; }
        #overlay, #abort-confirm { background: rgba(0, 0, 0, 0.95); z-index: 2000; text-align: center; }
        #overlay.active, #abort-confirm.active { display: flex; opacity: 1; }

        .tutorial-box {
            width: 100%;
            max-width: 500px; 
            border: 1px solid var(--gold);
            padding: 25px; 
            background: #0a0a0a; 
            text-align: center;
            max-height: 85vh; 
            overflow-y: auto; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .tutorial-box::-webkit-scrollbar { width: 6px; }
        .tutorial-box::-webkit-scrollbar-thumb { background: var(--dark-red); }

        .mosaic-options { display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap; justify-content: center;}
        .mosaic-btn {
            background: #111; border: 1px solid #444; color: #888;
            padding: 15px 25px; cursor: pointer; font-family: 'Consolas', monospace;
        }
        .mosaic-btn.active { border-color: var(--gold); color: var(--gold); background: #221a00; }

        .step { margin-bottom: 20px; text-align: left; border-left: 2px solid var(--dark-red); padding-left: 15px; }
        .step b { color: var(--gold); display: block; margin-bottom: 5px; }

        /* --- MURO DE CRIMINALES --- */
        #archives-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cork-bg);
            background-image: radial-gradient(#2a2018 1px, transparent 1px);
            background-size: 10px 10px;
            display: none; flex-direction: column;
            align-items: center;
            z-index: 3500;
            padding-top: 90px;
            overflow-y: auto;
        }

        .wall-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(10, 5, 0, 0.98);
            border-bottom: 2px solid var(--dark-red);
            padding: 15px; text-align: center;
            z-index: 3600; box-shadow: 0 5px 20px #000;
        }
        .wall-title-text {
            color: var(--gold); font-size: 1.5rem; letter-spacing: 4px; 
            text-transform: uppercase; font-weight: bold;
        }

        .wall-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;
            width: 100%; max-width: 1200px;
            padding: 20px; padding-bottom: 100px;
        }

        .wall-card {
            width: 150px; min-height: 210px;
            background: #e0e0e0; color: #111;
            padding: 8px 8px 25px 8px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            position: relative;
            transform-origin: center top;
            transition: transform 0.2s, z-index 0.2s;
            cursor: default;
        }
        .wall-card:hover { transform: scale(1.2) rotate(0deg) !important; z-index: 999; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }

        .pin {
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--dark-red); border: 1px solid #300;
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            box-shadow: 1px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .pin.gold { background: var(--gold); border-color: #886600; box-shadow: 0 0 5px var(--gold); }
        .pin.blue { background: #0088ff; border-color: #003366; box-shadow: 0 0 5px #0088ff; }

        .mugshot-zone {
            width: 100%; height: 90px;
            background: #222; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #999;
        }
        .mugshot-icon { font-size: 2rem; color: #555; }
        
        .wall-info { font-family: 'Courier New', monospace; font-size: 0.55rem; line-height: 1.3; text-align: left; }
        .wall-info b { color: #000; font-weight: 800; }
        
        .stamp-solved {
            position: absolute; bottom: 10px; right: 5px;
            border: 2px solid var(--dark-red); color: var(--dark-red);
            font-size: 0.7rem; font-weight: bold; padding: 2px 4px;
            transform: rotate(-15deg); opacity: 0.7;
        }

        .btn-back-wall {
            position: fixed; bottom: 20px; 
            background: #000; border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 30px; cursor: pointer; z-index: 3600;
            font-weight: bold; text-transform: uppercase;
        }
        .btn-back-wall:hover { background: var(--gold); color: #000; }

        /* --- DOSSIER DE MISIÓN --- */
        .dossier-container {
            border: 2px solid var(--victory);
            background: rgba(0, 50, 20, 0.3);
            padding: 20px; margin: 20px 0; text-align: left;
            width: 100%; max-width: 400px;
            font-family: 'Courier New', monospace;
        }
        .dossier-header {
            border-bottom: 1px dashed var(--victory); margin-bottom: 10px;
            padding-bottom: 5px; color: var(--victory);
            font-weight: bold; display: flex; justify-content: space-between;
        }
        .dossier-info p { margin: 5px 0; font-size: 0.85rem; color: #ddd; }
        .dossier-info b { color: var(--gold); }
        .stamp-captured {
            color: var(--victory); border: 2px solid var(--victory);
            padding: 5px 10px; font-weight: bold;
            transform: rotate(-5deg); display: inline-block;
            margin-top: 10px; font-size: 1.2rem;
        }

        /* --- INTERFAZ PRINCIPAL --- */
        .machine-body {
            background: linear-gradient(145deg, #1a1a1a, #000);
            width: 100%; max-width: 900px; padding: 20px;
            border: 2px solid #333; border-radius: 12px; display: none;
            margin-bottom: 0px; 
            flex-grow: 1; 
            display: flex; flex-direction: column;
            max-height: calc(100vh - 20px); 
        }
        .machine-body[style*="display: none"] { display: none !important; } 
        .machine-body[style*="display: block"] { display: flex !important; }

        .blur-effect { filter: blur(15px) grayscale(1); transition: filter 0.4s; }

        /* --- BOARD GRID SYSTEM --- */
        .board-grid {
            display: grid; gap: 8px; margin-bottom: 10px; 
            transition: all 0.3s; width: 100%;
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        .board-grid::-webkit-scrollbar { width: 8px; background: #111; }
        .board-grid::-webkit-scrollbar-thumb { background: var(--dark-red); border-radius: 4px; }

        /* CONFIGURACIÓN 5x5 */
        .board-grid.mode-5 {
            grid-template-columns: repeat(5, 1fr);
            min-height: 200px; 
        }
        .board-grid.mode-5 .suspect-card { height: auto; aspect-ratio: 3/4; }
        .board-grid.mode-5 .card-body { font-size: 0.4rem; line-height: 1.2; }
        .board-grid.mode-5 .suspect-card.discarded {
            transform: scale(0.8); opacity: 0.1; 
            pointer-events: none; filter: grayscale(1);
        }

        /* CONFIGURACIÓN 3x3 */
        .board-grid.mode-3 {
            grid-template-columns: repeat(3, 1fr);
            gap: 10px; padding-right: 5px;
        }
        .board-grid.mode-3 .suspect-card { height: auto; min-height: 140px; }
        .board-grid.mode-3 .card-header { font-size: 0.9rem; margin-bottom: 6px; }
        .board-grid.mode-3 .card-body { font-size: 0.65rem; line-height: 1.4; }
        .board-grid.mode-3 .suspect-card.discarded { display: none; }

        /* CONFIGURACIÓN 2x2 */
        .board-grid.mode-2 {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px; padding-right: 5px;
        }
        .board-grid.mode-2 .suspect-card { height: auto; min-height: 180px; }
        .board-grid.mode-2 .card-header { font-size: 1.2rem; margin-bottom: 10px; }
        .board-grid.mode-2 .card-body { font-size: 0.8rem; line-height: 1.5; }
        .board-grid.mode-2 .suspect-card.discarded { display: none; }

        /* --- TARJETAS --- */
        .suspect-card {
            background: #111; border: 1px solid #444; border-radius: 4px;
            padding: 8px 4px 4px 4px; cursor: pointer;
            transition: all 0.3s ease; position: relative;
            box-sizing: border-box; overflow: hidden; width: 100%;
            display: flex; flex-direction: column;
        }
        .suspect-card.target-glow {
            border-color: var(--hazard);
            box-shadow: 0 0 10px var(--hazard);
        }

        .gender-ribbon { position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        .ribbon-male { background: var(--ribbon-male); }
        .ribbon-female { background: var(--ribbon-female); }

        .card-header { font-size: 0.65rem; font-weight: bold; color: var(--gold); border-bottom: 1px solid #333; margin-bottom: 4px; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex-shrink: 0;}
        .card-body { color: #aaa; word-wrap: break-word; flex-grow: 1;}

        .terminal-zone { background: #000; border: 1px solid #222; padding: 10px; border-radius: 5px; margin-top: auto; flex-shrink: 0; }
        
        #queryInput { 
            width: 100%; background: transparent; border: none; 
            border-bottom: 1px solid var(--terminal-green); 
            color: #fff; padding: 5px; font-family: 'Consolas', monospace; outline: none; font-size: 16px; 
        }
        #queryInput:disabled {
            border-bottom: 1px dashed #444; color: #444; cursor: not-allowed;
        }

        .output { color: var(--terminal-green); font-size: 0.7rem; min-height: 50px; margin-top: 5px; line-height: 1.3; }
        
        .btn-main { width: 100%; padding: 12px; background: var(--dark-red); color: white; border: 1px solid #ff4400; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-abort { background: #222; border-color: #444; margin-top: 10px; font-size: 0.8rem; padding: 10px; }
        .btn-abort:hover { background: #440000; border-color: var(--hazard); }
        
        .btn-mini { 
            background: #222; color: var(--gold); border: 1px solid var(--gold); 
            padding: 4px 10px; font-size: 0.7rem; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s;
        }
        .btn-mini:hover { background: var(--gold); color: #000; }

        #case-info-bar { display: flex; justify-content: space-between; align-items: center; color: var(--gold); margin-bottom: 10px; font-size: 0.75rem; border-bottom: 1px solid #222; padding-bottom: 5px; flex-shrink: 0; }

        #preload-status {
            position: fixed; bottom: 10px; left: 10px;
            font-size: 0.6rem; color: #444;
        }

        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* RESPONSIVIDAD */
        @media (max-height: 600px) {
             .menu-title { font-size: 2rem; margin-bottom: 20px; }
             .machine-body { padding: 10px; border: none; }
             #wallet-display { top: 5px; right: 5px; }
        }

        @media (max-width: 768px) {
            body { padding: 0; }
            .machine-body { padding: 10px; max-width: 100%; border-radius: 0; border: none; height: 100vh; max-height: 100vh; }
            .menu-title { font-size: 2.5rem; }
            .btn-play { padding: 15px 30px; font-size: 1.2rem; }
            
            .board-grid.mode-5 { gap: 4px; }
            .board-grid.mode-5 .suspect-card { padding: 2px; }
            .board-grid.mode-5 .card-body { font-size: 0.35rem; }
        }

        @media (max-width: 480px) {
            .menu-title { font-size: 1.8rem; letter-spacing: 2px; }
            #wallet-display { top: 10px; right: 10px; padding: 2px 8px; }
            .currency { font-size: 1rem; }
            
            .board-grid.mode-5 { gap: 3px; }
            .board-grid.mode-5 .card-header { font-size: 0.5rem; margin-bottom: 2px; padding-top: 2px; }
            .board-grid.mode-5 .card-body { font-size: 0.3rem; line-height: 1.1; letter-spacing: -0.2px; }
            
            .board-grid.mode-3 { gap: 6px; }
            .board-grid.mode-3 .suspect-card { min-height: 120px; }
            .board-grid.mode-3 .card-body { font-size: 0.55rem; }
            
            .board-grid.mode-2 { gap: 8px; }
            .board-grid.mode-2 .suspect-card { min-height: 150px; }
            .board-grid.mode-2 .card-body { font-size: 0.7rem; }
            
            .terminal-zone { padding: 8px; }
            #queryInput { font-size: 0.9rem; }
            .btn-main { padding: 10px; font-size: 0.9rem; }
            #case-info-bar { flex-direction: row; gap: 5px; font-size: 0.65rem; }
        }
    </style>
</head>
<body>

    <div id="interaction-overlay" onclick="initAudioSystem()">
        <div class="interaction-text">TOCAR PARA INICIAR SISTEMA</div>
    </div>

    <div id="login-screen">
        <h2 style="color: var(--gold); letter-spacing: 3px;">IDENTIFICACIÓN REQUERIDA</h2>
        <div class="login-box">
            <p>INTRODUZCA NOMBRE DE AGENTE</p>
            <input type="text" id="agent-name-input" class="input-dark" maxlength="12" placeholder="NOMBRE">
            <button class="btn-main" onclick="registerAgent()">ACCEDER</button>
            <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">ID ÚNICA SERÁ ASIGNADA AUTOMÁTICAMENTE</p>
        </div>
    </div>

    <div id="loading-screen">
        <div class="loading-text">RECALIBRANDO SISTEMA...</div>
        <div class="loader-bar-container">
            <div id="loader-progress" class="loader-bar"></div>
        </div>
    </div>

    <div id="archives-screen">
        <div class="wall-header">
            <div class="wall-title-text">CRIMINALES ATRAPADOS</div>
            <div style="font-size: 0.7rem; color: #888;">REGISTRO DE OPERACIONES EXITOSAS</div>
        </div>
        <div id="wall-container" class="wall-grid">
            </div>
        <button class="btn-back-wall" onclick="closeArchives()">VOLVER AL MENÚ</button>
    </div>

    <div id="main-menu">
        <div id="wallet-display">
            <div style="font-size: 0.6rem; color: #666;">SALDO NETO</div>
            <div class="currency"><span id="total-money">0</span> S/</div>
            <div style="font-size: 0.6rem; color: var(--terminal-green); margin-top: 5px;" id="agent-display">AGENTE: ???</div>
        </div>
        <h1 class="menu-title">BIO-BREACH<br><span style="font-size: 1.2rem; color: #555;">SISTEMA DE RASTREO V8</span></h1>
        <div class="menu-buttons">
            <button class="btn-play" onclick="openModeSelection()">INICIAR OPERACIÓN</button>
            <button class="btn-exit" onclick="openArchives()">ARCHIVOS (MURO)</button>
            <button class="btn-exit" onclick="openSettings()">CONFIGURACIÓN</button>
            <button class="btn-exit" onclick="exitGame()">SALIR DEL SISTEMA</button>
        </div>
        <div id="preload-status">SISTEMA: EN LÍNEA</div>
    </div>

    <div id="mode-selection">
        <h2 style="color: white;">SELECCIONE PROTOCOLO</h2>
        
        <div class="mode-btn-container">
            <div class="mode-img-placeholder">?</div>
            <button class="btn-mode" onclick="startClassicMode()">MODO CLÁSICO</button>
        </div>

        <div class="mode-btn-container">
            <div class="mode-img-placeholder">?</div>
            <button class="btn-mode" onclick="openLobby()">MODO COMPETITIVO</button>
        </div>
        
        <button class="btn-exit" style="margin-top: 20px;" onclick="closeModeSelection()">CANCELAR</button>
    </div>

    <div id="lobby-screen">
        <h2 style="color: var(--gold);">SERVIDOR DE ENLACE</h2>
        <div class="lobby-panel" id="lobby-start">
            <button class="btn-main" onclick="hostRoom()">CREAR SALA (HOST)</button>
            <p>- O -</p>
            <input type="text" id="room-code-input" class="input-dark" maxlength="4" placeholder="CÓDIGO DE 4 DÍGITOS">
            <button class="btn-main" onclick="joinRoom()">UNIRSE A SALA</button>
            <button class="btn-exit" style="margin-top: 20px;" onclick="closeLobby()">VOLVER</button>
        </div>

        <div class="lobby-panel" id="lobby-active" style="display:none;">
            <div style="font-size: 0.8rem; color: #888;">CÓDIGO DE SALA:</div>
            <div class="room-code" id="display-room-code">----</div>
            <div class="player-list" id="player-list-container">
                </div>
            <div id="host-controls" style="display:none;">
                <button class="btn-main" id="btn-start-comp" onclick="requestStartGame()" disabled>INICIAR COMPETENCIA (MIN 2)</button>
            </div>
            <div id="client-msg" style="display:none; color: var(--gold); margin-top: 10px;">ESPERANDO AL HOST...</div>
            <button class="btn-exit" style="margin-top: 10px;" onclick="leaveLobby()">ABANDONAR</button>
        </div>
    </div>

    <div id="comp-results-screen">
        <div class="tutorial-box">
            <h2 style="color: var(--gold);">REPORTE DE RONDA</h2>
            <div id="comp-results-list" style="text-align: left; margin: 20px 0;"></div>
            <div id="next-round-timer" style="color: var(--terminal-green); font-size: 1.2rem;"></div>
            <button class="btn-main" id="btn-return-lobby" style="display:none;" onclick="returnToLobbyFromGame()">VOLVER AL LOBBY</button>
        </div>
    </div>

    <div id="migration-modal">
        <div class="tutorial-box" style="border-color: var(--gold);">
            <h2 style="color: var(--gold); text-shadow: 0 0 10px rgba(0,255,65,0.4);">REPORTE DE SISTEMA</h2>
            <p style="color: #eee; font-size: 0.9rem; margin-bottom: 20px;">ACTUALIZACIÓN CRÍTICA DETECTADA</p>
            <div class="step" style="border-left-color: var(--terminal-green);">
                <b>ESTADO DE BASE DE DATOS:</b>
                <span style="color: #aaa;">HISTORIAL PURGADO POR ACTUALIZACIÓN A V8.</span>
            </div>
            <button class="btn-main" onclick="closeMigrationModal()" style="background: #222; border-color: var(--gold); color: var(--gold);">CONFIRMAR RECEPCIÓN</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="tutorial-box">
            <h2 style="color: var(--gold);">CONFIGURACIÓN DE MOSAICO</h2>
            <p style="color:#aaa; font-size: 0.8rem;">Seleccione la densidad de visualización de objetivos.</p>
            <div class="mosaic-options">
                <button class="mosaic-btn" id="btn-mode-2" onclick="selectMosaic(2)">2x2</button>
                <button class="mosaic-btn" id="btn-mode-3" onclick="selectMosaic(3)">3x3</button>
                <button class="mosaic-btn active" id="btn-mode-5" onclick="selectMosaic(5)">5x5</button>
            </div>
            <p id="mosaic-desc" style="font-size: 0.7rem; color: var(--terminal-green); min-height: 20px;">ESTÁNDAR: Vista completa, sin deslizamiento.</p>
            <button class="btn-main" onclick="saveSettings()">CONFIRMAR</button>
        </div>
    </div>

    <div id="tutorial-screen">
        <div class="tutorial-box">
            <h2 style="color: var(--gold); margin-top: 0;">MANUAL DE CAMPO <span id="manual-subtitle"></span></h2>
            <div class="step">
                <b>1. INTERROGATORIO PRECISO</b>
                Formule las preguntas correctamente usando signos (¿...?). Ejemplo: "¿Es de España?".
            </div>
            <div class="step">
                <b>2. DESCARTE OBLIGATORIO</b>
                El sistema bloqueará nuevos comandos hasta que elimines a TODOS los sospechosos que creas incorrectos.
            </div>
            <div class="step" id="manual-step-3">
                <b>3. SISTEMA DE PUNTOS</b>
                Eliminar múltiples sospechosos con una sola pregunta otorga puntos extra.
            </div>
             <div class="step" id="manual-step-4">
                <b>4. OBJETIVO ÚNICO</b>
                La misión termina cuando descubres al culpable. Si lo descartas por error, pierdes el contrato.
            </div>
            <button class="btn-main" onclick="startGame()">ENTENDIDO</button>
        </div>
    </div>

    <div id="abort-confirm">
        <div class="tutorial-box">
            <h2 style="color: var(--hazard);">¿ESTÁS SEGURO?</h2>
            <p>Perderás el monto de <span id="penalty-amount" style="color:var(--gold)">0</span> S/ del contrato actual.</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-main" style="background:var(--hazard); width: auto;" onclick="confirmAbort()">ESTOY SEGURO</button>
                <button class="btn-main" style="background:#333; width: auto;" onclick="closeAbortModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="overlay-title"></h1>
        <div id="overlay-desc" style="width: 100%; display: flex; justify-content: center;"></div>
        <p id="overlay-reward-msg"></p>
        <button class="btn-main" style="width: 250px;" onclick="initGame()">SIGUIENTE CASO</button>
    </div>

    <div class="machine-body" id="main-ui">
        <div id="case-info-bar">
            <span id="case-id-display">CASO #----</span>
            <span id="game-points" style="color: var(--terminal-green)">PTS: 0</span>
            <button class="btn-mini" id="new-case-btn" onclick="initGame()">NUEVO CASO</button>
            <span style="color: var(--victory)">RECOMPENSA: <span id="case-reward-display">0</span> S/</span>
        </div>
        <div class="board-grid mode-5" id="board"></div>
        
        <div class="terminal-zone">
            <input type="text" id="queryInput" autocomplete="off" placeholder="INTERROGAR SISTEMA (¿...?)...">
            <div class="output" id="out">> AGUARDANDO COMANDOS...</div>
        </div>
        <button class="btn-main btn-abort" onclick="openAbortModal()">ABORTAR CASO</button>
    </div>

    <script>
        // ==========================================
        // === MOTOR DE AUDIO: JAZZ NOIR INTEGRADO ===
        // ==========================================
        let actx, musicMaster, limiter, reverbNode, warmDistortion;
        let isMusicRunning = false;
        let musicTimerID;
        let nextNoteTime = 0;
        let musicBeat = 0;
        let musicMode = 1; 
        let currentTempo = 80;
        
        const CHORDS = {
            cm11_L: [130.81, 196.00, 293.66], cm11_R: [311.13, 466.16, 698.46], 
            ab_L: [103.83, 155.56, 233.08], ab_R: [311.13, 415.30, 622.25], 
            g7_L: [98.00, 146.83, 233.08], g7_R: [311.13, 415.30, 587.33],
            f_maj_L: [87.31, 130.81, 174.61], f_maj_R: [349.23, 440.00, 523.25],
            dm_L: [73.42, 110.00, 146.83], dm_R: [293.66, 349.23, 440.00],
            doom_cluster_L: [65.41, 77.78, 92.50], doom_cluster_R: [155.56, 185.00, 220.00],
            taxi_stab_L: [146.83, 185.00, 233.08], taxi_stab_R: [369.99, 440.00, 523.25],
            f_min_L: [87.31, 103.83, 130.81], f_min_R: [174.61, 207.65, 261.63],
            eb_maj7_L: [155.56, 196.00, 233.08], eb_maj7_R: [311.13, 392.00, 466.16],
            d7alt_L: [146.83, 185.00, 246.94], d7alt_R: [293.66, 369.99, 440.00]
        };

        const SCALES = {
            dorian_sharp4: [196.00, 220.00, 233.08, 277.18, 293.66, 329.63, 369.99],
            blues_min: [196.00, 233.08, 261.63, 277.18, 293.66, 349.23], 
            lydian: [261.63, 329.63, 369.99, 392.00, 440.00], 
            mystery_dim: [65.41, 77.78, 92.50, 110.00, 130.81], 
            urban_penta: [196.00, 233.08, 261.63, 293.66, 349.23], 
            noir_theme: [196.00, 207.65, 233.08, 261.63, 293.66],
            taxi_extended: [196.00, 233.08, 261.63, 293.66, 311.13, 349.23, 392.00, 466.16]
        };

        async function initAudioSystem() {
            const overlay = document.getElementById('interaction-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 800);

            // Verificar Login
            checkLoginStatus();

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            actx = new AudioContext({ latencyHint: 'playback' });
            await actx.resume();

            limiter = actx.createDynamicsCompressor();
            limiter.threshold.value = -8;
            limiter.knee.value = 30;
            limiter.ratio.value = 12;
            
            musicMaster = actx.createGain();
            musicMaster.gain.value = 0.6; 

            warmDistortion = actx.createWaveShaper();
            warmDistortion.curve = makeDistortionCurve(10); 
            warmDistortion.oversample = '4x';

            limiter.connect(musicMaster);
            musicMaster.connect(actx.destination);

            createReverb();
            startAtmosphere(); 
            
            isMusicRunning = true;
            nextNoteTime = actx.currentTime + 0.1;
            scheduler();
            fadeToMode(1); 
        }

        function makeDistortionCurve(amount) {
            const k = typeof amount === 'number' ? amount : 50, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                let x = i * 2 / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function createReverb() {
            const len = 3 * actx.sampleRate;
            const buffer = actx.createBuffer(2, len, actx.sampleRate);
            for (let i = 0; i < len; i++) {
                const decay = Math.pow(1 - i / len, 3);
                buffer.getChannelData(0)[i] = (Math.random() * 2 - 1) * decay * 0.5;
                buffer.getChannelData(1)[i] = (Math.random() * 2 - 1) * decay * 0.5;
            }
            reverbNode = actx.createConvolver();
            reverbNode.buffer = buffer;
            const revGain = actx.createGain();
            revGain.gain.value = 0.35; 
            reverbNode.connect(revGain);
            revGain.connect(limiter);
        }

        function fadeToMode(newMode) {
            if (!isMusicRunning) return;
            const t = actx.currentTime;
            musicMaster.gain.cancelScheduledValues(t);
            musicMaster.gain.setTargetAtTime(0, t, 0.1); 

            setTimeout(() => {
                setMusicModeData(newMode);
                musicMaster.gain.setTargetAtTime(0.55, actx.currentTime, 0.2); 
            }, 300);
        }
        
        function silenceMusic() {
            if (!actx) return;
            const t = actx.currentTime;
            musicMaster.gain.cancelScheduledValues(t);
            musicMaster.gain.setTargetAtTime(0, t, 0.05); 
        }

        function restoreMusic() {
            if (!actx) return;
            setMusicModeData(3);
            const t = actx.currentTime;
            musicMaster.gain.cancelScheduledValues(t);
            musicMaster.gain.setTargetAtTime(0.55, t, 0.5);
        }

        function setMusicModeData(m) {
            musicMode = m;
            musicBeat = 0; 
            const tempos = [95, 80, 60, 105]; 
            currentTempo = tempos[m];
        }

        function playSax(note, duration, technique = 'normal') {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            const carrier = actx.createOscillator(); carrier.type = 'sawtooth'; carrier.frequency.value = note;
            const modulator = actx.createOscillator(); modulator.type = 'sine'; modulator.frequency.value = note; 
            const modGain = actx.createGain(); modGain.gain.value = note * 0.8; 
            modulator.connect(modGain); modGain.connect(carrier.frequency); 
            const dynFilter = actx.createBiquadFilter(); dynFilter.type = 'lowpass'; dynFilter.Q.value = 1.5; 
            const bodyFilter = actx.createBiquadFilter(); bodyFilter.type = 'peaking'; bodyFilter.frequency.value = 900; 
            bodyFilter.gain.value = 8; bodyFilter.Q.value = 1.0;
            const noiseBufferSize = actx.sampleRate * 0.5; const noiseBuffer = actx.createBuffer(1, noiseBufferSize, actx.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0); for (let i = 0; i < noiseBufferSize; i++) noiseData[i] = Math.random() * 2 - 1;
            const breathSrc = actx.createBufferSource(); breathSrc.buffer = noiseBuffer; breathSrc.loop = true;
            const breathFilter = actx.createBiquadFilter(); breathFilter.type = 'bandpass'; breathFilter.frequency.value = note * 4; breathFilter.Q.value = 0.5;
            const breathGain = actx.createGain(); breathGain.gain.value = 0.03; 
            const masterGain = actx.createGain();
            masterGain.gain.setValueAtTime(0, t);
            masterGain.gain.linearRampToValueAtTime(0.5, t + 0.1); 
            masterGain.gain.exponentialRampToValueAtTime(0.3, t + duration * 0.6); 
            masterGain.gain.exponentialRampToValueAtTime(0.001, t + duration);
            dynFilter.frequency.setValueAtTime(note, t);
            dynFilter.frequency.exponentialRampToValueAtTime(note * 4, t + 0.15); 
            dynFilter.frequency.linearRampToValueAtTime(note * 2, t + duration);
            carrier.connect(dynFilter); breathSrc.connect(breathFilter); breathFilter.connect(breathGain); breathGain.connect(dynFilter); 
            dynFilter.connect(bodyFilter); bodyFilter.connect(masterGain); masterGain.connect(warmDistortion); 
            warmDistortion.connect(limiter); warmDistortion.connect(reverbNode);
            const vib = actx.createOscillator(); vib.frequency.value = 4.0;
            const vibGain = actx.createGain(); vibGain.gain.value = 0;
            vibGain.gain.setValueAtTime(0, t); vibGain.gain.linearRampToValueAtTime(note * 0.015, t + 0.6); 
            vib.connect(vibGain); vibGain.connect(carrier.frequency);
            carrier.start(t); modulator.start(t); breathSrc.start(t); vib.start(t);
            carrier.stop(t + duration); modulator.stop(t + duration); breathSrc.stop(t + duration); vib.stop(t + duration);
        }

        function playChord(chordName, duration, arpeggioSpeed = 0.02) {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            const freqs = [...CHORDS[chordName + "_L"], ...CHORDS[chordName + "_R"]];
            const lfo = actx.createOscillator(); lfo.frequency.value = 4.5; 
            const lfoGain = actx.createGain(); lfoGain.gain.value = 0.25; 
            const tremoloMaster = actx.createGain(); tremoloMaster.gain.value = 1; 
            lfo.connect(lfoGain); lfoGain.connect(tremoloMaster.gain); lfo.start(t); lfo.stop(t+duration);
            freqs.forEach((f, i) => {
                const osc = actx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = f;
                const oscSub = actx.createOscillator(); oscSub.type = 'triangle'; oscSub.frequency.value = f;
                const oscGain = actx.createGain(); oscGain.gain.value = 0.4;
                const subGain = actx.createGain(); subGain.gain.value = 0.8; 
                const deepSub = actx.createOscillator(); deepSub.type = 'sine'; deepSub.frequency.value = 50; 
                const deepGain = actx.createGain(); deepGain.gain.setValueAtTime(0.5, t + (i*arpeggioSpeed));
                deepGain.gain.exponentialRampToValueAtTime(0.001, t + (i*arpeggioSpeed) + 0.15); 
                osc.connect(oscGain); oscSub.connect(subGain);
                const filter = actx.createBiquadFilter(); filter.type = 'lowpass';
                filter.frequency.setValueAtTime(f * 3, t + (i*arpeggioSpeed));
                filter.frequency.exponentialRampToValueAtTime(f * 0.5, t + (i*arpeggioSpeed) + 0.3); 
                const noiseLen = 0.03; const noiseBuff = actx.createBuffer(1, actx.sampleRate * noiseLen, actx.sampleRate);
                const nData = noiseBuff.getChannelData(0); for(let k=0; k<nData.length; k++) nData[k] = (Math.random()*2-1);
                const hammer = actx.createBufferSource(); hammer.buffer = noiseBuff;
                const hammerFilter = actx.createBiquadFilter(); hammerFilter.type = 'lowpass'; hammerFilter.frequency.value = 600; 
                const hammerGain = actx.createGain(); hammerGain.gain.value = 0.4; 
                const env = actx.createGain(); const startT = t + (i * arpeggioSpeed);
                env.gain.setValueAtTime(0, t); env.gain.linearRampToValueAtTime(0.3, startT + 0.01); 
                env.gain.exponentialRampToValueAtTime(0.1, startT + 0.5); env.gain.exponentialRampToValueAtTime(0.001, startT + duration);
                oscGain.connect(filter); subGain.connect(filter); filter.connect(env);
                hammer.connect(hammerFilter); hammerFilter.connect(hammerGain); hammerGain.connect(env);
                deepSub.connect(deepGain); deepGain.connect(tremoloMaster); env.connect(tremoloMaster);
                osc.start(startT); osc.stop(startT + duration); oscSub.start(startT); oscSub.stop(startT + duration);
                hammer.start(startT); deepSub.start(startT); deepSub.stop(startT + 0.2);
            });
            tremoloMaster.connect(limiter); tremoloMaster.connect(reverbNode);
        }

        function playBass(note, duration) {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            const osc = actx.createOscillator(); osc.type = 'triangle'; osc.frequency.value = note;
            const filter = actx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 220; 
            const env = actx.createGain();
            env.gain.setValueAtTime(0, t);
            env.gain.linearRampToValueAtTime(0.7, t + 0.03); 
            env.gain.exponentialRampToValueAtTime(0.01, t + duration);
            osc.connect(filter); filter.connect(env); env.connect(limiter);
            osc.start(t); osc.stop(t + duration);
        }

        function playDrum(type) {
            if(!isMusicRunning) return;
            const t = actx.currentTime;
            if (type === 'kick') {
                const osc = actx.createOscillator(); osc.frequency.setValueAtTime(120, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                const gain = actx.createGain(); gain.gain.setValueAtTime(0.8, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                osc.connect(gain); gain.connect(limiter); osc.start(t); osc.stop(t + 0.5);
            }
            else if (type === 'snare') { 
                const bufferSize = actx.sampleRate * 0.1; const buffer = actx.createBuffer(1, bufferSize, actx.sampleRate);
                const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = actx.createBufferSource(); noise.buffer = buffer;
                const filt = actx.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 2000;
                const gain = actx.createGain(); gain.gain.setValueAtTime(0.4, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                noise.connect(filt); filt.connect(gain); gain.connect(musicMaster); noise.start(t);
            }
            else if (type === 'ride') {
                const bufferSize = actx.sampleRate * 0.5; 
                const buffer = actx.createBuffer(1, bufferSize, actx.sampleRate);
                const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = actx.createBufferSource(); noise.buffer = buffer;
                const filt = actx.createBiquadFilter(); filt.type = 'highpass'; filt.frequency.value = 6000;
                const gain = actx.createGain(); 
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.25, t + 0.02); 
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4); 
                noise.connect(filt); filt.connect(gain); gain.connect(musicMaster); noise.start(t);
            }
        }

        function startAtmosphere() {
            const t = actx.currentTime;
            const buffSize = actx.sampleRate * 2; const b = actx.createBuffer(1, buffSize, actx.sampleRate);
            const d = b.getChannelData(0); let lastOut = 0;
            for(let i=0; i<buffSize; i++) {
                const white = Math.random()*2-1; d[i] = (lastOut + (0.02*white)) / 1.02; lastOut = d[i]; d[i] *= 3.5;
            }
            const noise = actx.createBufferSource(); noise.buffer = b; noise.loop = true;
            const filter = actx.createBiquadFilter(); filter.type = 'bandpass'; filter.frequency.value = 1000; filter.Q.value = 1;
            const lfo = actx.createOscillator(); lfo.frequency.value = 0.5; 
            const lfoGain = actx.createGain(); lfoGain.gain.value = 0.05;
            const masterG = actx.createGain(); masterG.gain.value = 0.04; 
            noise.connect(filter); filter.connect(masterG); lfo.connect(lfoGain); lfoGain.connect(masterG.gain);
            masterG.connect(musicMaster); noise.start(t); lfo.start(t);
        }

        function scheduler() {
            if(!isMusicRunning) return;
            const lookahead = 25.0; const scheduleAheadTime = 0.1;
            while (nextNoteTime < actx.currentTime + scheduleAheadTime) {
                runPattern(nextNoteTime, musicBeat);
                const secondsPerBeat = 60.0 / currentTempo;
                nextNoteTime += secondsPerBeat;
                musicBeat++;
            }
            musicTimerID = setTimeout(scheduler, lookahead);
        }

        function runPattern(t, b) {
            if (musicMode === 0) {
                const bassNotes = [32.70, 38.89, 43.65, 46.25]; 
                playBass(bassNotes[b % 4], 0.6); 
                if (b % 4 === 0) playDrum('ride'); 
                if (b % 4 === 2 || b % 4 === 0) playDrum('snare'); 
                if (b % 8 === 0) playChord('cm11', 4, 0.05);
                if (b % 16 === 4) playSax(SCALES.noir_theme[0], 0.8, 'normal'); 
                if (b % 16 === 5) playSax(SCALES.noir_theme[1], 0.8, 'normal'); 
                if (b % 16 === 6) playSax(SCALES.noir_theme[0], 0.8, 'normal'); 
                if (b % 16 === 7) playSax(SCALES.noir_theme[3], 2.0, 'growl'); 
            }
            else if (musicMode === 1) {
                if (b % 8 === 0) playBass(32.70, 6.0); 
                if (b % 8 === 4) playBass(46.25, 6.0); 
                if (b % 8 === 0) playDrum('ride'); 
                if (b % 8 === 0) playDrum('kick'); 
                if (b % 8 === 1) playDrum('kick'); 
                if (b % 8 === 4) playDrum('snare'); 
                if (b % 8 === 0) playChord('doom_cluster', 8, 0.3); 
                if (b % 16 === 0) playSax(SCALES.mystery_dim[0], 2.5, 'growl'); 
                if (b % 16 === 4) playSax(SCALES.mystery_dim[1], 3.0, 'growl'); 
            }
            else if (musicMode === 2) {
                if (b % 4 === 0) playBass(43.65, 2.0); 
                if (b % 4 === 2) playBass(43.65, 2.0); 
                if (b % 8 === 0) playDrum('ride'); 
                if (b % 8 === 0) playChord('f_maj', 4, 0.1); 
                if (b % 8 === 4) playChord('f_min', 4, 0.1);
            }
            else if (musicMode === 3) {
                const loop = 420;
                const lb = b % loop; 
                if (lb < 380) { 
                    if (lb % 2 === 0 || (lb % 4 === 3 && Math.random() > 0.4)) playDrum('ride');
                }
                if (lb > 32 && lb < 224) { 
                    if (lb % 4 === 0) playDrum('kick');
                    if (lb % 8 === 6) playDrum('snare');
                } else if (lb >= 224 && lb < 320) { 
                     if (lb % 2 === 0) playDrum('kick');
                     if (Math.random() > 0.6) playDrum('snare');
                } else if (lb >= 320 && lb < 380) { 
                     if (lb % 4 === 0) playDrum('kick');
                }
                if (lb < 32) { 
                    if (lb % 8 === 0) playBass(49.00, 1.5); 
                } 
                else if (lb < 160) { 
                    const walk = [49.00, 58.27, 65.41, 73.42]; 
                    if (lb % 2 === 0) playBass(walk[(lb/2)%4], 0.8);
                } 
                else if (lb < 288) { 
                    if (lb % 2 === 0) playBass(Math.random() > 0.5 ? 46.25 : 49.00, 0.6); 
                } 
                else { 
                    if (lb % 8 === 0) playBass(49.00, 3.0);
                }
                if (lb > 16 && lb < 360) {
                    if (lb % 32 === 0) playChord('taxi_stab', 0.5, 0.0); 
                    if (lb % 32 === 16) playChord('cm11', 0.6, 0.05); 
                    if (lb > 128 && lb < 256 && lb % 16 === 12) {
                        playChord(Math.random() > 0.5 ? 'eb_maj7' : 'd7alt', 0.4, 0.02);
                    }
                }
                if (lb >= 32 && lb < 96) {
                    if (lb % 16 === 0) playSax(SCALES.urban_penta[0], 2.0, 'normal');
                    if (lb % 16 === 4) playSax(SCALES.urban_penta[2], 1.5, 'normal');
                    if (lb % 16 === 14) playSax(SCALES.urban_penta[1], 1.0, 'normal');
                }
                else if (lb >= 96 && lb < 192) {
                    if (lb % 8 === 0 && Math.random() > 0.3) playSax(SCALES.taxi_extended[4], 1.2, 'normal'); 
                    if (lb % 16 === 10) playSax(SCALES.taxi_extended[6], 1.5, 'growl'); 
                    if (lb % 32 === 30) playSax(SCALES.taxi_extended[3], 0.5, 'normal');
                }
                else if (lb >= 192 && lb < 288) {
                    if (lb % 4 === 0 && Math.random() > 0.4) {
                        const randomNote = SCALES.taxi_extended[Math.floor(Math.random() * SCALES.taxi_extended.length)];
                        playSax(randomNote * 2, 0.3, 'growl'); 
                    }
                }
                else if (lb >= 288 && lb < 360) {
                    if (lb % 16 === 0) playSax(SCALES.urban_penta[0], 2.5, 'normal');
                    if (lb % 16 === 8) playSax(SCALES.urban_penta[3], 1.5, 'normal');
                }
            }
        }

        const CACHE_NAME = 'bio-breach-audio-v1';
        let currentMosaicMode = parseInt(localStorage.getItem('bioBreachMosaic')) || 5; 
        let tempMosaicMode = currentMosaicMode; 
        let DP = {}; 

        // --- SISTEMA DE IDENTIDAD ---
        let agentIdentity = { name: null, id: null };

        function checkLoginStatus() {
            const savedData = localStorage.getItem('bioBreachIdentity');
            if (savedData) {
                agentIdentity = JSON.parse(savedData);
                document.getElementById('agent-display').innerText = `AGENTE: ${agentIdentity.name} [${agentIdentity.id}]`;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-menu').style.display = 'flex';
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-menu').style.display = 'none';
            }
        }

        function registerAgent() {
            const nameInput = document.getElementById('agent-name-input').value.trim().toUpperCase();
            if (nameInput.length < 3) {
                alert("NOMBRE DEMASIADO CORTO");
                return;
            }
            playSFX('click');
            // Generar ID único
            const uniqueId = Math.random().toString(36).substr(2, 9).toUpperCase();
            agentIdentity = { name: nameInput, id: uniqueId };
            localStorage.setItem('bioBreachIdentity', JSON.stringify(agentIdentity));
            checkLoginStatus();
        }

        // --- MANEJO DE ARCHIVOS Y MURO ---
        function openArchives() {
            playSFX('click');
            renderWall();
            fadeToMode(0); 
            document.getElementById('archives-screen').style.display = 'flex';
            document.getElementById('main-menu').style.display = 'none';
        }

        function closeArchives() {
            playSFX('click');
            fadeToMode(1); 
            document.getElementById('archives-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function renderWall() {
            const container = document.getElementById('wall-container');
            const solvedList = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
            container.innerHTML = '';

            if (solvedList.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:1.2rem; margin-top:50px;">NO HAY REGISTROS. ATRAPE CRIMINALES PRIMERO.</div>';
                return;
            }

            solvedList.forEach(data => {
                const rotation = (Math.random() * 10) - 5; 
                const card = document.createElement('div');
                card.className = 'wall-card';
                card.style.transform = `rotate(${rotation}deg)`;
                
                let pinClass = "";
                const pts = data.points || 0;
                if(pts >= 25) pinClass = "gold";
                else if(pts >= 15) pinClass = "blue";
                
                card.innerHTML = `
                    <div class="pin ${pinClass}"></div>
                    <div class="mugshot-zone"><span class="mugshot-icon">?</span></div>
                    <div class="wall-info">
                        <b>EXPEDIENTE:</b> ${data.recordId}<br>
                        <b>NOMBRE:</b> ${data.n}<br>
                        <b>EDAD:</b> ${data.edad} AÑOS<br>
                        <b>ORIGEN:</b> ${data.p}<br>
                        <b>TEZ:</b> ${data.t}<br>
                        <b>OJOS:</b> ${data.o}<br>
                        <b>ACCESORIO:</b> ${data.accName}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'flex';
            selectMosaic(currentMosaicMode); 
        }

        function selectMosaic(mode) {
            playSFX('click');
            tempMosaicMode = mode;
            document.querySelectorAll('.mosaic-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-mode-${mode}`).classList.add('active');
            
            const desc = document.getElementById('mosaic-desc');
            if (mode === 5) desc.innerText = "ESTÁNDAR: Vista completa, sin deslizamiento.";
            else desc.innerText = "ZOOM TÁCTICO: Tarjetas ampliadas, deslizamiento activo.";
        }

        function saveSettings() {
            playSFX('click');
            document.getElementById('settings-modal').style.display = 'none';
            if (tempMosaicMode !== currentMosaicMode) {
                applyMosaicChange(tempMosaicMode);
            }
        }

        function applyMosaicChange(newMode) {
            const loading = document.getElementById('loading-screen');
            const bar = document.getElementById('loader-progress');
            loading.style.display = 'flex';
            bar.style.width = "0%";
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if(progress > 100) progress = 100;
                bar.style.width = progress + "%";
                if(progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        currentMosaicMode = newMode;
                        localStorage.setItem('bioBreachMosaic', newMode);
                        updateBoardClass();
                        loading.style.display = 'none';
                        if(gameActive) renderBoard(); 
                    }, 500);
                }
            }, 100);
        }

        function updateBoardClass() {
            const board = document.getElementById('board');
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);
        }
        
        async function preloadAssets() {
            const statusEl = document.getElementById('preload-status');
            if (!('caches' in window)) {
                statusEl.innerText = "SISTEMA: CACHÉ NO SOPORTADA";
                return;
            }
            try {
                const cache = await caches.open(CACHE_NAME);
                const urlsToCache = Object.values(AUDIO_CONFIG).map(cfg => cfg.src);
                for (const url of urlsToCache) {
                    const response = await cache.match(url);
                    if (!response) {
                        statusEl.innerText = "DESCARGANDO ACTIVOS...";
                        await cache.add(url);
                    }
                }
                statusEl.innerText = "SISTEMA: LISTO";
            } catch (e) {
                statusEl.innerText = "SISTEMA: ERROR DE CONEXIÓN";
            }
        }

        // --- MIGRACIÓN ---
        function checkMigration() {
            if (!localStorage.getItem('bioBreach_v8_migration')) {
                // ... lógica de migración si fuera necesaria (resetear puntos etc)
                localStorage.setItem('bioBreach_v8_migration', 'true');
            }
        }
        function closeMigrationModal() {
            playSFX('click');
            document.getElementById('migration-modal').style.display = 'none';
        }

        window.addEventListener('load', () => {
            preloadAssets();
            updateBoardClass();
            checkMigration(); 
        });

        const AUDIO_CONFIG = {
            paper: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 0.6 },
            fail: { src: 'https://assets.mixkit.co/active_storage/sfx/2805/2805-preview.mp3', vol: 0.4 }, 
            error: { src: 'https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3', vol: 0.5 }, 
            win: { src: 'https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3', vol: 0.5 },
            click: { src: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3', vol: 0.4 },
            type: { src: 'https://assets.mixkit.co/active_storage/sfx/2544/2544-preview.mp3', vol: 0.015 },
            newCase: { src: 'https://assets.mixkit.co/active_storage/sfx/2047/2047-preview.mp3', vol: 1 },
            discard: { src: 'https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3', vol: 0.1 }
        };

        const SFX_CACHE = {};
        let activeSounds = [];

        Object.keys(AUDIO_CONFIG).forEach(key => {
            const audio = new Audio(AUDIO_CONFIG[key].src);
            audio.volume = AUDIO_CONFIG[key].vol;
            audio.crossOrigin = "anonymous";
            SFX_CACHE[key] = audio;
        });

        async function playSFX(key, interrupt = false) {
            if (!SFX_CACHE[key]) return;
            
            if (interrupt || key === 'error' || key === 'fail' || key === 'win') {
                activeSounds.forEach(s => {
                    s.pause();
                    s.currentTime = 0;
                });
                activeSounds = [];
            }

            const sound = SFX_CACHE[key].cloneNode();
            sound.volume = AUDIO_CONFIG[key].vol;
            if (key === 'discard') { sound.currentTime = 0.05; }
            activeSounds.push(sound);
            sound.onended = () => {
                activeSounds = activeSounds.filter(s => s !== sound);
            };
            try { await sound.play(); } catch (e) { console.log("Audio trigger"); }
        }

        let personas = [], objetivo = null, gameActive = false;
        let currentReward = 0;
        let totalMoney = parseInt(localStorage.getItem('bioBreachMoney')) || 0;
        let isTyping = false;
        let pendingDiscards = []; 
        let lastQueryText = "";   
        let matchPoints = 0; 
        let pointsPool = 0;
        
        // VARIABLES MODO COMPETITIVO
        let isCompetitive = false;
        let peer = null;
        let conn = null; // Conexión activa
        let myPeerId = null;
        let currentRoomCode = null;
        let isHost = false;
        let connectedPlayers = []; // Lista de objetos {peerId, name, score}
        let compRound = 0;
        let maxRounds = 3;

        async function typeWriter(text, elementId, speed = 20) {
            if (isTyping) return;
            isTyping = true;
            const element = document.getElementById(elementId);
            element.innerHTML = "> ";
            let currentHTML = "> ";
            const parts = text.split(/(<[^>]*>)/g);
            for (const part of parts) {
                if (part.startsWith('<')) {
                    currentHTML += part;
                    element.innerHTML = currentHTML;
                } else {
                    for (const char of part) {
                        currentHTML += char;
                        element.innerHTML = currentHTML;
                        if (char !== " " && char !== "\n") playSFX('type');
                        await new Promise(resolve => setTimeout(resolve, speed));
                    }
                }
            }
            isTyping = false;
        }

        function updateWalletUI() {
            document.getElementById('total-money').innerText = totalMoney.toLocaleString();
            localStorage.setItem('bioBreachMoney', totalMoney);
        }

        // --- LOGICA DE SELECCIÓN DE MODO ---
        function openModeSelection() {
            playSFX('click');
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'flex';
        }

        function closeModeSelection() {
            playSFX('click');
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function startClassicMode() {
            isCompetitive = false;
            document.getElementById('new-case-btn').style.display = 'inline-block';
            document.getElementById('manual-subtitle').innerText = "(ESTÁNDAR)";
            document.getElementById('manual-step-3').innerHTML = `<b>3. SISTEMA DE PUNTOS</b>Eliminar múltiples sospechosos con una sola pregunta otorga puntos extra.`;
            document.getElementById('manual-step-4').innerHTML = `<b>4. OBJETIVO ÚNICO</b>La misión termina cuando descubres al culpable. Si lo descartas por error, pierdes el contrato.`;
            showTutorial();
        }

        function showTutorial() {
            playSFX('click');
            fadeToMode(2); 
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('tutorial-screen').style.display = 'flex';
        }

        // --- LOGICA ONLINE / COMPETITIVA ---
        function openLobby() {
            playSFX('click');
            isCompetitive = true;
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
            document.getElementById('lobby-start').style.display = 'block';
            document.getElementById('lobby-active').style.display = 'none';
        }

        function closeLobby() {
            playSFX('click');
            if (peer) { peer.destroy(); peer = null; }
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'flex';
        }

        function leaveLobby() {
             playSFX('click');
             if(peer) { peer.destroy(); peer = null; }
             connectedPlayers = [];
             document.getElementById('lobby-start').style.display = 'block';
             document.getElementById('lobby-active').style.display = 'none';
        }

        function initPeer() {
            return new Promise((resolve, reject) => {
                peer = new Peer(null, { debug: 2 });
                peer.on('open', (id) => {
                    myPeerId = id;
                    resolve(id);
                });
                peer.on('error', (err) => {
                    console.error(err);
                    alert("ERROR DE CONEXIÓN AL SERVIDOR P2P");
                });
            });
        }

        async function hostRoom() {
            playSFX('click');
            document.getElementById('lobby-start').style.display = 'none';
            document.getElementById('lobby-active').style.display = 'block';
            document.getElementById('host-controls').style.display = 'block';
            document.getElementById('client-msg').style.display = 'none';
            
            isHost = true;
            // Generar código de sala de 4 dígitos
            currentRoomCode = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('display-room-code').innerText = currentRoomCode;

            // En un sistema P2P real sin servidor de señalización custom, usualmente la ID es larga.
            // Para simular salas de 4 dígitos con PeerJS sin servidor propio, hacemos un truco:
            // Usamos una convención de nombres si fuera posible, pero PeerJS asigna randoms.
            // SOLUCIÓN SIMPLE: El Host crea un Peer. Cuando los clientes se unan, usaremos el ID largo.
            // PERO el usuario pide 4 dígitos. PeerJS permite alias.
            // Intentaremos crear un Peer con ID: "biobreach-room-" + code
            
            if(peer) peer.destroy();
            
            peer = new Peer("biobreach-room-" + currentRoomCode);
            
            peer.on('open', (id) => {
                addPlayerToLobby(agentIdentity.name, id, true); // Añadirme a mí
                
                peer.on('connection', (conn) => {
                    // Nuevo jugador conectado
                    conn.on('data', (data) => {
                        handleHostData(data, conn);
                    });
                });
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    // Si colisiona el código (muy raro), intentar de nuevo
                    hostRoom(); 
                } else {
                    alert("ERROR AL CREAR SALA. INTENTE OTRA VEZ.");
                    leaveLobby();
                }
            });
        }

        function joinRoom() {
            playSFX('click');
            const code = document.getElementById('room-code-input').value.trim();
            if(code.length !== 4) { alert("CÓDIGO INVÁLIDO"); return; }
            
            isHost = false;
            document.getElementById('lobby-start').style.display = 'none';
            document.getElementById('lobby-active').style.display = 'block';
            document.getElementById('host-controls').style.display = 'none';
            document.getElementById('client-msg').style.display = 'block';
            document.getElementById('display-room-code').innerText = code;
            
            if(peer) peer.destroy();
            peer = new Peer(); // ID aleatorio para cliente
            
            peer.on('open', (id) => {
                myPeerId = id;
                const hostId = "biobreach-room-" + code;
                conn = peer.connect(hostId);
                
                conn.on('open', () => {
                    // Enviar mi info al host
                    conn.send({ type: 'JOIN', name: agentIdentity.name, peerId: id });
                });
                
                conn.on('data', (data) => {
                    handleClientData(data);
                });
                
                conn.on('error', (err) => {
                    alert("NO SE ENCONTRÓ LA SALA");
                    leaveLobby();
                });
            });
        }

        // --- LÓGICA DE HOST (SERVIDOR) ---
        function handleHostData(data, connection) {
            if (data.type === 'JOIN') {
                const newPlayer = { peerId: data.peerId, name: data.name, score: 0, conn: connection, finished: false };
                // Evitar duplicados
                if (!connectedPlayers.some(p => p.peerId === data.peerId)) {
                    connectedPlayers.push(newPlayer);
                    broadcastLobbyUpdate();
                }
            }
            else if (data.type === 'FINISHED_ROUND') {
                const player = connectedPlayers.find(p => p.peerId === data.peerId);
                if (player && !player.finished) {
                    player.finished = true;
                    // Calcular puntos basados en orden de llegada
                    const finishedCount = connectedPlayers.filter(p => p.finished).length;
                    let roundPoints = 0;
                    if (finishedCount === 1) roundPoints = 10;
                    else if (finishedCount === 2) roundPoints = 8;
                    else if (finishedCount === 3) roundPoints = 6;
                    else roundPoints = 4;
                    
                    player.score += roundPoints;
                    
                    // Notificar a todos que alguien terminó
                    broadcast({ type: 'PLAYER_FINISHED', name: player.name });
                    
                    // Verificar si todos terminaron
                    if (connectedPlayers.every(p => p.finished)) {
                        setTimeout(() => endCompRound(), 2000);
                    }
                }
            }
        }

        function addPlayerToLobby(name, id, isMe) {
            if (isHost && isMe) {
                connectedPlayers = [{ peerId: 'HOST', name: name, score: 0, finished: false }];
            }
            updateLobbyUI();
        }

        function broadcastLobbyUpdate() {
            // Enviar lista limpia (sin objetos de conexión)
            const cleanList = connectedPlayers.map(p => ({ name: p.name, score: p.score, isHost: p.peerId === 'HOST' }));
            broadcast({ type: 'LOBBY_UPDATE', players: cleanList });
            updateLobbyUI(); // Actualizar mi propia UI
        }
        
        function broadcast(msg) {
            connectedPlayers.forEach(p => {
                if (p.conn) p.conn.send(msg);
            });
        }

        function updateLobbyUI() {
            const list = document.getElementById('player-list-container');
            list.innerHTML = '';
            connectedPlayers.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item ready';
                div.innerHTML = `<span>${p.name}</span><span>${p.score} PTS</span>`;
                list.appendChild(div);
            });
            
            if (isHost) {
                const btn = document.getElementById('btn-start-comp');
                // REGLA: MÍNIMO 2 JUGADORES
                if (connectedPlayers.length >= 2) {
                    btn.disabled = false;
                    btn.innerText = "INICIAR COMPETENCIA";
                    btn.style.borderColor = "var(--victory)";
                } else {
                    btn.disabled = true;
                    btn.innerText = "INICIAR COMPETENCIA (MIN 2)";
                    btn.style.borderColor = "#444";
                }
            }
        }

        function requestStartGame() {
            if (!isHost) return;
            compRound = 1;
            connectedPlayers.forEach(p => { p.score = 0; p.finished = false; }); // Reset total score
            startCompRound();
        }

        function startCompRound() {
            connectedPlayers.forEach(p => p.finished = false);
            broadcast({ type: 'START_ROUND', round: compRound });
            // Host logic para iniciar su propio juego
            startLocalCompGame();
        }

        function endCompRound() {
            const results = connectedPlayers.map(p => ({ name: p.name, score: p.score })).sort((a,b) => b.score - a.score);
            broadcast({ type: 'ROUND_RESULTS', results: results, round: compRound, totalRounds: maxRounds });
            
            // Mostrar resultados al host
            showCompResults(results, compRound, maxRounds);
            
            if (compRound < maxRounds) {
                compRound++;
                setTimeout(() => {
                    startCompRound();
                }, 5000); // 5 segs para ver resultados
            } else {
                // Fin del juego
                setTimeout(() => {
                     document.getElementById('btn-return-lobby').style.display = 'inline-block';
                     broadcast({ type: 'GAME_OVER' });
                }, 1000);
            }
        }

        // --- LÓGICA DE CLIENTE ---
        function handleClientData(data) {
            if (data.type === 'LOBBY_UPDATE') {
                const list = document.getElementById('player-list-container');
                list.innerHTML = '';
                data.players.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'player-item ready';
                    div.innerHTML = `<span>${p.name}</span><span>${p.score} PTS</span>`;
                    list.appendChild(div);
                });
            }
            else if (data.type === 'START_ROUND') {
                startLocalCompGame();
            }
            else if (data.type === 'ROUND_RESULTS') {
                showCompResults(data.results, data.round, data.totalRounds);
            }
            else if (data.type === 'GAME_OVER') {
                 document.getElementById('btn-return-lobby').style.display = 'inline-block';
            }
        }

        function startLocalCompGame() {
            // Modificar Manual para Competitivo
            document.getElementById('manual-subtitle').innerText = "(COMPETITIVO)";
            document.getElementById('manual-step-3').innerHTML = `<b>3. VELOCIDAD CRÍTICA</b>El primer agente en resolver el caso gana 10 PTS. El segundo 8, etc.<br>El puntaje de tarjetas no cuenta, solo la velocidad.`;
            document.getElementById('manual-step-4').innerHTML = `<b>4. 3 RONDAS</b>Se jugarán 3 rondas consecutivas. Acumula el mayor puntaje para ganar.`;
            document.getElementById('new-case-btn').style.display = 'none'; // Desactivar botón nuevo caso manual
            
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('comp-results-screen').style.display = 'none';
            
            showTutorial(); // Esto lleva a startGame() -> initGame()
        }

        function showCompResults(results, round, total) {
            gameActive = false;
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('overlay').classList.remove('active'); // Quitar overlay de victoria si estaba
            document.getElementById('comp-results-screen').style.display = 'flex';
            
            let html = `<h3>RONDA ${round} / ${total}</h3>`;
            html += `<table style="width:100%; color:#aaa; font-size:0.9rem;">`;
            results.forEach((r, idx) => {
                const color = idx === 0 ? "var(--gold)" : "#eee";
                html += `<tr><td style="color:${color}; padding:5px;">#${idx+1} ${r.name}</td><td style="text-align:right; color:${color}">${r.score} PTS</td></tr>`;
            });
            html += `</table>`;
            document.getElementById('comp-results-list').innerHTML = html;
            
            if (round < total) {
                let timeLeft = 5;
                const timerEl = document.getElementById('next-round-timer');
                document.getElementById('btn-return-lobby').style.display = 'none';
                timerEl.innerText = `SIGUIENTE RONDA EN ${timeLeft}...`;
                const t = setInterval(() => {
                    timeLeft--;
                    timerEl.innerText = `SIGUIENTE RONDA EN ${timeLeft}...`;
                    if(timeLeft <= 0) clearInterval(t);
                }, 1000);
            } else {
                document.getElementById('next-round-timer').innerText = "TORNEO FINALIZADO";
            }
        }

        function returnToLobbyFromGame() {
            document.getElementById('comp-results-screen').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
        }

        function exitGame() {
            playSFX('click');
            fadeToMode(1); 
            alert("SISTEMA DESCONECTADO DEL NÚCLEO.");
        }

        function startGame() {
            playSFX('click');
            fadeToMode(3); 
            document.getElementById('tutorial-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex'; 
            initGame();
        }

        function openAbortModal() {
            if (!gameActive) return;
            playSFX('click');
            document.getElementById('penalty-amount').innerText = currentReward;
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('abort-confirm').classList.add('active');
        }

        function closeAbortModal() {
            playSFX('click');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('abort-confirm').classList.remove('active');
        }

        function confirmAbort() {
            playSFX('click', true); 
            gameActive = false;
            closeAbortModal();
            if (isCompetitive) {
                // En competitivo abortar es rendirse en la ronda
                alert("ABANDONO REGISTRADO. 0 PUNTOS.");
                reportWinToHost(false); // Reportar como terminado (aunque fallido)
            } else {
                fadeToMode(1); 
                document.getElementById('main-ui').style.display = 'none';
                document.getElementById('main-menu').style.display = 'flex';
            }
        }

        function generateCriminalRecordID() {
            let usedIDs = JSON.parse(localStorage.getItem('bioBreachUsedIDs')) || [];
            let newId;
            let unique = false;
            let attempts = 0;
            while (!unique && attempts < 500) {
                newId = "C-" + Math.floor(Math.random() * 8999 + 1000); 
                if (!usedIDs.includes(newId)) {
                    unique = true;
                }
                attempts++;
            }
            if (!unique) {
                usedIDs = [];
                newId = "C-" + Math.floor(Math.random() * 8999 + 1000);
            }
            usedIDs.push(newId);
            if (usedIDs.length > 5000) usedIDs.shift(); 
            localStorage.setItem('bioBreachUsedIDs', JSON.stringify(usedIDs));
            return newId;
        }

        function isCriminalCaptured(suspect) {
            const captured = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
            return captured.some(c => 
                c.n === suspect.n && 
                c.p === suspect.p && 
                c.t === suspect.t && 
                c.o === suspect.o && 
                c.accName === suspect.accName
            );
        }

        function initGame() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('main-ui').classList.remove('blur-effect');
            document.getElementById('out').style.color = "var(--terminal-green)";
            
            restoreMusic();
            playSFX('newCase', true);
            
            currentReward = Math.floor(Math.random() * 500) + 100;
            matchPoints = 0;
            pointsPool = 0;
            document.getElementById('game-points').innerText = "PTS: " + matchPoints;

            document.getElementById('case-id-display').innerText = `CASO #${Math.floor(Math.random() * 9000) + 1000}`;
            document.getElementById('case-reward-display').innerText = currentReward;
            
            pendingDiscards = []; 
            lastQueryText = "";
            document.getElementById('queryInput').disabled = false;
            document.getElementById('queryInput').placeholder = "INTERROGAR SISTEMA (¿...?)...";
            document.getElementById('queryInput').value = "";

            let attempts = 0;
            let validCase = false;
            
            while (!validCase && attempts < 100) {
                generateNewSquad(); 
                const candidate = personas[Math.floor(Math.random() * personas.length)];
                
                if (!isCriminalCaptured(candidate)) {
                    objetivo = candidate;
                    validCase = true;
                } else {
                    attempts++;
                }
            }
            
            if (!validCase) {
                objetivo = personas[Math.floor(Math.random() * personas.length)];
            }

            objetivo.recordId = generateCriminalRecordID();
            gameActive = true;
            typeWriter("ESCANEO FINALIZADO. ESPERANDO CONSULTA...", "out", 15);
            renderBoard();
            updateWalletUI();
        }

        function generateNewSquad() {
            personas = [];
            DP = {
                M: ["LEON", "MARC", "OTTO", "IVAN", "ERIC", "HUAN", "KURT", "NOAH", "AXEL", "SAUL", "IGOR", "LIAM", "ENZO", "HUGO", "OMAR", "LUC", "YURI", "RYAN", "FINN", "EZRA", "MILO", "IAN", "ALAN", "KAI", "BORIS", "OSCAR", "VICTOR", "FELIX"],
                F: ["MIA", "LARA", "YUNA", "OLGA", "ADRI", "ZOE", "INÉS", "KIRA", "EMMA", "RUTH", "SARA", "LUNA", "VERA", "NORA", "MAYA", "LEA", "IRIS", "ALBA", "GALA", "JUNE", "CLAUDIA", "ANA", "EVA", "LISA", "NINA", "JADE", "ROSE"],
                P: [{n: "ALEMANIA", c: "EUROPA"}, {n: "ESPAÑA", c: "EUROPA"}, {n: "ITALIA", c: "EUROPA"}, {n: "FRANCIA", c: "EUROPA"}, {n: "JAPÓN", c: "ASIA"}, {n: "CHINA", c: "ASIA"}, {n: "MÉXICO", c: "AMÉRICA"}, {n: "BRASIL", c: "AMÉRICA"}, {n: "USA", c: "AMÉRICA"}, {n: "EGIPTO", c: "ÁFRICA"}],
                T: ["PÁLIDA", "OLIVA", "BRONCE", "OSCURA", "ÉBANO"],
                O: ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"],
                A: [{n: "GORRA", u: "CABEZA"}, {n: "CASCO", u: "CABEZA"}, {n: "GAFAS", u: "OJOS"}, {n: "PARCHE", u: "OJOS"}, {n: "MALETÍN", u: "MANO"}, {n: "RELOJ", u: "MANO"}]
            };

            const shuffle = (array) => array.sort(() => Math.random() - 0.5);
            const poolM = shuffle([...new Set(DP.M)]);
            const poolF = shuffle([...new Set(DP.F)]);

            for (let i = 0; i < 25; i++) {
                const genero = Math.random() > 0.5 ? "MASCULINO" : "FEMENINO";
                const pais = DP.P[Math.floor(Math.random() * DP.P.length)];
                const acc = DP.A[Math.floor(Math.random() * DP.A.length)];
                let nombre = genero === "MASCULINO" ? (poolM.pop() || "UNIT-M"+i) : (poolF.pop() || "UNIT-F"+i);

                personas.push({
                    n: nombre, g: genero, p: pais.n, cont: pais.c,
                    t: DP.T[Math.floor(Math.random() * DP.T.length)], o: DP.O[Math.floor(Math.random() * DP.O.length)],
                    edad: Math.floor(Math.random() * 50) + 18, altura: (Math.random() * 0.5 + 1.5).toFixed(2),
                    accName: acc.n, accUbi: acc.u
                });
            }
        }

        function spawnFloatingPoint(startX, startY, val) {
            if (val <= 0) return;
            const el = document.createElement('div');
            el.className = 'flying-point';
            el.innerText = `+${val}`;
            el.style.left = startX + 'px';
            el.style.top = startY + 'px';
            document.body.appendChild(el);
            const target = document.getElementById('game-points').getBoundingClientRect();
            const destX = target.left + (target.width / 2);
            const destY = target.top + (target.height / 2);
            requestAnimationFrame(() => {
                el.style.transform = `translate(${destX - startX}px, ${destY - startY}px) scale(0.5)`;
                el.style.opacity = '0';
            });
            setTimeout(() => {
                el.remove();
                matchPoints += val;
                document.getElementById('game-points').innerText = "PTS: " + matchPoints;
                document.getElementById('game-points').classList.add('point-impact');
                setTimeout(() => document.getElementById('game-points').classList.remove('point-impact'), 300);
            }, 800);
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            board.className = 'board-grid'; 
            board.classList.add(`mode-${currentMosaicMode}`);

            personas.forEach(p => {
                const card = document.createElement('div');
                card.className = 'suspect-card';
                card.id = `card-${p.n}`;
                card.onclick = () => { 
                    if(gameActive) { 
                        const cardEl = document.getElementById(`card-${p.n}`);
                        if(cardEl.classList.contains('discarded')) return;

                        if (pendingDiscards.length > 0) {
                            playSFX('discard');
                            const rect = cardEl.getBoundingClientRect();
                            const centerX = rect.left + rect.width / 2;
                            const centerY = rect.top + rect.height / 2;
                            let ptsToGive = 0;
                            if (pointsPool > 0) {
                                const remainingDiscards = pendingDiscards.length; 
                                ptsToGive = Math.ceil(pointsPool / remainingDiscards);
                                if (ptsToGive > pointsPool) ptsToGive = pointsPool;
                                pointsPool -= ptsToGive;
                            }
                            let winDelay = 0;
                            if (ptsToGive > 0) {
                                spawnFloatingPoint(centerX, centerY, ptsToGive);
                                winDelay = 900; 
                            }
                            discardVisual(cardEl);
                            if (pendingDiscards.includes(p.n)) {
                                pendingDiscards = pendingDiscards.filter(id => id !== p.n);
                            }
                            if (p.n === objetivo.n) {
                                checkStatus(0); 
                                return;
                            }
                            if (pendingDiscards.length > 0) {
                                document.getElementById('out').innerHTML = `> ${lastQueryText}<br><span style="color:var(--hazard)">OBJETIVOS RESTANTES: ${pendingDiscards.length}</span>`;
                            } else {
                                playSFX('click'); 
                                document.getElementById('out').innerHTML = `> ${lastQueryText}<br><span style="color:var(--terminal-green)">DESCARTE COMPLETADO. SISTEMA HABILITADO.</span>`;
                                document.getElementById('queryInput').disabled = false;
                                document.getElementById('queryInput').placeholder = "INTERROGAR SISTEMA (¿...?)...";
                                document.getElementById('queryInput').focus();
                            }
                            checkStatus(winDelay);
                        } 
                        else if (lastQueryText !== "") {
                            playSFX('discard');
                            discardVisual(cardEl);
                            if (p.n === objetivo.n) { checkStatus(0); return; }
                            checkStatus(0);
                        }
                        else {
                            playSFX('error');
                            document.getElementById('out').style.color = "var(--hazard)";
                            typeWriter("ERROR: REALICE UNA CONSULTA PARA IDENTIFICAR OBJETIVOS.", "out", 10);
                        }
                    } 
                };
                const rib = p.g === "MASCULINO" ? "ribbon-male" : "ribbon-female";
                card.innerHTML = `<div class="gender-ribbon ${rib}"></div><div class="card-header">${p.n}</div><div class="card-body"><b>ORG:</b> ${p.p}<br><b>TEZ:</b> ${p.t}<br><b>OJO:</b> ${p.o}<br><b>EDA:</b> ${p.edad}<br><b>ALT:</b> ${p.altura}M<br><b>ACC:</b> ${p.accName}</div>`;
                board.appendChild(card);
            });
        }

        function discardVisual(card) {
            card.classList.add('discarded');
        }

        function checkStatus(delay = 0) {
            const activeCards = Array.from(document.querySelectorAll('.suspect-card')).filter(c => !c.classList.contains('discarded'));
            if (document.getElementById(`card-${objetivo.n}`).classList.contains('discarded')) {
                return endGame(false);
            }
            if (activeCards.length === 1 && activeCards[0].id === `card-${objetivo.n}`) {
                setTimeout(() => { endGame(true); }, delay);
                return;
            }
        }

        function reportWinToHost(win) {
            // Lógica para modo competitivo
            if (isHost) {
                // Si soy el Host y termino
                const me = connectedPlayers.find(p => p.peerId === 'HOST');
                if(me && !me.finished) {
                    me.finished = true;
                    // Auto-mensaje de host
                    handleHostData({ type: 'FINISHED_ROUND', peerId: 'HOST' });
                }
            } else {
                // Si soy cliente
                if(conn) conn.send({ type: 'FINISHED_ROUND', peerId: myPeerId });
            }
            
            // Mostrar pantalla de espera local
            gameActive = false;
            document.getElementById('main-ui').style.display = 'none';
            // Crear overlay de espera simple
            const overlay = document.getElementById('overlay');
            overlay.innerHTML = `<h1 style="color:var(--gold)">OBJETIVO PROCESADO</h1><p>SINCRONIZANDO CON RED...</p>`;
            overlay.classList.add('active');
        }

        function endGame(win) {
            if (isCompetitive && win) {
                reportWinToHost(true);
                return;
            } else if (isCompetitive && !win) {
                // En competitivo, perder es fatal para la ronda. Reportar como terminado pero sin puntos extra (se maneja en servidor).
                alert("OBJETIVO PERDIDO. ESPERANDO FIN DE RONDA.");
                reportWinToHost(false);
                return;
            }

            gameActive = false;
            silenceMusic();
            document.getElementById('main-ui').classList.add('blur-effect');
            document.getElementById('overlay').classList.add('active');
            const rewardMsg = document.getElementById('overlay-reward-msg');
            const desc = document.getElementById('overlay-desc');
            
            if (win) { 
                playSFX('win', true); 
                const pointBonus = matchPoints * 10;
                totalMoney += currentReward + pointBonus;
                objetivo.points = matchPoints; 
                const solvedList = JSON.parse(localStorage.getItem('bioBreachSolved') || '[]');
                solvedList.push(objetivo);
                localStorage.setItem('bioBreachSolved', JSON.stringify(solvedList));
                document.getElementById('overlay-title').innerText = "OBJETIVO LOCALIZADO"; 
                document.getElementById('overlay-title').style.color = "var(--victory)";
                rewardMsg.innerHTML = `+${currentReward} S/ CONTRATO<br><span style="color:var(--gold)">+${pointBonus} S/ BONUS (${matchPoints} PTS)</span>`;
                desc.innerHTML = `<div class="dossier-container"><div class="dossier-header"><span>REGISTRO CRIMINAL</span><span>[${objetivo.recordId}]</span></div><div class="dossier-info"><p><b>SUJETO:</b> ${objetivo.n}</p><div class="stamp-captured">CAPTURED</div></div></div>`;
            } else { 
                playSFX('fail', true);
                document.getElementById('overlay-title').innerText = "OBJETIVO PERDIDO"; 
                document.getElementById('overlay-title').style.color = "var(--hazard)";
                rewardMsg.innerText = "CONTRATO CANCELADO";
                desc.innerHTML = `<div class="dossier-container" style="border-color: var(--hazard); background: rgba(50, 0, 0, 0.3);"><div class="dossier-header" style="border-color: var(--hazard); color: var(--hazard);"><span>REGISTRO CRIMINAL</span><span>[${objetivo.recordId}]</span></div><div class="dossier-info"><p><b>SUJETO:</b> ${objetivo.n}</p><div class="stamp-captured" style="color: var(--hazard); border-color: var(--hazard);">ESCAPED</div></div></div>`;
            }
            updateWalletUI();
        }

        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isTyping) {
                let rawValue = this.value.trim();
                if (!rawValue.startsWith('¿') || !rawValue.endsWith('?')) {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter("ERROR: SINTAXIS INVÁLIDA. FORMULE UNA PREGUNTA (¿...?)", "out", 10);
                    return;
                }
                const q = rawValue.toUpperCase();
                this.value = '';
                let checkFunc = null; 
                let validQuery = false;
                const hasWord = (word) => new RegExp("(?:^|[\\s¿])" + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + "(?:$|[\\s?.,])").test(q);
                
                if (hasWord("ACCESORIO") || hasWord("OBJETO")) {
                    validQuery = true;
                    if (hasWord("CABEZA") || hasWord("PELO")) checkFunc = p => p.accUbi === "CABEZA";
                    else if (hasWord("OJOS") || hasWord("CARA")) checkFunc = p => p.accUbi === "OJOS";
                    else if (hasWord("MANO") || hasWord("BRAZO")) checkFunc = p => p.accUbi === "MANO";
                    else {
                        const accList = ["GORRA", "CASCO", "GAFAS", "PARCHE", "MALETÍN", "RELOJ"];
                        const found = accList.find(a => hasWord(a));
                        if(found) checkFunc = p => p.accName === found;
                        else validQuery = false;
                    }
                }
                else if (q.match(/\b(EUROPA|EUROPEO|EUROPEA)\b/)) { checkFunc = p => p.cont === "EUROPA"; validQuery = true; }
                else if (q.match(/\b(ASIA|ASIÁTICO|ASIÁTICA)\b/)) { checkFunc = p => p.cont === "ASIA"; validQuery = true; }
                else if (q.match(/\b(AMÉRICA|AMERICANO|AMERICANA)\b/)) { checkFunc = p => p.cont === "AMÉRICA"; validQuery = true; }
                else if (q.match(/\b(ÁFRICA|AFRICANO|AFRICANA)\b/)) { checkFunc = p => p.cont === "ÁFRICA"; validQuery = true; }
                else if (q.match(/\b(HOMBRE|MASCULINO)\b/)) { checkFunc = p => p.g === "MASCULINO"; validQuery = true; }
                else if (q.match(/\b(MUJER|FEMENINO)\b/)) { checkFunc = p => p.g === "FEMENINO"; validQuery = true; }
                else {
                     // Check simple para paises y colores (versión reducida por tamaño)
                     const countries = DP.P.map(x => x.n);
                     const cFound = countries.find(c => hasWord(c));
                     if(cFound) { checkFunc = p => p.p === cFound; validQuery = true; }
                     else {
                         const colors = ["AZULES", "VERDES", "NEGROS", "CAFÉS", "GRISES", "MIEL"];
                         const colFound = colors.find(c => hasWord(c));
                         if(colFound) { checkFunc = p => p.o === colFound; validQuery = true; }
                     }
                }

                if (validQuery && checkFunc) {
                    playSFX('click');
                    document.getElementById('out').style.color = "var(--terminal-green)";
                    const targetHasTrait = checkFunc(objetivo);
                    const respText = targetHasTrait ? "SÍ." : "NO.";
                    pendingDiscards = personas.filter(p => {
                        const card = document.getElementById('card-' + p.n);
                        if (card.classList.contains('discarded')) return false; 
                        return checkFunc(p) !== targetHasTrait; 
                    }).map(p => p.n);
                    lastQueryText = `CONSULTA: ${q}<br>RESPUESTA: ${respText}`;
                    let earned = 0;
                    let count = pendingDiscards.length;
                    if(count > 0) {
                        if(count >= 5) earned = 8; else if(count >= 3) earned = 5; else earned = count; 
                        pointsPool = earned;
                        lastQueryText += ` <span style="color:var(--gold)">[DETECTADOS: ${earned} PTS]</span>`;
                    }
                    if (pendingDiscards.length > 0) {
                        const msg = `${lastQueryText}<br><span style="color:var(--hazard)">BLOQUEO ACTIVO: ELIMINE A ${pendingDiscards.length} SOSPECHOSOS.</span>`;
                        typeWriter(msg, "out", 15);
                        document.getElementById('queryInput').disabled = true;
                        document.getElementById('queryInput').placeholder = "!! DESCARTE REQUERIDO !!";
                    } else {
                        typeWriter(`${lastQueryText}<br>NINGÚN DESCARTE DISPONIBLE.`, "out", 15);
                    }
                } else {
                    playSFX('error');
                    document.getElementById('out').style.color = "var(--hazard)";
                    typeWriter("DATOS NO RECONOCIDOS O AMBIGUOS.", "out", 10);
                }
            }
        });
    </script>
</body>
</html>